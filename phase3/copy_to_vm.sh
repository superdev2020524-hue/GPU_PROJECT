#!/bin/bash
# Auto-generated script to copy file via base64
# Run this when VM is accessible: bash copy_to_vm.sh

set -e

echo "=== Copying file via base64 ==="
echo ""

# Connect and create directory
ssh -o StrictHostKeyChecking=no test-7@10.25.33.17 "mkdir -p ~/phase3/guest-shim"

# Write base64 data
echo "Writing base64 data..."
ssh -o StrictHostKeyChecking=no test-7@10.25.33.17 'cat > /tmp/libvgpu_cuda.c.b64 << '''ENDOFFILE'''
LyoKICogbGlidmdwdV9jdWRhLmMgIOKAlCAgQ1VEQSBEcml2ZXIgQVBJIHNoaW0gbGlicmFyeQogKgogKiBUaGlzIHNoYXJlZCBsaWJyYXJ5IChsaWJ2Z3B1LWN1ZGEuc28pIGlzIGluc3RhbGxlZCBpbiB0aGUgZ3Vlc3QgVk0KICogYW5kIHJlcGxhY2VzIHRoZSByZWFsIGxpYmN1ZGEuc28uMS4gIEl0IGludGVyY2VwdHMgQ1VEQSBEcml2ZXIgQVBJCiAqIGNhbGxzLCBhbnN3ZXJzIGRldmljZS1xdWVyeSBmdW5jdGlvbnMgbG9jYWxseSB1c2luZyBjYWNoZWQgR1BVCiAqIHByb3BlcnRpZXMsIGFuZCBmb3J3YXJkcyBjb21wdXRlIG9wZXJhdGlvbnMgKGNvbnRleHQsIG1lbW9yeSwKICogbW9kdWxlLCBrZXJuZWwgbGF1bmNoLCBzdHJlYW0sIGV2ZW50KSB0byB0aGUgaG9zdCB2aWEgdGhlCiAqIFZHUFUtU1RVQiB0cmFuc3BvcnQuCiAqCiAqIEJ1aWxkOgogKiAgIGdjYyAtc2hhcmVkIC1mUElDIC1vIGxpYnZncHUtY3VkYS5zbyBsaWJ2Z3B1X2N1ZGEuYyBjdWRhX3RyYW5zcG9ydC5jIFwKICogICAgICAgLUkuLi9pbmNsdWRlIC1JLgogKgogKiBTeW1saW5rOgogKiAgIGxuIC1zZiAvdXNyL2xpYjY0L2xpYnZncHUtY3VkYS5zbyAvdXNyL2xpYjY0L2xpYmN1ZGEuc28uMQogKiAgIGxuIC1zZiAvdXNyL2xpYjY0L2xpYnZncHUtY3VkYS5zbyAvdXNyL2xpYjY0L2xpYmN1ZGEuc28KICovCgojZGVmaW5lIF9HTlVfU09VUkNFICAvKiBSZXF1aXJlZCBmb3IgUlRMRF9ORVhULCBSVExEX0RFRkFVTFQsIG1lbWZkX2NyZWF0ZSAqLwoKI2luY2x1ZGUgPHN0ZGlvLmg+CiNpbmNsdWRlIDxzdGRsaWIuaD4KI2luY2x1ZGUgPHN0cmluZy5oPgojaW5jbHVkZSA8c3RkaW50Lmg+CiNpbmNsdWRlIDx1bmlzdGQuaD4KI2luY2x1ZGUgPHB0aHJlYWQuaD4KI2luY2x1ZGUgPGRsZmNuLmg+CiNpbmNsdWRlIDxmY250bC5oPgojaW5jbHVkZSA8c3lzL3N0YXQuaD4KI2luY2x1ZGUgPHN5cy9tbWFuLmg+CiNpbmNsdWRlIDxlcnJuby5oPgojaW5jbHVkZSA8c3RkYXJnLmg+CiNpbmNsdWRlIDxmZWF0dXJlcy5oPiAgLyogRm9yIF9fR0xJQkNfXyBkZXRlY3Rpb24gKi8KI2luY2x1ZGUgPHVuaXN0ZC5oPiAgICAvKiBGb3IgcmVhZGxpbmssIHNzaXplX3QgKi8KI2luY2x1ZGUgPHRpbWUuaD4gICAgICAvKiBGb3IgY2xvY2tfZ2V0dGltZSwgdGltZXN0YW1wcyAqLwojaW5jbHVkZSA8c3lzL3R5cGVzLmg+IC8qIEZvciBwaWRfdCAqLwojaW5jbHVkZSA8c3lzL3N5c2NhbGwuaD4gLyogRm9yIGRpcmVjdCBzeXNjYWxscyAqLwoKLyogRm9yIHZhcmlhZGljIHN0dWIgZnVuY3Rpb24gKi8KI2luY2x1ZGUgPHN0ZGFyZy5oPgoKI2luY2x1ZGUgImN1ZGFfcHJvdG9jb2wuaCIKI2luY2x1ZGUgImN1ZGFfdHJhbnNwb3J0LmgiCiNpbmNsdWRlICJncHVfcHJvcGVydGllcy5oIgoKLyogPT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PQogKiBkbG9wZW4gaW50ZXJjZXB0aW9uICAoZGxzeW0gYW5kIGRsY2xvc2UgYXJlIE5PVCBvdmVycmlkZGVuKQogKgogKiBPbGxhbWEgKEdvIGJpbmFyeSwgQ0dvKSBkaXNjb3ZlcnMgR1BVcyBieSBjYWxsaW5nOgogKiAgICAgaGFuZGxlID0gZGxvcGVuKCJsaWJjdWRhLnNvLjEiLCBSVExEX0xBWlkpOwogKiAgICAgZm4gICAgID0gZGxzeW0oaGFuZGxlLCAiY3VJbml0Iik7CiAqCiAqIEV2ZW4gdGhvdWdoIG91ciBzaGltIGlzIGxvYWRlZCB2aWEgTERfUFJFTE9BRCBhbmQgaGFzIFNPTkFNRQogKiAibGliY3VkYS5zby4xIiwgc29tZSBnbGliYyB2ZXJzaW9ucyBvcGVuIGEgc2Vjb25kIGNvcHkgZnJvbSB0aGUKICogZmlsZXN5c3RlbSwgYnlwYXNzaW5nIHRoZSBwcmVsb2FkZWQgb25lLgogKgogKiBGaXg6IG92ZXJyaWRlIE9OTFkgZGxvcGVuLiAgV2hlbiBhbnkgY29kZSBpbiB0aGUgcHJvY2VzcyBjYWxscwogKiBkbG9wZW4oImxpYmN1ZGEuc28uMSIpLCB3ZSByZXR1cm4gYSBoYW5kbGUgdGhhdCBwb2ludHMgdG8gb3VyCiAqIGFscmVhZHktbG9hZGVkIHNoaW0uICBCZWNhdXNlIGRsc3ltIGlzIE5PVCBvdmVycmlkZGVuLCB0aGUgY2FsbGVyJ3MKICogc3Vic2VxdWVudCBkbHN5bSgpIGNhbGxzIGdvIHRocm91Z2ggZ2xpYmMgYW5kIGNvcnJlY3RseSByZXNvbHZlCiAqIHN5bWJvbHMgZnJvbSB0aGUgcmV0dXJuZWQgaGFuZGxlICh3aGljaCBJUyBvdXIgc2hpbSkuCiAqCiAqIEJvb3RzdHJhcHBpbmc6IHdlIGZpbmQgdGhlIHJlYWwgZGxvcGVuIHZpYSBkbHN5bShSVExEX05FWFQsIC4uLikuCiAqIFRoaXMgaXMgc2FmZSBiZWNhdXNlIGRsc3ltIGl0c2VsZiBpcyBOT1Qgb3ZlcnJpZGRlbiDigJQgbm8KICogX19saWJjX2Rsc3ltIG5lZWRlZCAodGhhdCBzeW1ib2wgaXMgbm90IGV4cG9ydGVkIG9uIGFsbCBnbGliYwogKiBidWlsZHMgYW5kIGNhdXNlZCAidW5kZWZpbmVkIHN5bWJvbCIgY3Jhc2hlcyB3aXRoIEdvIGJpbmFyaWVzKS4KICoKICogVVBEQVRFOiBXZSBub3cgaW50ZXJjZXB0IGRsc3ltIHRvIGxvZyB3aGF0IGZ1bmN0aW9ucyBPbGxhbWEgaXMKICogbG9va2luZyBmb3IsIHdoaWNoIGhlbHBzIGRpYWdub3NlIGRpc2NvdmVyeSBpc3N1ZXMuCiAqCiAqIFJlcXVpcmVzIGxpbmtpbmcgd2l0aCAtbGRsLgogKiA9PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09ICovCgovKiBOT1RFOiBkbHN5bSBpbnRlcmNlcHRpb24gaXMgY29tcGxleCBhbmQgcmVxdWlyZXMgX19saWJjX2Rsc3ltIHdoaWNoIG1heSBub3QKICogYmUgYXZhaWxhYmxlLiBJbnN0ZWFkLCB3ZSBlbnN1cmUgYWxsIGZ1bmN0aW9ucyBhcmUgcHJvcGVybHkgZXhwb3J0ZWQgc28KICogZGxzeW0gY2FuIGZpbmQgdGhlbS4gV2UnbGwgYWRkIGxvZ2dpbmcgdmlhIGEgZGlmZmVyZW50IG1lY2hhbmlzbSBpZiBuZWVkZWQuCiAqIEZvciBub3csIHdlIGRvbid0IGludGVyY2VwdCBkbHN5bSB0byBhdm9pZCBib290c3RyYXAgaXNzdWVzLiAqLwoKdm9pZCAqZGxvcGVuKGNvbnN0IGNoYXIgKmZpbGVuYW1lLCBpbnQgZmxhZ3MpCnsKICAgIC8qIEZpbmQgdGhlIHJlYWwgZGxvcGVuIG9uIGZpcnN0IGNhbGwuICBTYWZlIGJlY2F1c2UgZGxzeW0gaXMgdGhlCiAgICAgKiByZWFsIGdsaWJjIGRsc3ltICh3ZSBkbyBOT1Qgb3ZlcnJpZGUgaXQpLiAqLwogICAgc3RhdGljIHZvaWQgKigqcmVhbF9kbG9wZW4pKGNvbnN0IGNoYXIgKiwgaW50KSA9IE5VTEw7CiAgICBpZiAoIXJlYWxfZGxvcGVuKSB7CiAgICAgICAgcmVhbF9kbG9wZW4gPSAodm9pZCAqKCopKGNvbnN0IGNoYXIgKiwgaW50KSkKICAgICAgICAgICAgICAgICAgICAgIGRsc3ltKFJUTERfTkVYVCwgImRsb3BlbiIpOwogICAgfQoKICAgIGlmIChmaWxlbmFtZSkgewogICAgICAgIGlmIChzdHJzdHIoZmlsZW5hbWUsICJsaWJjdWRhLnNvIikgfHwKICAgICAgICAgICAgc3Ryc3RyKGZpbGVuYW1lLCAibGlibnZjdWRhLnNvIikpIHsKICAgICAgICAgICAgZnByaW50ZihzdGRlcnIsCiAgICAgICAgICAgICAgICAgICAgIltsaWJ2Z3B1LWN1ZGFdIGRsb3BlbihcIiVzXCIpIGludGVyY2VwdGVkXG4iLCBmaWxlbmFtZSk7CiAgICAgICAgICAgIC8qCiAgICAgICAgICAgICAqIFJldHVybiBhIGhhbmRsZSB0byBvdXIgYWxyZWFkeS1sb2FkZWQgc2hpbS4KICAgICAgICAgICAgICogUlRMRF9OT0xPQUQgYXZvaWRzIGxvYWRpbmcgYSBzZWNvbmQgY29weSDigJQgaXQgb25seSByZXR1cm5zCiAgICAgICAgICAgICAqIGEgaGFuZGxlIGlmIHRoZSBsaWJyYXJ5IGlzIGFscmVhZHkgcmVzaWRlbnQgKHdoaWNoIGl0IGlzLAogICAgICAgICAgICAgKiB2aWEgTERfUFJFTE9BRCkuICBPdXIgU09OQU1FIGlzICJsaWJjdWRhLnNvLjEiIHNvIHRoZQogICAgICAgICAgICAgKiBuYW1lIG1hdGNoZXMuICBJZiBSVExEX05PTE9BRCBmYWlscyBmb3IgYW55IHJlYXNvbiwgZmFsbAogICAgICAgICAgICAgKiBiYWNrIHRvIHRoZSBnbG9iYWwtc2NvcGUgaGFuZGxlIChkbG9wZW4oTlVMTCkpLgogICAgICAgICAgICAgKi8KICAgICAgICAgICAgdm9pZCAqaCA9IHJlYWxfZGxvcGVuKCJsaWJjdWRhLnNvLjEiLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgUlRMRF9OT1cgfCBSVExEX05PTE9BRCk7CiAgICAgICAgICAgIGlmICghaCkKICAgICAgICAgICAgICAgIGggPSByZWFsX2Rsb3BlbihOVUxMLCBSVExEX0xBWlkpOwogICAgICAgICAgICByZXR1cm4gaDsKICAgICAgICB9CiAgICAgICAgaWYgKHN0cnN0cihmaWxlbmFtZSwgImxpYm52aWRpYS1tbC5zbyIpKSB7CiAgICAgICAgICAgIGZwcmludGYoc3RkZXJyLAogICAgICAgICAgICAgICAgICAgICJbbGlidmdwdS1jdWRhXSBkbG9wZW4oXCIlc1wiKSBpbnRlcmNlcHRlZFxuIiwgZmlsZW5hbWUpOwogICAgICAgICAgICB2b2lkICpoID0gcmVhbF9kbG9wZW4oImxpYm52aWRpYS1tbC5zby4xIiwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIFJUTERfTk9XIHwgUlRMRF9OT0xPQUQpOwogICAgICAgICAgICBpZiAoIWgpCiAgICAgICAgICAgICAgICBoID0gcmVhbF9kbG9wZW4oTlVMTCwgUlRMRF9MQVpZKTsKICAgICAgICAgICAgcmV0dXJuIGg7CiAgICAgICAgfQogICAgICAgIC8qIEludGVyY2VwdCBsaWJjdWRhcnQuc28gcmVxdWVzdHMgLSBSdW50aW1lIEFQSSBsaWJyYXJ5LgogICAgICAgICAqIFRoZSBSdW50aW1lIEFQSSBpbnRlcm5hbGx5IGNhbGxzIERyaXZlciBBUEkgZnVuY3Rpb25zLCBzbwogICAgICAgICAqIGFzIGxvbmcgYXMgb3VyIERyaXZlciBBUEkgc2hpbSBpcyBsb2FkZWQsIFJ1bnRpbWUgQVBJIGNhbGxzCiAgICAgICAgICogd2lsbCBnbyB0aHJvdWdoIG91ciBzaGltLiBIb3dldmVyLCBpbnRlcmNlcHRpbmcgZGxvcGVuIGhlcmUKICAgICAgICAgKiBlbnN1cmVzIHRoYXQgaWYgY29kZSB0cmllcyB0byBsb2FkIGxpYmN1ZGFydCBkaXJlY3RseSwgaXQKICAgICAgICAgKiBzdGlsbCB3b3Jrcy4gV2UgZG9uJ3QgbmVlZCB0byByZXBsYWNlIGxpYmN1ZGFydCwganVzdCBlbnN1cmUKICAgICAgICAgKiBpdCBjYW4gZmluZCBvdXIgRHJpdmVyIEFQSSBzaGltLiAqLwogICAgICAgIGlmIChzdHJzdHIoZmlsZW5hbWUsICJsaWJjdWRhcnQuc28iKSkgewogICAgICAgICAgICBmcHJpbnRmKHN0ZGVyciwKICAgICAgICAgICAgICAgICAgICAiW2xpYnZncHUtY3VkYV0gZGxvcGVuKFwiJXNcIikgaW50ZXJjZXB0ZWQgKFJ1bnRpbWUgQVBJIC0gd2lsbCB1c2Ugb3VyIERyaXZlciBBUEkgc2hpbSlcbiIsIGZpbGVuYW1lKTsKICAgICAgICAgICAgLyogTGV0IHRoZSByZWFsIGxpYmN1ZGFydCBsb2FkLCBidXQgaXQgd2lsbCB1c2Ugb3VyIERyaXZlciBBUEkgc2hpbSAqLwogICAgICAgICAgICAvKiBUaGlzIGlzIGZpbmUgLSBsaWJjdWRhcnQgY2FsbHMgRHJpdmVyIEFQSSBmdW5jdGlvbnMgd2hpY2ggd2UgaW50ZXJjZXB0ICovCiAgICAgICAgfQogICAgfQogICAgcmV0dXJuIHJlYWxfZGxvcGVuKGZpbGVuYW1lLCBmbGFncyk7Cn0KCi8qID09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT0KICogRmlsZXN5c3RlbSBpbnRlcmNlcHRpb24gZm9yIC9wcm9jL2RyaXZlci9udmlkaWEvdmVyc2lvbgogKgogKiBNYW55IEdQVSBkaXNjb3ZlcnkgbWVjaGFuaXNtcyAoaW5jbHVkaW5nIE9sbGFtYSdzIGJvb3RzdHJhcCBkaXNjb3ZlcnkpCiAqIGNoZWNrIC9wcm9jL2RyaXZlci9udmlkaWEvdmVyc2lvbiBmaXJzdC4gSWYgdGhpcyBmaWxlIGRvZXNuJ3QgZXhpc3QsCiAqIHRoZXkgc2tpcCBHUFUgZGV0ZWN0aW9uIGVudGlyZWx5IGFuZCBuZXZlciBsb2FkIENVREEvTlZNTCBsaWJyYXJpZXMuCiAqCiAqIFdlIGludGVyY2VwdCBvcGVuKCksIG9wZW5hdCgpLCBhbmQgc3RhdCgpIGNhbGxzIHRvIG1ha2UgaXQgYXBwZWFyCiAqIHRoYXQgL3Byb2MvZHJpdmVyL252aWRpYS92ZXJzaW9uIGV4aXN0cywgcmV0dXJuaW5nIGEgZmFrZSB2ZXJzaW9uCiAqIHN0cmluZyB3aGVuIHJlYWQuCiAqID09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT0gKi8KCnN0YXRpYyBjb25zdCBjaGFyICpmYWtlX252aWRpYV92ZXJzaW9uID0gIk5WSURJQS1TTUkgNTUwLjU0LjE1ICAgIERyaXZlciBWZXJzaW9uOiA1NTAuNTQuMTUgICAgQ1VEQSBWZXJzaW9uOiAxMi40XG4iOwoKLyogRm9yd2FyZCBkZWNsYXJhdGlvbiBmb3IgcHJvY2VzcyBjaGVja2luZyAtIG5lZWRlZCBiZWZvcmUgb3BlbigpIGFuZCBmZ2V0cygpIHVzZSBpdCAqLwpzdGF0aWMgaW50IGlzX3N5c3RlbV9wcm9jZXNzKHZvaWQpOwpzdGF0aWMgaW50IGlzX2FwcGxpY2F0aW9uX3Byb2Nlc3Modm9pZCk7CgovKiBDYWNoZWQgcHJvY2VzcyB0eXBlIC0gYXZvaWQgcmVwZWF0ZWQgY2hlY2tzICovCnN0YXRpYyBfX3RocmVhZCBpbnQgZ19wcm9jZXNzX3R5cGVfY2FjaGVkID0gLTE7ICAvKiAtMSA9IG5vdCBjaGVja2VkLCAwID0gc3lzdGVtLCAxID0gYXBwbGljYXRpb24gKi8KCnN0YXRpYyBpbnQgaXNfbnZpZGlhX3Byb2NfZmlsZShjb25zdCBjaGFyICpwYXRoKQp7CiAgICBpZiAoIXBhdGgpIHJldHVybiAwOwogICAgLyogSW50ZXJjZXB0IGFsbCBOVklESUEtcmVsYXRlZCBwYXRocyB0aGF0IE9sbGFtYSBtaWdodCBjaGVjayAqLwogICAgcmV0dXJuIChzdHJzdHIocGF0aCwgIi9wcm9jL2RyaXZlci9udmlkaWEvdmVyc2lvbiIpICE9IE5VTEwgfHwKICAgICAgICAgICAgc3Ryc3RyKHBhdGgsICIvcHJvYy9kcml2ZXIvbnZpZGlhL3BhcmFtcyIpICE9IE5VTEwgfHwKICAgICAgICAgICAgc3Ryc3RyKHBhdGgsICIvcHJvYy9kcml2ZXIvbnZpZGlhIikgIT0gTlVMTCB8fAogICAgICAgICAgICBzdHJzdHIocGF0aCwgIi9zeXMvY2xhc3MvZHJtL2NhcmQiKSAhPSBOVUxMIHx8ICAvKiBHUFUgZGV2aWNlIGRldGVjdGlvbiAqLwogICAgICAgICAgICBzdHJzdHIocGF0aCwgIi9kZXYvbnZpZGlhMCIpICE9IE5VTEwgfHwKICAgICAgICAgICAgc3Ryc3RyKHBhdGgsICIvZGV2L252aWRpYWN0bCIpICE9IE5VTEwgfHwKICAgICAgICAgICAgc3Ryc3RyKHBhdGgsICIvZGV2L252aWRpYS11dm0iKSAhPSBOVUxMKTsKfQoKLyogSW50ZXJjZXB0IG9wZW4oKSBjYWxscyAqLwppbnQgb3Blbihjb25zdCBjaGFyICpwYXRobmFtZSwgaW50IGZsYWdzLCAuLi4pCnsKICAgIHN0YXRpYyBpbnQgKCpyZWFsX29wZW4pKGNvbnN0IGNoYXIgKiwgaW50LCAuLi4pID0gTlVMTDsKICAgIGlmICghcmVhbF9vcGVuKSB7CiAgICAgICAgcmVhbF9vcGVuID0gKGludCAoKikoY29uc3QgY2hhciAqLCBpbnQsIC4uLikpCiAgICAgICAgICAgICAgICAgICAgZGxzeW0oUlRMRF9ORVhULCAib3BlbiIpOwogICAgfQoKICAgIC8qIENSSVRJQ0FMOiBDaGVjayBwcm9jZXNzIHR5cGUgRklSU1QsIGJlZm9yZSBhbnkgaW50ZXJjZXB0aW9uIGxvZ2ljICovCiAgICAvKiBPbmx5IGludGVyY2VwdCBmb3IgYXBwbGljYXRpb24gcHJvY2Vzc2VzIChvbGxhbWEpLCBuZXZlciBmb3Igc3lzdGVtIHByb2Nlc3NlcyAqLwogICAgaWYgKCFpc19hcHBsaWNhdGlvbl9wcm9jZXNzKCkpIHsKICAgICAgICB2YV9saXN0IGFyZ3M7CiAgICAgICAgdmFfc3RhcnQoYXJncywgZmxhZ3MpOwogICAgICAgIG1vZGVfdCBtb2RlID0gKGZsYWdzICYgT19DUkVBVCkgPyB2YV9hcmcoYXJncywgbW9kZV90KSA6IDA7CiAgICAgICAgdmFfZW5kKGFyZ3MpOwogICAgICAgIHJldHVybiByZWFsX29wZW4gPyByZWFsX29wZW4ocGF0aG5hbWUsIGZsYWdzLCBtb2RlKSA6IC0xOwogICAgfQoKICAgIGlmIChpc19udmlkaWFfcHJvY19maWxlKHBhdGhuYW1lKSkgewogICAgICAgIGZwcmludGYoc3RkZXJyLCAiW2xpYnZncHUtY3VkYV0gb3BlbihcIiVzXCIpIGludGVyY2VwdGVkIChwaWQ9JWQpXG4iLCBwYXRobmFtZSwgKGludClnZXRwaWQoKSk7CiAgICAgICAgZmZsdXNoKHN0ZGVycik7CiAgICAgICAgLyogUmV0dXJuIGEgZmlsZSBkZXNjcmlwdG9yIHRvIGEgdGVtcG9yYXJ5IGZpbGUgd2l0aCBmYWtlIHZlcnNpb24gKi8KICAgICAgICAvKiBVc2UgbWVtZmRfY3JlYXRlIGlmIGF2YWlsYWJsZSwgb3RoZXJ3aXNlIHVzZSB0ZW1wIGZpbGUgKi8KICAgICAgICBpbnQgZmQgPSAtMTsKI2lmZGVmIF9fbGludXhfXwogICAgICAgIGZkID0gbWVtZmRfY3JlYXRlKCJudmlkaWFfdmVyc2lvbiIsIDApOwogICAgICAgIGlmIChmZCA+PSAwKSB7CiAgICAgICAgICAgIHNzaXplX3Qgd3JpdHRlbiA9IHdyaXRlKGZkLCBmYWtlX252aWRpYV92ZXJzaW9uLCBzdHJsZW4oZmFrZV9udmlkaWFfdmVyc2lvbikpOwogICAgICAgICAgICBpZiAod3JpdHRlbiA+IDApIHsKICAgICAgICAgICAgICAgIGxzZWVrKGZkLCAwLCBTRUVLX1NFVCk7CiAgICAgICAgICAgICAgICBmcHJpbnRmKHN0ZGVyciwgIltsaWJ2Z3B1LWN1ZGFdIG9wZW46IGNyZWF0ZWQgbWVtZmQgd2l0aCB2ZXJzaW9uIHN0cmluZyAoZmQ9JWQpXG4iLCBmZCk7CiAgICAgICAgICAgICAgICBmZmx1c2goc3RkZXJyKTsKICAgICAgICAgICAgICAgIHJldHVybiBmZDsKICAgICAgICAgICAgfQogICAgICAgIH0KI2VuZGlmCiAgICAgICAgLyogRmFsbGJhY2s6IHVzZSB0ZW1wIGZpbGUgKi8KICAgICAgICBjaGFyIHRtcF9wYXRoW10gPSAiL3RtcC9udmlkaWFfdmVyc2lvbl9YWFhYWFgiOwogICAgICAgIGZkID0gbWtzdGVtcCh0bXBfcGF0aCk7CiAgICAgICAgaWYgKGZkID49IDApIHsKICAgICAgICAgICAgd3JpdGUoZmQsIGZha2VfbnZpZGlhX3ZlcnNpb24sIHN0cmxlbihmYWtlX252aWRpYV92ZXJzaW9uKSk7CiAgICAgICAgICAgIGxzZWVrKGZkLCAwLCBTRUVLX1NFVCk7CiAgICAgICAgICAgIHVubGluayh0bXBfcGF0aCk7IC8qIERlbGV0ZSB0ZW1wIGZpbGUsIGJ1dCBrZWVwIGZkIG9wZW4gKi8KICAgICAgICAgICAgZnByaW50ZihzdGRlcnIsICJbbGlidmdwdS1jdWRhXSBvcGVuOiBjcmVhdGVkIHRlbXAgZmlsZSB3aXRoIHZlcnNpb24gc3RyaW5nIChmZD0lZClcbiIsIGZkKTsKICAgICAgICAgICAgZmZsdXNoKHN0ZGVycik7CiAgICAgICAgICAgIHJldHVybiBmZDsKICAgICAgICB9CiAgICAgICAgLyogSWYgYWxsIGVsc2UgZmFpbHMsIHJldHVybiBFTk9FTlQgKi8KICAgICAgICBmcHJpbnRmKHN0ZGVyciwgIltsaWJ2Z3B1LWN1ZGFdIG9wZW46IGZhaWxlZCB0byBjcmVhdGUgZmFrZSBmaWxlIGZvciBcIiVzXCJcbiIsIHBhdGhuYW1lKTsKICAgICAgICBmZmx1c2goc3RkZXJyKTsKICAgICAgICBlcnJubyA9IEVOT0VOVDsKICAgICAgICByZXR1cm4gLTE7CiAgICB9CgogICAgdmFfbGlzdCBhcmdzOwogICAgdmFfc3RhcnQoYXJncywgZmxhZ3MpOwogICAgbW9kZV90IG1vZGUgPSAoZmxhZ3MgJiBPX0NSRUFUKSA/IHZhX2FyZyhhcmdzLCBtb2RlX3QpIDogMDsKICAgIHZhX2VuZChhcmdzKTsKICAgIHJldHVybiByZWFsX29wZW4ocGF0aG5hbWUsIGZsYWdzLCBtb2RlKTsKfQoKLyogSW50ZXJjZXB0IG9wZW5hdCgpIGNhbGxzICovCmludCBvcGVuYXQoaW50IGRpcmZkLCBjb25zdCBjaGFyICpwYXRobmFtZSwgaW50IGZsYWdzLCAuLi4pCnsKICAgIHN0YXRpYyBpbnQgKCpyZWFsX29wZW5hdCkoaW50LCBjb25zdCBjaGFyICosIGludCwgLi4uKSA9IE5VTEw7CiAgICBpZiAoIXJlYWxfb3BlbmF0KSB7CiAgICAgICAgcmVhbF9vcGVuYXQgPSAoaW50ICgqKShpbnQsIGNvbnN0IGNoYXIgKiwgaW50LCAuLi4pKQogICAgICAgICAgICAgICAgICAgICAgZGxzeW0oUlRMRF9ORVhULCAib3BlbmF0Iik7CiAgICB9CgogICAgLyogQ1JJVElDQUw6IENoZWNrIHByb2Nlc3MgdHlwZSBGSVJTVCAtIG9ubHkgaW50ZXJjZXB0IGZvciBhcHBsaWNhdGlvbiBwcm9jZXNzZXMgKi8KICAgIGlmICghaXNfYXBwbGljYXRpb25fcHJvY2VzcygpKSB7CiAgICAgICAgdmFfbGlzdCBhcmdzOwogICAgICAgIHZhX3N0YXJ0KGFyZ3MsIGZsYWdzKTsKICAgICAgICBtb2RlX3QgbW9kZSA9IChmbGFncyAmIE9fQ1JFQVQpID8gdmFfYXJnKGFyZ3MsIG1vZGVfdCkgOiAwOwogICAgICAgIHZhX2VuZChhcmdzKTsKICAgICAgICByZXR1cm4gcmVhbF9vcGVuYXQgPyByZWFsX29wZW5hdChkaXJmZCwgcGF0aG5hbWUsIGZsYWdzLCBtb2RlKSA6IC0xOwogICAgfQoKICAgIGlmIChpc19udmlkaWFfcHJvY19maWxlKHBhdGhuYW1lKSkgewogICAgICAgIGZwcmludGYoc3RkZXJyLCAiW2xpYnZncHUtY3VkYV0gb3BlbmF0KCVkLCBcIiVzXCIpIGludGVyY2VwdGVkXG4iLCBkaXJmZCwgcGF0aG5hbWUpOwogICAgICAgIGZmbHVzaChzdGRlcnIpOwogICAgICAgIC8qIFJldHVybiBhIGZpbGUgZGVzY3JpcHRvciB0byBhIHRlbXBvcmFyeSBmaWxlIHdpdGggZmFrZSB2ZXJzaW9uICovCiAgICAgICAgaW50IGZkID0gLTE7CiNpZmRlZiBfX2xpbnV4X18KICAgICAgICBmZCA9IG1lbWZkX2NyZWF0ZSgibnZpZGlhX3ZlcnNpb24iLCAwKTsKICAgICAgICBpZiAoZmQgPj0gMCkgewogICAgICAgICAgICB3cml0ZShmZCwgZmFrZV9udmlkaWFfdmVyc2lvbiwgc3RybGVuKGZha2VfbnZpZGlhX3ZlcnNpb24pKTsKICAgICAgICAgICAgbHNlZWsoZmQsIDAsIFNFRUtfU0VUKTsKICAgICAgICAgICAgcmV0dXJuIGZkOwogICAgICAgIH0KI2VuZGlmCiAgICAgICAgY2hhciB0bXBfcGF0aFtdID0gIi90bXAvbnZpZGlhX3ZlcnNpb25fWFhYWFhYIjsKICAgICAgICBmZCA9IG1rc3RlbXAodG1wX3BhdGgpOwogICAgICAgIGlmIChmZCA+PSAwKSB7CiAgICAgICAgICAgIHdyaXRlKGZkLCBmYWtlX252aWRpYV92ZXJzaW9uLCBzdHJsZW4oZmFrZV9udmlkaWFfdmVyc2lvbikpOwogICAgICAgICAgICBsc2VlayhmZCwgMCwgU0VFS19TRVQpOwogICAgICAgICAgICB1bmxpbmsodG1wX3BhdGgpOwogICAgICAgICAgICByZXR1cm4gZmQ7CiAgICAgICAgfQogICAgICAgIGVycm5vID0gRU5PRU5UOwogICAgICAgIHJldHVybiAtMTsKICAgIH0KCiAgICB2YV9saXN0IGFyZ3M7CiAgICB2YV9zdGFydChhcmdzLCBmbGFncyk7CiAgICBtb2RlX3QgbW9kZSA9IChmbGFncyAmIE9fQ1JFQVQpID8gdmFfYXJnKGFyZ3MsIG1vZGVfdCkgOiAwOwogICAgdmFfZW5kKGFyZ3MpOwogICAgcmV0dXJuIHJlYWxfb3BlbmF0KGRpcmZkLCBwYXRobmFtZSwgZmxhZ3MsIG1vZGUpOwp9CgovKiBJbnRlcmNlcHQgc3RhdCgpIGNhbGxzICovCmludCBzdGF0KGNvbnN0IGNoYXIgKnBhdGhuYW1lLCBzdHJ1Y3Qgc3RhdCAqc3RhdGJ1ZikKewogICAgc3RhdGljIGludCAoKnJlYWxfc3RhdCkoY29uc3QgY2hhciAqLCBzdHJ1Y3Qgc3RhdCAqKSA9IE5VTEw7CiAgICBpZiAoIXJlYWxfc3RhdCkgewogICAgICAgIHJlYWxfc3RhdCA9IChpbnQgKCopKGNvbnN0IGNoYXIgKiwgc3RydWN0IHN0YXQgKikpCiAgICAgICAgICAgICAgICAgICAgZGxzeW0oUlRMRF9ORVhULCAic3RhdCIpOwogICAgfQoKICAgIC8qIENSSVRJQ0FMOiBDaGVjayBwcm9jZXNzIHR5cGUgRklSU1QgLSBvbmx5IGludGVyY2VwdCBmb3IgYXBwbGljYXRpb24gcHJvY2Vzc2VzICovCiAgICBpZiAoIWlzX2FwcGxpY2F0aW9uX3Byb2Nlc3MoKSkgewogICAgICAgIHJldHVybiByZWFsX3N0YXQgPyByZWFsX3N0YXQocGF0aG5hbWUsIHN0YXRidWYpIDogLTE7CiAgICB9CgogICAgaWYgKGlzX252aWRpYV9wcm9jX2ZpbGUocGF0aG5hbWUpKSB7CiAgICAgICAgZnByaW50ZihzdGRlcnIsICJbbGlidmdwdS1jdWRhXSBzdGF0KFwiJXNcIikgaW50ZXJjZXB0ZWQgKHBpZD0lZClcbiIsIHBhdGhuYW1lLCAoaW50KWdldHBpZCgpKTsKICAgICAgICBmZmx1c2goc3RkZXJyKTsKICAgICAgICAvKiBSZXR1cm4gc3VjY2VzcyB3aXRoIGZha2Ugc3RhdCBpbmZvICovCiAgICAgICAgaWYgKHN0YXRidWYpIHsKICAgICAgICAgICAgbWVtc2V0KHN0YXRidWYsIDAsIHNpemVvZigqc3RhdGJ1ZikpOwogICAgICAgICAgICBzdGF0YnVmLT5zdF9tb2RlID0gU19JRlJFRyB8IDA0NDQ7CiAgICAgICAgICAgIHN0YXRidWYtPnN0X3NpemUgPSBzdHJsZW4oZmFrZV9udmlkaWFfdmVyc2lvbik7CiAgICAgICAgICAgIHN0YXRidWYtPnN0X25saW5rID0gMTsKICAgICAgICAgICAgZnByaW50ZihzdGRlcnIsICJbbGlidmdwdS1jdWRhXSBzdGF0OiByZXR1cm5pbmcgZmFrZSBmaWxlIGluZm8gKHNpemU9JXp1KVxuIiwgc3RhdGJ1Zi0+c3Rfc2l6ZSk7CiAgICAgICAgICAgIGZmbHVzaChzdGRlcnIpOwogICAgICAgIH0KICAgICAgICByZXR1cm4gMDsKICAgIH0KCiAgICByZXR1cm4gcmVhbF9zdGF0KHBhdGhuYW1lLCBzdGF0YnVmKTsKfQoKLyogSW50ZXJjZXB0IGxzdGF0KCkgY2FsbHMgKi8KaW50IGxzdGF0KGNvbnN0IGNoYXIgKnBhdGhuYW1lLCBzdHJ1Y3Qgc3RhdCAqc3RhdGJ1ZikKewogICAgc3RhdGljIGludCAoKnJlYWxfbHN0YXQpKGNvbnN0IGNoYXIgKiwgc3RydWN0IHN0YXQgKikgPSBOVUxMOwogICAgaWYgKCFyZWFsX2xzdGF0KSB7CiAgICAgICAgcmVhbF9sc3RhdCA9IChpbnQgKCopKGNvbnN0IGNoYXIgKiwgc3RydWN0IHN0YXQgKikpCiAgICAgICAgICAgICAgICAgICAgIGRsc3ltKFJUTERfTkVYVCwgImxzdGF0Iik7CiAgICB9CgogICAgLyogQ1JJVElDQUw6IENoZWNrIHByb2Nlc3MgdHlwZSBGSVJTVCAtIG9ubHkgaW50ZXJjZXB0IGZvciBhcHBsaWNhdGlvbiBwcm9jZXNzZXMgKi8KICAgIGlmICghaXNfYXBwbGljYXRpb25fcHJvY2VzcygpKSB7CiAgICAgICAgcmV0dXJuIHJlYWxfbHN0YXQgPyByZWFsX2xzdGF0KHBhdGhuYW1lLCBzdGF0YnVmKSA6IC0xOwogICAgfQoKICAgIGlmIChpc19udmlkaWFfcHJvY19maWxlKHBhdGhuYW1lKSkgewogICAgICAgIGZwcmludGYoc3RkZXJyLCAiW2xpYnZncHUtY3VkYV0gbHN0YXQoXCIlc1wiKSBpbnRlcmNlcHRlZCAocGlkPSVkKVxuIiwgcGF0aG5hbWUsIChpbnQpZ2V0cGlkKCkpOwogICAgICAgIGZmbHVzaChzdGRlcnIpOwogICAgICAgIGlmIChzdGF0YnVmKSB7CiAgICAgICAgICAgIG1lbXNldChzdGF0YnVmLCAwLCBzaXplb2YoKnN0YXRidWYpKTsKICAgICAgICAgICAgc3RhdGJ1Zi0+c3RfbW9kZSA9IFNfSUZSRUcgfCAwNDQ0OwogICAgICAgICAgICBzdGF0YnVmLT5zdF9zaXplID0gc3RybGVuKGZha2VfbnZpZGlhX3ZlcnNpb24pOwogICAgICAgICAgICBzdGF0YnVmLT5zdF9ubGluayA9IDE7CiAgICAgICAgICAgIGZwcmludGYoc3RkZXJyLCAiW2xpYnZncHUtY3VkYV0gbHN0YXQ6IHJldHVybmluZyBmYWtlIGZpbGUgaW5mbyAoc2l6ZT0lenUpXG4iLCBzdGF0YnVmLT5zdF9zaXplKTsKICAgICAgICAgICAgZmZsdXNoKHN0ZGVycik7CiAgICAgICAgfQogICAgICAgIHJldHVybiAwOwogICAgfQoKICAgIHJldHVybiByZWFsX2xzdGF0KHBhdGhuYW1lLCBzdGF0YnVmKTsKfQoKLyogSW50ZXJjZXB0IGdsaWJjIGludGVybmFsIHN0YXQgZnVuY3Rpb25zIHVzZWQgYnkgUHl0aG9uIGFuZCBvdGhlciBhcHBsaWNhdGlvbnMgKi8KI2lmZGVmIF9fR0xJQkNfXwppbnQgX194c3RhdChpbnQgdmVycywgY29uc3QgY2hhciAqcGF0aG5hbWUsIHN0cnVjdCBzdGF0ICpzdGF0YnVmKQp7CiAgICBzdGF0aWMgaW50ICgqcmVhbF9fX3hzdGF0KShpbnQsIGNvbnN0IGNoYXIgKiwgc3RydWN0IHN0YXQgKikgPSBOVUxMOwogICAgaWYgKCFyZWFsX19feHN0YXQpIHsKICAgICAgICByZWFsX19feHN0YXQgPSAoaW50ICgqKShpbnQsIGNvbnN0IGNoYXIgKiwgc3RydWN0IHN0YXQgKikpCiAgICAgICAgICAgICAgICAgICAgICAgZGxzeW0oUlRMRF9ORVhULCAiX194c3RhdCIpOwogICAgfQoKICAgIGlmIChpc19udmlkaWFfcHJvY19maWxlKHBhdGhuYW1lKSkgewogICAgICAgIGZwcmludGYoc3RkZXJyLCAiW2xpYnZncHUtY3VkYV0gX194c3RhdCglZCwgXCIlc1wiKSBpbnRlcmNlcHRlZCAocGlkPSVkKVxuIiwgdmVycywgcGF0aG5hbWUsIChpbnQpZ2V0cGlkKCkpOwogICAgICAgIGZmbHVzaChzdGRlcnIpOwogICAgICAgIGlmIChzdGF0YnVmKSB7CiAgICAgICAgICAgIG1lbXNldChzdGF0YnVmLCAwLCBzaXplb2YoKnN0YXRidWYpKTsKICAgICAgICAgICAgc3RhdGJ1Zi0+c3RfbW9kZSA9IFNfSUZSRUcgfCAwNDQ0OwogICAgICAgICAgICBzdGF0YnVmLT5zdF9zaXplID0gc3RybGVuKGZha2VfbnZpZGlhX3ZlcnNpb24pOwogICAgICAgICAgICBzdGF0YnVmLT5zdF9ubGluayA9IDE7CiAgICAgICAgICAgIGZwcmludGYoc3RkZXJyLCAiW2xpYnZncHUtY3VkYV0gX194c3RhdDogcmV0dXJuaW5nIGZha2UgZmlsZSBpbmZvIChzaXplPSV6dSlcbiIsIHN0YXRidWYtPnN0X3NpemUpOwogICAgICAgICAgICBmZmx1c2goc3RkZXJyKTsKICAgICAgICB9CiAgICAgICAgcmV0dXJuIDA7CiAgICB9CgogICAgcmV0dXJuIHJlYWxfX194c3RhdCA/IHJlYWxfX194c3RhdCh2ZXJzLCBwYXRobmFtZSwgc3RhdGJ1ZikgOiAtMTsKfQoKaW50IF9feHN0YXQ2NChpbnQgdmVycywgY29uc3QgY2hhciAqcGF0aG5hbWUsIHN0cnVjdCBzdGF0NjQgKnN0YXRidWYpCnsKICAgIHN0YXRpYyBpbnQgKCpyZWFsX19feHN0YXQ2NCkoaW50LCBjb25zdCBjaGFyICosIHN0cnVjdCBzdGF0NjQgKikgPSBOVUxMOwogICAgaWYgKCFyZWFsX19feHN0YXQ2NCkgewogICAgICAgIHJlYWxfX194c3RhdDY0ID0gKGludCAoKikoaW50LCBjb25zdCBjaGFyICosIHN0cnVjdCBzdGF0NjQgKikpCiAgICAgICAgICAgICAgICAgICAgICAgICBkbHN5bShSVExEX05FWFQsICJfX3hzdGF0NjQiKTsKICAgIH0KCiAgICBpZiAoaXNfbnZpZGlhX3Byb2NfZmlsZShwYXRobmFtZSkpIHsKICAgICAgICBmcHJpbnRmKHN0ZGVyciwgIltsaWJ2Z3B1LWN1ZGFdIF9feHN0YXQ2NCglZCwgXCIlc1wiKSBpbnRlcmNlcHRlZCAocGlkPSVkKVxuIiwgdmVycywgcGF0aG5hbWUsIChpbnQpZ2V0cGlkKCkpOwogICAgICAgIGZmbHVzaChzdGRlcnIpOwogICAgICAgIGlmIChzdGF0YnVmKSB7CiAgICAgICAgICAgIG1lbXNldChzdGF0YnVmLCAwLCBzaXplb2YoKnN0YXRidWYpKTsKICAgICAgICAgICAgc3RhdGJ1Zi0+c3RfbW9kZSA9IFNfSUZSRUcgfCAwNDQ0OwogICAgICAgICAgICBzdGF0YnVmLT5zdF9zaXplID0gc3RybGVuKGZha2VfbnZpZGlhX3ZlcnNpb24pOwogICAgICAgICAgICBzdGF0YnVmLT5zdF9ubGluayA9IDE7CiAgICAgICAgICAgIGZwcmludGYoc3RkZXJyLCAiW2xpYnZncHUtY3VkYV0gX194c3RhdDY0OiByZXR1cm5pbmcgZmFrZSBmaWxlIGluZm8gKHNpemU9JXp1KVxuIiwgKHNpemVfdClzdGF0YnVmLT5zdF9zaXplKTsKICAgICAgICAgICAgZmZsdXNoKHN0ZGVycik7CiAgICAgICAgfQogICAgICAgIHJldHVybiAwOwogICAgfQoKICAgIHJldHVybiByZWFsX19feHN0YXQ2NCA/IHJlYWxfX194c3RhdDY0KHZlcnMsIHBhdGhuYW1lLCBzdGF0YnVmKSA6IC0xOwp9CgppbnQgX19seHN0YXQoaW50IHZlcnMsIGNvbnN0IGNoYXIgKnBhdGhuYW1lLCBzdHJ1Y3Qgc3RhdCAqc3RhdGJ1ZikKewogICAgc3RhdGljIGludCAoKnJlYWxfX19seHN0YXQpKGludCwgY29uc3QgY2hhciAqLCBzdHJ1Y3Qgc3RhdCAqKSA9IE5VTEw7CiAgICBpZiAoIXJlYWxfX19seHN0YXQpIHsKICAgICAgICByZWFsX19fbHhzdGF0ID0gKGludCAoKikoaW50LCBjb25zdCBjaGFyICosIHN0cnVjdCBzdGF0ICopKQogICAgICAgICAgICAgICAgICAgICAgICBkbHN5bShSVExEX05FWFQsICJfX2x4c3RhdCIpOwogICAgfQoKICAgIGlmIChpc19udmlkaWFfcHJvY19maWxlKHBhdGhuYW1lKSkgewogICAgICAgIGZwcmludGYoc3RkZXJyLCAiW2xpYnZncHUtY3VkYV0gX19seHN0YXQoJWQsIFwiJXNcIikgaW50ZXJjZXB0ZWQgKHBpZD0lZClcbiIsIHZlcnMsIHBhdGhuYW1lLCAoaW50KWdldHBpZCgpKTsKICAgICAgICBmZmx1c2goc3RkZXJyKTsKICAgICAgICBpZiAoc3RhdGJ1ZikgewogICAgICAgICAgICBtZW1zZXQoc3RhdGJ1ZiwgMCwgc2l6ZW9mKCpzdGF0YnVmKSk7CiAgICAgICAgICAgIHN0YXRidWYtPnN0X21vZGUgPSBTX0lGUkVHIHwgMDQ0NDsKICAgICAgICAgICAgc3RhdGJ1Zi0+c3Rfc2l6ZSA9IHN0cmxlbihmYWtlX252aWRpYV92ZXJzaW9uKTsKICAgICAgICAgICAgc3RhdGJ1Zi0+c3RfbmxpbmsgPSAxOwogICAgICAgICAgICBmcHJpbnRmKHN0ZGVyciwgIltsaWJ2Z3B1LWN1ZGFdIF9fbHhzdGF0OiByZXR1cm5pbmcgZmFrZSBmaWxlIGluZm8gKHNpemU9JXp1KVxuIiwgc3RhdGJ1Zi0+c3Rfc2l6ZSk7CiAgICAgICAgICAgIGZmbHVzaChzdGRlcnIpOwogICAgICAgIH0KICAgICAgICByZXR1cm4gMDsKICAgIH0KCiAgICByZXR1cm4gcmVhbF9fX2x4c3RhdCA/IHJlYWxfX19seHN0YXQodmVycywgcGF0aG5hbWUsIHN0YXRidWYpIDogLTE7Cn0KCmludCBfX2x4c3RhdDY0KGludCB2ZXJzLCBjb25zdCBjaGFyICpwYXRobmFtZSwgc3RydWN0IHN0YXQ2NCAqc3RhdGJ1ZikKewogICAgc3RhdGljIGludCAoKnJlYWxfX19seHN0YXQ2NCkoaW50LCBjb25zdCBjaGFyICosIHN0cnVjdCBzdGF0NjQgKikgPSBOVUxMOwogICAgaWYgKCFyZWFsX19fbHhzdGF0NjQpIHsKICAgICAgICByZWFsX19fbHhzdGF0NjQgPSAoaW50ICgqKShpbnQsIGNvbnN0IGNoYXIgKiwgc3RydWN0IHN0YXQ2NCAqKSkKICAgICAgICAgICAgICAgICAgICAgICAgICBkbHN5bShSVExEX05FWFQsICJfX2x4c3RhdDY0Iik7CiAgICB9CgogICAgaWYgKGlzX252aWRpYV9wcm9jX2ZpbGUocGF0aG5hbWUpKSB7CiAgICAgICAgZnByaW50ZihzdGRlcnIsICJbbGlidmdwdS1jdWRhXSBfX2x4c3RhdDY0KCVkLCBcIiVzXCIpIGludGVyY2VwdGVkIChwaWQ9JWQpXG4iLCB2ZXJzLCBwYXRobmFtZSwgKGludClnZXRwaWQoKSk7CiAgICAgICAgZmZsdXNoKHN0ZGVycik7CiAgICAgICAgaWYgKHN0YXRidWYpIHsKICAgICAgICAgICAgbWVtc2V0KHN0YXRidWYsIDAsIHNpemVvZigqc3RhdGJ1ZikpOwogICAgICAgICAgICBzdGF0YnVmLT5zdF9tb2RlID0gU19JRlJFRyB8IDA0NDQ7CiAgICAgICAgICAgIHN0YXRidWYtPnN0X3NpemUgPSBzdHJsZW4oZmFrZV9udmlkaWFfdmVyc2lvbik7CiAgICAgICAgICAgIHN0YXRidWYtPnN0X25saW5rID0gMTsKICAgICAgICAgICAgZnByaW50ZihzdGRlcnIsICJbbGlidmdwdS1jdWRhXSBfX2x4c3RhdDY0OiByZXR1cm5pbmcgZmFrZSBmaWxlIGluZm8gKHNpemU9JXp1KVxuIiwgKHNpemVfdClzdGF0YnVmLT5zdF9zaXplKTsKICAgICAgICAgICAgZmZsdXNoKHN0ZGVycik7CiAgICAgICAgfQogICAgICAgIHJldHVybiAwOwogICAgfQoKICAgIHJldHVybiByZWFsX19fbHhzdGF0NjQgPyByZWFsX19fbHhzdGF0NjQodmVycywgcGF0aG5hbWUsIHN0YXRidWYpIDogLTE7Cn0KCmludCBfX2Z4c3RhdGF0KGludCB2ZXJzLCBpbnQgZGlyZmQsIGNvbnN0IGNoYXIgKnBhdGhuYW1lLCBzdHJ1Y3Qgc3RhdCAqc3RhdGJ1ZiwgaW50IGZsYWdzKQp7CiAgICBzdGF0aWMgaW50ICgqcmVhbF9fX2Z4c3RhdGF0KShpbnQsIGludCwgY29uc3QgY2hhciAqLCBzdHJ1Y3Qgc3RhdCAqLCBpbnQpID0gTlVMTDsKICAgIGlmICghcmVhbF9fX2Z4c3RhdGF0KSB7CiAgICAgICAgcmVhbF9fX2Z4c3RhdGF0ID0gKGludCAoKikoaW50LCBpbnQsIGNvbnN0IGNoYXIgKiwgc3RydWN0IHN0YXQgKiwgaW50KSkKICAgICAgICAgICAgICAgICAgICAgICAgICBkbHN5bShSVExEX05FWFQsICJfX2Z4c3RhdGF0Iik7CiAgICB9CgogICAgaWYgKGlzX252aWRpYV9wcm9jX2ZpbGUocGF0aG5hbWUpKSB7CiAgICAgICAgZnByaW50ZihzdGRlcnIsICJbbGlidmdwdS1jdWRhXSBfX2Z4c3RhdGF0KCVkLCAlZCwgXCIlc1wiLCAlZCkgaW50ZXJjZXB0ZWQgKHBpZD0lZClcbiIsIAogICAgICAgICAgICAgICAgdmVycywgZGlyZmQsIHBhdGhuYW1lLCBmbGFncywgKGludClnZXRwaWQoKSk7CiAgICAgICAgZmZsdXNoKHN0ZGVycik7CiAgICAgICAgaWYgKHN0YXRidWYpIHsKICAgICAgICAgICAgbWVtc2V0KHN0YXRidWYsIDAsIHNpemVvZigqc3RhdGJ1ZikpOwogICAgICAgICAgICBzdGF0YnVmLT5zdF9tb2RlID0gU19JRlJFRyB8IDA0NDQ7CiAgICAgICAgICAgIHN0YXRidWYtPnN0X3NpemUgPSBzdHJsZW4oZmFrZV9udmlkaWFfdmVyc2lvbik7CiAgICAgICAgICAgIHN0YXRidWYtPnN0X25saW5rID0gMTsKICAgICAgICAgICAgZnByaW50ZihzdGRlcnIsICJbbGlidmdwdS1jdWRhXSBfX2Z4c3RhdGF0OiByZXR1cm5pbmcgZmFrZSBmaWxlIGluZm8gKHNpemU9JXp1KVxuIiwgc3RhdGJ1Zi0+c3Rfc2l6ZSk7CiAgICAgICAgICAgIGZmbHVzaChzdGRlcnIpOwogICAgICAgIH0KICAgICAgICByZXR1cm4gMDsKICAgIH0KCiAgICByZXR1cm4gcmVhbF9fX2Z4c3RhdGF0ID8gcmVhbF9fX2Z4c3RhdGF0KHZlcnMsIGRpcmZkLCBwYXRobmFtZSwgc3RhdGJ1ZiwgZmxhZ3MpIDogLTE7Cn0KCmludCBfX2Z4c3RhdGF0NjQoaW50IHZlcnMsIGludCBkaXJmZCwgY29uc3QgY2hhciAqcGF0aG5hbWUsIHN0cnVjdCBzdGF0NjQgKnN0YXRidWYsIGludCBmbGFncykKewogICAgc3RhdGljIGludCAoKnJlYWxfX19meHN0YXRhdDY0KShpbnQsIGludCwgY29uc3QgY2hhciAqLCBzdHJ1Y3Qgc3RhdDY0ICosIGludCkgPSBOVUxMOwogICAgaWYgKCFyZWFsX19fZnhzdGF0YXQ2NCkgewogICAgICAgIHJlYWxfX19meHN0YXRhdDY0ID0gKGludCAoKikoaW50LCBpbnQsIGNvbnN0IGNoYXIgKiwgc3RydWN0IHN0YXQ2NCAqLCBpbnQpKQogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgZGxzeW0oUlRMRF9ORVhULCAiX19meHN0YXRhdDY0Iik7CiAgICB9CgogICAgaWYgKGlzX252aWRpYV9wcm9jX2ZpbGUocGF0aG5hbWUpKSB7CiAgICAgICAgZnByaW50ZihzdGRlcnIsICJbbGlidmdwdS1jdWRhXSBfX2Z4c3RhdGF0NjQoJWQsICVkLCBcIiVzXCIsICVkKSBpbnRlcmNlcHRlZCAocGlkPSVkKVxuIiwgCiAgICAgICAgICAgICAgICB2ZXJzLCBkaXJmZCwgcGF0aG5hbWUsIGZsYWdzLCAoaW50KWdldHBpZCgpKTsKICAgICAgICBmZmx1c2goc3RkZXJyKTsKICAgICAgICBpZiAoc3RhdGJ1ZikgewogICAgICAgICAgICBtZW1zZXQoc3RhdGJ1ZiwgMCwgc2l6ZW9mKCpzdGF0YnVmKSk7CiAgICAgICAgICAgIHN0YXRidWYtPnN0X21vZGUgPSBTX0lGUkVHIHwgMDQ0NDsKICAgICAgICAgICAgc3RhdGJ1Zi0+c3Rfc2l6ZSA9IHN0cmxlbihmYWtlX252aWRpYV92ZXJzaW9uKTsKICAgICAgICAgICAgc3RhdGJ1Zi0+c3RfbmxpbmsgPSAxOwogICAgICAgICAgICBmcHJpbnRmKHN0ZGVyciwgIltsaWJ2Z3B1LWN1ZGFdIF9fZnhzdGF0YXQ2NDogcmV0dXJuaW5nIGZha2UgZmlsZSBpbmZvIChzaXplPSV6dSlcbiIsIChzaXplX3Qpc3RhdGJ1Zi0+c3Rfc2l6ZSk7CiAgICAgICAgICAgIGZmbHVzaChzdGRlcnIpOwogICAgICAgIH0KICAgICAgICByZXR1cm4gMDsKICAgIH0KCiAgICByZXR1cm4gcmVhbF9fX2Z4c3RhdGF0NjQgPyByZWFsX19fZnhzdGF0YXQ2NCh2ZXJzLCBkaXJmZCwgcGF0aG5hbWUsIHN0YXRidWYsIGZsYWdzKSA6IC0xOwp9CiNlbmRpZiAvKiBfX0dMSUJDX18gKi8KCi8qIEludGVyY2VwdCBhY2Nlc3MoKSBjYWxscyAqLwppbnQgYWNjZXNzKGNvbnN0IGNoYXIgKnBhdGhuYW1lLCBpbnQgbW9kZSkKewogICAgc3RhdGljIGludCAoKnJlYWxfYWNjZXNzKShjb25zdCBjaGFyICosIGludCkgPSBOVUxMOwogICAgaWYgKCFyZWFsX2FjY2VzcykgewogICAgICAgIHJlYWxfYWNjZXNzID0gKGludCAoKikoY29uc3QgY2hhciAqLCBpbnQpKQogICAgICAgICAgICAgICAgICAgICAgZGxzeW0oUlRMRF9ORVhULCAiYWNjZXNzIik7CiAgICB9CgogICAgLyogQ1JJVElDQUw6IENoZWNrIHByb2Nlc3MgdHlwZSBGSVJTVCAtIG9ubHkgaW50ZXJjZXB0IGZvciBhcHBsaWNhdGlvbiBwcm9jZXNzZXMgKi8KICAgIGlmICghaXNfYXBwbGljYXRpb25fcHJvY2VzcygpKSB7CiAgICAgICAgcmV0dXJuIHJlYWxfYWNjZXNzID8gcmVhbF9hY2Nlc3MocGF0aG5hbWUsIG1vZGUpIDogLTE7CiAgICB9CgogICAgaWYgKGlzX252aWRpYV9wcm9jX2ZpbGUocGF0aG5hbWUpKSB7CiAgICAgICAgZnByaW50ZihzdGRlcnIsICJbbGlidmdwdS1jdWRhXSBhY2Nlc3MoXCIlc1wiLCAlZCkgaW50ZXJjZXB0ZWQgKHBpZD0lZClcbiIsIHBhdGhuYW1lLCBtb2RlLCAoaW50KWdldHBpZCgpKTsKICAgICAgICBmZmx1c2goc3RkZXJyKTsKICAgICAgICAvKiBSZXR1cm4gc3VjY2VzcyAoZmlsZSBleGlzdHMgYW5kIGlzIGFjY2Vzc2libGUpICovCiAgICAgICAgcmV0dXJuIDA7CiAgICB9CgogICAgcmV0dXJuIHJlYWxfYWNjZXNzKHBhdGhuYW1lLCBtb2RlKTsKfQoKLyogPT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PQogKiBQQ0kgRGV2aWNlIEZpbGUgSW50ZXJjZXB0aW9uCiAqCiAqIENSSVRJQ0FMOiBPbGxhbWEgc2NhbnMgUENJIGRldmljZXMgZGlyZWN0bHkgYnkgcmVhZGluZzoKICogLSAvc3lzL2J1cy9wY2kvZGV2aWNlcy8wMDAwOjAwOjA1LjAvdmVuZG9yCiAqIC0gL3N5cy9idXMvcGNpL2RldmljZXMvMDAwMDowMDowNS4wL2RldmljZQogKiAtIC9zeXMvYnVzL3BjaS9kZXZpY2VzLzAwMDA6MDA6MDUuMC9jbGFzcwogKgogKiBXZSBuZWVkIHRvIGludGVyY2VwdCByZWFkKCkgY2FsbHMgdG8gdGhlc2UgZmlsZXMgdG8gZW5zdXJlCiAqIE9sbGFtYSBzZWVzIHRoZSBjb3JyZWN0IHZhbHVlcyBmb3Igb3VyIHZHUFUgZGV2aWNlLgogKiA9PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09ICovCgovKiBGb3J3YXJkIGRlY2xhcmF0aW9uICovCnN0YXRpYyBpbnQgaXNfY2FsbGVyX2Zyb21fb3VyX2NvZGUodm9pZCk7CnN0YXRpYyBpbnQgaXNfcGNpX2RldmljZV9maWxlX3BhdGgoY29uc3QgY2hhciAqcGF0aCk7CgpzdGF0aWMgaW50IGlzX3BjaV9kZXZpY2VfZmlsZShpbnQgZmQsIGNvbnN0IGNoYXIgKnBhdGhuYW1lKQp7CiAgICBpZiAocGF0aG5hbWUpIHsKICAgICAgICAvKiBDaGVjayBpZiB0aGlzIGlzIGEgUENJIGRldmljZSBmaWxlIHdlIGNhcmUgYWJvdXQgKi8KICAgICAgICBpZiAoc3Ryc3RyKHBhdGhuYW1lLCAiL3N5cy9idXMvcGNpL2RldmljZXMvIikgIT0gTlVMTCkgewogICAgICAgICAgICBpZiAoc3Ryc3RyKHBhdGhuYW1lLCAiL3ZlbmRvciIpICE9IE5VTEwgfHwKICAgICAgICAgICAgICAgIHN0cnN0cihwYXRobmFtZSwgIi9kZXZpY2UiKSAhPSBOVUxMIHx8CiAgICAgICAgICAgICAgICBzdHJzdHIocGF0aG5hbWUsICIvY2xhc3MiKSAhPSBOVUxMKSB7CiAgICAgICAgICAgICAgICAvKiBDaGVjayBpZiBpdCdzIG91ciB2R1BVIGRldmljZSAoMDAwMDowMDowNS4wKSAqLwogICAgICAgICAgICAgICAgaWYgKHN0cnN0cihwYXRobmFtZSwgIjAwMDA6MDA6MDUuMCIpICE9IE5VTEwgfHwKICAgICAgICAgICAgICAgICAgICBzdHJzdHIocGF0aG5hbWUsICIwMDowNS4wIikgIT0gTlVMTCkgewogICAgICAgICAgICAgICAgICAgIHJldHVybiAxOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgfQogICAgfQogICAgCiAgICAvKiBBbHNvIGNoZWNrIGJ5IGZpbGUgZGVzY3JpcHRvciBpZiBwYXRobmFtZSBpcyBub3QgYXZhaWxhYmxlICovCiAgICBpZiAoZmQgPj0gMCkgewogICAgICAgIGNoYXIgcHJvY19wYXRoWzI1Nl07CiAgICAgICAgY2hhciBsaW5rX3RhcmdldFs1MTJdOwogICAgICAgIHNzaXplX3QgbGVuOwogICAgICAgIAogICAgICAgIHNucHJpbnRmKHByb2NfcGF0aCwgc2l6ZW9mKHByb2NfcGF0aCksICIvcHJvYy9zZWxmL2ZkLyVkIiwgZmQpOwogICAgICAgIGxlbiA9IHJlYWRsaW5rKHByb2NfcGF0aCwgbGlua190YXJnZXQsIHNpemVvZihsaW5rX3RhcmdldCkgLSAxKTsKICAgICAgICBpZiAobGVuID4gMCkgewogICAgICAgICAgICBsaW5rX3RhcmdldFtsZW5dID0gJ1wwJzsKICAgICAgICAgICAgaWYgKHN0cnN0cihsaW5rX3RhcmdldCwgIi9zeXMvYnVzL3BjaS9kZXZpY2VzLyIpICE9IE5VTEwgJiYKICAgICAgICAgICAgICAgIChzdHJzdHIobGlua190YXJnZXQsICIwMDAwOjAwOjA1LjAiKSAhPSBOVUxMIHx8CiAgICAgICAgICAgICAgICAgc3Ryc3RyKGxpbmtfdGFyZ2V0LCAiMDA6MDUuMCIpICE9IE5VTEwpKSB7CiAgICAgICAgICAgICAgICBpZiAoc3Ryc3RyKGxpbmtfdGFyZ2V0LCAiL3ZlbmRvciIpICE9IE5VTEwgfHwKICAgICAgICAgICAgICAgICAgICBzdHJzdHIobGlua190YXJnZXQsICIvZGV2aWNlIikgIT0gTlVMTCB8fAogICAgICAgICAgICAgICAgICAgIHN0cnN0cihsaW5rX3RhcmdldCwgIi9jbGFzcyIpICE9IE5VTEwpIHsKICAgICAgICAgICAgICAgICAgICByZXR1cm4gMTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgIH0KICAgIH0KICAgIAogICAgcmV0dXJuIDA7Cn0KCi8qIEludGVyY2VwdCByZWFkKCkgY2FsbHMgdG8gUENJIGRldmljZSBmaWxlcyAtIENSSVRJQ0FMIGZvciBHbydzIG9zLlJlYWQoKSAqLwpzc2l6ZV90IHJlYWQoaW50IGZkLCB2b2lkICpidWYsIHNpemVfdCBjb3VudCkKewogICAgc3RhdGljIHNzaXplX3QgKCpyZWFsX3JlYWQpKGludCwgdm9pZCAqLCBzaXplX3QpID0gTlVMTDsKICAgIGlmICghcmVhbF9yZWFkKSB7CiAgICAgICAgcmVhbF9yZWFkID0gKHNzaXplX3QgKCopKGludCwgdm9pZCAqLCBzaXplX3QpKQogICAgICAgICAgICAgICAgICAgIGRsc3ltKFJUTERfTkVYVCwgInJlYWQiKTsKICAgIH0KICAgIAogICAgLyogU2tpcCBpbnRlcmNlcHRpb24gaWYgY2FsbGVyIGlzIGZyb20gb3VyIG93biBjb2RlICovCiAgICBpZiAoaXNfY2FsbGVyX2Zyb21fb3VyX2NvZGUoKSkgewogICAgICAgIHJldHVybiByZWFsX3JlYWQgPyByZWFsX3JlYWQoZmQsIGJ1ZiwgY291bnQpIDogLTE7CiAgICB9CiAgICAKICAgIC8qIENoZWNrIGJ5IGZpbGUgZGVzY3JpcHRvciBsaW5rIChwcmltYXJ5IG1ldGhvZCkgKi8KICAgIGlmIChpc19wY2lfZGV2aWNlX2ZpbGUoZmQsIE5VTEwpKSB7CiAgICAgICAgY2hhciBwcm9jX3BhdGhbMjU2XTsKICAgICAgICBjaGFyIGxpbmtfdGFyZ2V0WzUxMl07CiAgICAgICAgc3NpemVfdCBsZW47CiAgICAgICAgCiAgICAgICAgc25wcmludGYocHJvY19wYXRoLCBzaXplb2YocHJvY19wYXRoKSwgIi9wcm9jL3NlbGYvZmQvJWQiLCBmZCk7CiAgICAgICAgbGVuID0gcmVhZGxpbmsocHJvY19wYXRoLCBsaW5rX3RhcmdldCwgc2l6ZW9mKGxpbmtfdGFyZ2V0KSAtIDEpOwogICAgICAgIGlmIChsZW4gPiAwKSB7CiAgICAgICAgICAgIGxpbmtfdGFyZ2V0W2xlbl0gPSAnXDAnOwogICAgICAgICAgICAKICAgICAgICAgICAgZnByaW50ZihzdGRlcnIsICJbbGlidmdwdS1jdWRhXSByZWFkKCkgaW50ZXJjZXB0ZWQgZm9yIFBDSSBkZXZpY2UgZmlsZSAodmlhIGZkIGxpbmspOiAlcyAocGlkPSVkKVxuIiwKICAgICAgICAgICAgICAgICAgICBsaW5rX3RhcmdldCwgKGludClnZXRwaWQoKSk7CiAgICAgICAgICAgIGZmbHVzaChzdGRlcnIpOwogICAgICAgICAgICAKICAgICAgICAgICAgLyogUmV0dXJuIGFwcHJvcHJpYXRlIHZhbHVlIGJhc2VkIG9uIGZpbGUgdHlwZSAqLwogICAgICAgICAgICBpZiAoc3Ryc3RyKGxpbmtfdGFyZ2V0LCAiL3ZlbmRvciIpICE9IE5VTEwpIHsKICAgICAgICAgICAgICAgIGlmIChjb3VudCA+PSA2KSB7CiAgICAgICAgICAgICAgICAgICAgc3RybmNweSgoY2hhciAqKWJ1ZiwgIjB4MTBkZVxuIiwgY291bnQpOwogICAgICAgICAgICAgICAgICAgIGZwcmludGYoc3RkZXJyLCAiW2xpYnZncHUtY3VkYV0gcmVhZDogcmV0dXJuaW5nIHZlbmRvcj0weDEwZGUgKE5WSURJQSlcbiIpOwogICAgICAgICAgICAgICAgICAgIGZmbHVzaChzdGRlcnIpOwogICAgICAgICAgICAgICAgICAgIHJldHVybiA2OwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9IGVsc2UgaWYgKHN0cnN0cihsaW5rX3RhcmdldCwgIi9kZXZpY2UiKSAhPSBOVUxMKSB7CiAgICAgICAgICAgICAgICBpZiAoY291bnQgPj0gNikgewogICAgICAgICAgICAgICAgICAgIHN0cm5jcHkoKGNoYXIgKilidWYsICIweDIzMzFcbiIsIGNvdW50KTsKICAgICAgICAgICAgICAgICAgICBmcHJpbnRmKHN0ZGVyciwgIltsaWJ2Z3B1LWN1ZGFdIHJlYWQ6IHJldHVybmluZyBkZXZpY2U9MHgyMzMxIChIMTAwIFBDSWUpXG4iKTsKICAgICAgICAgICAgICAgICAgICBmZmx1c2goc3RkZXJyKTsKICAgICAgICAgICAgICAgICAgICByZXR1cm4gNjsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfSBlbHNlIGlmIChzdHJzdHIobGlua190YXJnZXQsICIvY2xhc3MiKSAhPSBOVUxMKSB7CiAgICAgICAgICAgICAgICBpZiAoY291bnQgPj0gOCkgewogICAgICAgICAgICAgICAgICAgIHN0cm5jcHkoKGNoYXIgKilidWYsICIweDAzMDIwMFxuIiwgY291bnQpOwogICAgICAgICAgICAgICAgICAgIGZwcmludGYoc3RkZXJyLCAiW2xpYnZncHUtY3VkYV0gcmVhZDogcmV0dXJuaW5nIGNsYXNzPTB4MDMwMjAwICgzRCBjb250cm9sbGVyKVxuIik7CiAgICAgICAgICAgICAgICAgICAgZmZsdXNoKHN0ZGVycik7CiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIDg7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICB9CiAgICB9CiAgICAKICAgIHJldHVybiByZWFsX3JlYWQgPyByZWFsX3JlYWQoZmQsIGJ1ZiwgY291bnQpIDogLTE7Cn0KCi8qIEludGVyY2VwdCBwcmVhZCgpIGNhbGxzIChwb3NpdGlvbmFsIHJlYWQpICovCnNzaXplX3QgcHJlYWQoaW50IGZkLCB2b2lkICpidWYsIHNpemVfdCBjb3VudCwgb2ZmX3Qgb2Zmc2V0KQp7CiAgICBzdGF0aWMgc3NpemVfdCAoKnJlYWxfcHJlYWQpKGludCwgdm9pZCAqLCBzaXplX3QsIG9mZl90KSA9IE5VTEw7CiAgICBpZiAoIXJlYWxfcHJlYWQpIHsKICAgICAgICByZWFsX3ByZWFkID0gKHNzaXplX3QgKCopKGludCwgdm9pZCAqLCBzaXplX3QsIG9mZl90KSkKICAgICAgICAgICAgICAgICAgICAgIGRsc3ltKFJUTERfTkVYVCwgInByZWFkIik7CiAgICB9CiAgICAKICAgIGlmIChpc19wY2lfZGV2aWNlX2ZpbGUoZmQsIE5VTEwpKSB7CiAgICAgICAgY2hhciBwcm9jX3BhdGhbMjU2XTsKICAgICAgICBjaGFyIGxpbmtfdGFyZ2V0WzUxMl07CiAgICAgICAgc3NpemVfdCBsZW47CiAgICAgICAgCiAgICAgICAgc25wcmludGYocHJvY19wYXRoLCBzaXplb2YocHJvY19wYXRoKSwgIi9wcm9jL3NlbGYvZmQvJWQiLCBmZCk7CiAgICAgICAgbGVuID0gcmVhZGxpbmsocHJvY19wYXRoLCBsaW5rX3RhcmdldCwgc2l6ZW9mKGxpbmtfdGFyZ2V0KSAtIDEpOwogICAgICAgIGlmIChsZW4gPiAwKSB7CiAgICAgICAgICAgIGxpbmtfdGFyZ2V0W2xlbl0gPSAnXDAnOwogICAgICAgICAgICAKICAgICAgICAgICAgZnByaW50ZihzdGRlcnIsICJbbGlidmdwdS1jdWRhXSBwcmVhZCgpIGludGVyY2VwdGVkIGZvciBQQ0kgZGV2aWNlIGZpbGU6ICVzIChwaWQ9JWQsIG9mZnNldD0lbGQpXG4iLAogICAgICAgICAgICAgICAgICAgIGxpbmtfdGFyZ2V0LCAoaW50KWdldHBpZCgpLCAobG9uZylvZmZzZXQpOwogICAgICAgICAgICBmZmx1c2goc3RkZXJyKTsKICAgICAgICAgICAgCiAgICAgICAgICAgIGlmIChzdHJzdHIobGlua190YXJnZXQsICIvdmVuZG9yIikgIT0gTlVMTCAmJiBvZmZzZXQgPT0gMCkgewogICAgICAgICAgICAgICAgaWYgKGNvdW50ID49IDYpIHsKICAgICAgICAgICAgICAgICAgICBzdHJuY3B5KChjaGFyICopYnVmLCAiMHgxMGRlXG4iLCBjb3VudCk7CiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIDY7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0gZWxzZSBpZiAoc3Ryc3RyKGxpbmtfdGFyZ2V0LCAiL2RldmljZSIpICE9IE5VTEwgJiYgb2Zmc2V0ID09IDApIHsKICAgICAgICAgICAgICAgIGlmIChjb3VudCA+PSA2KSB7CiAgICAgICAgICAgICAgICAgICAgc3RybmNweSgoY2hhciAqKWJ1ZiwgIjB4MjMzMVxuIiwgY291bnQpOwogICAgICAgICAgICAgICAgICAgIHJldHVybiA2OwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9IGVsc2UgaWYgKHN0cnN0cihsaW5rX3RhcmdldCwgIi9jbGFzcyIpICE9IE5VTEwgJiYgb2Zmc2V0ID09IDApIHsKICAgICAgICAgICAgICAgIGlmIChjb3VudCA+PSA4KSB7CiAgICAgICAgICAgICAgICAgICAgc3RybmNweSgoY2hhciAqKWJ1ZiwgIjB4MDMwMjAwXG4iLCBjb3VudCk7CiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIDg7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICB9CiAgICB9CiAgICAKICAgIHJldHVybiByZWFsX3ByZWFkID8gcmVhbF9wcmVhZChmZCwgYnVmLCBjb3VudCwgb2Zmc2V0KSA6IC0xOwp9CgovKiA9PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09CiAqIEZJTEUqIE9wZXJhdGlvbiBJbnRlcmNlcHRpb24gZm9yIFBDSSBEZXZpY2UgRmlsZXMKICoKICogQ1JJVElDQUw6IE9sbGFtYSBsaWtlbHkgdXNlcyBmcmVhZCgpL2ZnZXRzKCkgaW5zdGVhZCBvZiByZWFkKCkKICogZm9yIFBDSSBkZXZpY2UgZmlsZXMuIFdlIG5lZWQgdG8gaW50ZXJjZXB0IHRoZXNlIEZJTEUqIG9wZXJhdGlvbnMKICogdG8gZW5zdXJlIE9sbGFtYSBzZWVzIHRoZSBjb3JyZWN0IFBDSSBkZXZpY2UgdmFsdWVzLgogKiA9PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09ICovCgovKiBUcmFjayBvcGVuZWQgUENJIGRldmljZSBmaWxlcyAqLwojZGVmaW5lIE1BWF9UUkFDS0VEX0ZJTEVTIDY0CnN0YXRpYyBzdHJ1Y3QgewogICAgRklMRSAqZnA7CiAgICBjaGFyIHBhdGhbNTEyXTsKICAgIGludCBpc19wY2lfZGV2aWNlX2ZpbGU7Cn0gdHJhY2tlZF9maWxlc1tNQVhfVFJBQ0tFRF9GSUxFU107CnN0YXRpYyBpbnQgbnVtX3RyYWNrZWRfZmlsZXMgPSAwOwpzdGF0aWMgcHRocmVhZF9tdXRleF90IHRyYWNrZWRfZmlsZXNfbXV0ZXggPSBQVEhSRUFEX01VVEVYX0lOSVRJQUxJWkVSOwoKLyogRmxhZyB0byBkaXNhYmxlIGludGVyY2VwdGlvbiBkdXJpbmcgb3VyIG93biBkaXNjb3ZlcnkgKi8Kc3RhdGljIF9fdGhyZWFkIGludCBnX3NraXBfcGNpX2ludGVyY2VwdGlvbiA9IDA7CgovKiBGdW5jdGlvbiB0byBjaGVjayBpZiBjYWxsZXIgaXMgZnJvbSBvdXIgb3duIGNvZGUgKGN1ZGFfdHJhbnNwb3J0LmMpICovCnN0YXRpYyBpbnQgaXNfY2FsbGVyX2Zyb21fb3VyX2NvZGUodm9pZCkKewogICAgLyogQ2hlY2sgaWYgd2Ugc2hvdWxkIHNraXAgaW50ZXJjZXB0aW9uIC0gaWYgdGhlIGNhbGxlciBpcyBmcm9tIG91ciBvd24KICAgICAqIGRpc2NvdmVyeSBjb2RlLCB3ZSBuZWVkIHRvIGxldCBpdCByZWFkIHJlYWwgdmFsdWVzICovCiAgICB2b2lkICpjYWxsZXIgPSBfX2J1aWx0aW5fcmV0dXJuX2FkZHJlc3MoMSk7CiAgICBEbF9pbmZvIGluZm87CiAgICBpZiAoZGxhZGRyKGNhbGxlciwgJmluZm8pICYmIGluZm8uZGxpX2ZuYW1lKSB7CiAgICAgICAgaWYgKHN0cnN0cihpbmZvLmRsaV9mbmFtZSwgImxpYnZncHUiKSAhPSBOVUxMIHx8CiAgICAgICAgICAgIHN0cnN0cihpbmZvLmRsaV9mbmFtZSwgImN1ZGFfdHJhbnNwb3J0IikgIT0gTlVMTCkgewogICAgICAgICAgICByZXR1cm4gMTsgIC8qIENhbGxlciBpcyBmcm9tIG91ciBvd24gY29kZSAqLwogICAgICAgIH0KICAgIH0KICAgIHJldHVybiAwOwp9CgpzdGF0aWMgaW50IGlzX3BjaV9kZXZpY2VfZmlsZV9wYXRoKGNvbnN0IGNoYXIgKnBhdGgpCnsKICAgIGlmICghcGF0aCkgcmV0dXJuIDA7CiAgICBpZiAoc3Ryc3RyKHBhdGgsICIvc3lzL2J1cy9wY2kvZGV2aWNlcy8iKSAhPSBOVUxMKSB7CiAgICAgICAgaWYgKHN0cnN0cihwYXRoLCAiMDAwMDowMDowNS4wIikgIT0gTlVMTCB8fAogICAgICAgICAgICBzdHJzdHIocGF0aCwgIjAwOjA1LjAiKSAhPSBOVUxMKSB7CiAgICAgICAgICAgIGlmIChzdHJzdHIocGF0aCwgIi92ZW5kb3IiKSAhPSBOVUxMIHx8CiAgICAgICAgICAgICAgICBzdHJzdHIocGF0aCwgIi9kZXZpY2UiKSAhPSBOVUxMIHx8CiAgICAgICAgICAgICAgICBzdHJzdHIocGF0aCwgIi9jbGFzcyIpICE9IE5VTEwpIHsKICAgICAgICAgICAgICAgIHJldHVybiAxOwogICAgICAgICAgICB9CiAgICAgICAgfQogICAgfQogICAgcmV0dXJuIDA7Cn0KCnN0YXRpYyB2b2lkIHRyYWNrX2ZpbGUoRklMRSAqZnAsIGNvbnN0IGNoYXIgKnBhdGgpCnsKICAgIGlmICghZnAgfHwgbnVtX3RyYWNrZWRfZmlsZXMgPj0gTUFYX1RSQUNLRURfRklMRVMpIHJldHVybjsKICAgIAogICAgcHRocmVhZF9tdXRleF9sb2NrKCZ0cmFja2VkX2ZpbGVzX211dGV4KTsKICAgIC8qIENoZWNrIGlmIHRoaXMgRklMRSogaXMgYWxyZWFkeSB0cmFja2VkIC0gaWYgc28sIHVwZGF0ZSB0aGUgcGF0aCAqLwogICAgaW50IGZvdW5kID0gMDsKICAgIGludCBpOwogICAgZm9yIChpID0gMDsgaSA8IG51bV90cmFja2VkX2ZpbGVzOyBpKyspIHsKICAgICAgICBpZiAodHJhY2tlZF9maWxlc1tpXS5mcCA9PSBmcCkgewogICAgICAgICAgICAvKiBVcGRhdGUgZXhpc3RpbmcgZW50cnkgKi8KICAgICAgICAgICAgaWYgKHBhdGgpIHsKICAgICAgICAgICAgICAgIHN0cm5jcHkodHJhY2tlZF9maWxlc1tpXS5wYXRoLCBwYXRoLCBzaXplb2YodHJhY2tlZF9maWxlc1tpXS5wYXRoKSAtIDEpOwogICAgICAgICAgICAgICAgdHJhY2tlZF9maWxlc1tpXS5wYXRoW3NpemVvZih0cmFja2VkX2ZpbGVzW2ldLnBhdGgpIC0gMV0gPSAnXDAnOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHRyYWNrZWRfZmlsZXNbaV0uaXNfcGNpX2RldmljZV9maWxlID0gaXNfcGNpX2RldmljZV9maWxlX3BhdGgodHJhY2tlZF9maWxlc1tpXS5wYXRoKTsKICAgICAgICAgICAgZm91bmQgPSAxOwogICAgICAgICAgICBicmVhazsKICAgICAgICB9CiAgICB9CiAgICAKICAgIGlmICghZm91bmQpIHsKICAgICAgICAvKiBBZGQgbmV3IGVudHJ5ICovCiAgICAgICAgdHJhY2tlZF9maWxlc1tudW1fdHJhY2tlZF9maWxlc10uZnAgPSBmcDsKICAgICAgICBpZiAocGF0aCkgewogICAgICAgICAgICBzdHJuY3B5KHRyYWNrZWRfZmlsZXNbbnVtX3RyYWNrZWRfZmlsZXNdLnBhdGgsIHBhdGgsIAogICAgICAgICAgICAgICAgICAgIHNpemVvZih0cmFja2VkX2ZpbGVzW251bV90cmFja2VkX2ZpbGVzXS5wYXRoKSAtIDEpOwogICAgICAgICAgICB0cmFja2VkX2ZpbGVzW251bV90cmFja2VkX2ZpbGVzXS5wYXRoW3NpemVvZih0cmFja2VkX2ZpbGVzW251bV90cmFja2VkX2ZpbGVzXS5wYXRoKSAtIDFdID0gJ1wwJzsKICAgICAgICB9IGVsc2UgewogICAgICAgICAgICB0cmFja2VkX2ZpbGVzW251bV90cmFja2VkX2ZpbGVzXS5wYXRoWzBdID0gJ1wwJzsKICAgICAgICB9CiAgICAgICAgdHJhY2tlZF9maWxlc1tudW1fdHJhY2tlZF9maWxlc10uaXNfcGNpX2RldmljZV9maWxlID0gCiAgICAgICAgICAgIGlzX3BjaV9kZXZpY2VfZmlsZV9wYXRoKHRyYWNrZWRfZmlsZXNbbnVtX3RyYWNrZWRfZmlsZXNdLnBhdGgpOwogICAgICAgIG51bV90cmFja2VkX2ZpbGVzKys7CiAgICB9CiAgICBwdGhyZWFkX211dGV4X3VubG9jaygmdHJhY2tlZF9maWxlc19tdXRleCk7Cn0KCnN0YXRpYyBpbnQgaXNfdHJhY2tlZF9wY2lfZmlsZShGSUxFICpmcCkKewogICAgaW50IGk7CiAgICBwdGhyZWFkX211dGV4X2xvY2soJnRyYWNrZWRfZmlsZXNfbXV0ZXgpOwogICAgZm9yIChpID0gMDsgaSA8IG51bV90cmFja2VkX2ZpbGVzOyBpKyspIHsKICAgICAgICBpZiAodHJhY2tlZF9maWxlc1tpXS5mcCA9PSBmcCAmJiB0cmFja2VkX2ZpbGVzW2ldLmlzX3BjaV9kZXZpY2VfZmlsZSkgewogICAgICAgICAgICBwdGhyZWFkX211dGV4X3VubG9jaygmdHJhY2tlZF9maWxlc19tdXRleCk7CiAgICAgICAgICAgIHJldHVybiAxOwogICAgICAgIH0KICAgIH0KICAgIHB0aHJlYWRfbXV0ZXhfdW5sb2NrKCZ0cmFja2VkX2ZpbGVzX211dGV4KTsKICAgIHJldHVybiAwOwp9CgovKiBJbnRlcmNlcHQgZm9wZW4oKSB0byB0cmFjayBQQ0kgZGV2aWNlIGZpbGVzICovCkZJTEUgKmZvcGVuKGNvbnN0IGNoYXIgKnBhdGhuYW1lLCBjb25zdCBjaGFyICptb2RlKQp7CiAgICBzdGF0aWMgRklMRSAqKCpyZWFsX2ZvcGVuKShjb25zdCBjaGFyICosIGNvbnN0IGNoYXIgKikgPSBOVUxMOwogICAgaWYgKCFyZWFsX2ZvcGVuKSB7CiAgICAgICAgcmVhbF9mb3BlbiA9IChGSUxFICooKikoY29uc3QgY2hhciAqLCBjb25zdCBjaGFyICopKQogICAgICAgICAgICAgICAgICAgICBkbHN5bShSVExEX05FWFQsICJmb3BlbiIpOwogICAgfQogICAgCiAgICBGSUxFICpmcCA9IHJlYWxfZm9wZW4gPyByZWFsX2ZvcGVuKHBhdGhuYW1lLCBtb2RlKSA6IE5VTEw7CiAgICAKICAgIC8qIENSSVRJQ0FMOiBDaGVjayBwcm9jZXNzIHR5cGUgRklSU1QgLSBvbmx5IGludGVyY2VwdCBmb3IgYXBwbGljYXRpb24gcHJvY2Vzc2VzICovCiAgICBpZiAoIWlzX2FwcGxpY2F0aW9uX3Byb2Nlc3MoKSkgewogICAgICAgIHJldHVybiBmcDsKICAgIH0KICAgIAogICAgLyogU2tpcCBpbnRlcmNlcHRpb24gaWYgY2FsbGVyIGlzIGZyb20gb3VyIG93biBjb2RlICovCiAgICBpZiAoZnAgJiYgaXNfcGNpX2RldmljZV9maWxlX3BhdGgocGF0aG5hbWUpICYmICFpc19jYWxsZXJfZnJvbV9vdXJfY29kZSgpKSB7CiAgICAgICAgc3RydWN0IHRpbWVzcGVjIHRzOwogICAgICAgIGNsb2NrX2dldHRpbWUoQ0xPQ0tfUkVBTFRJTUUsICZ0cyk7CiAgICAgICAgZnByaW50ZihzdGRlcnIsICJbbGlidmdwdS1jdWRhXSBbJWxkLiUwOWxkXSBmb3BlbihcIiVzXCIsIFwiJXNcIikgaW50ZXJjZXB0ZWQgZm9yIFBDSSBkZXZpY2UgZmlsZSAocGlkPSVkLCBmcD0lcClcbiIsCiAgICAgICAgICAgICAgICAobG9uZyl0cy50dl9zZWMsIHRzLnR2X25zZWMsIHBhdGhuYW1lLCBtb2RlLCAoaW50KWdldHBpZCgpLCAodm9pZCopZnApOwogICAgICAgIGZmbHVzaChzdGRlcnIpOwogICAgICAgIHRyYWNrX2ZpbGUoZnAsIHBhdGhuYW1lKTsKICAgICAgICAvKiBWZXJpZnkgdHJhY2tpbmcgKi8KICAgICAgICBwdGhyZWFkX211dGV4X2xvY2soJnRyYWNrZWRfZmlsZXNfbXV0ZXgpOwogICAgICAgIGlmIChudW1fdHJhY2tlZF9maWxlcyA+IDAgJiYgdHJhY2tlZF9maWxlc1tudW1fdHJhY2tlZF9maWxlcy0xXS5mcCA9PSBmcCkgewogICAgICAgICAgICBmcHJpbnRmKHN0ZGVyciwgIltsaWJ2Z3B1LWN1ZGFdIFRyYWNrZWQ6IGZwPSVwIHBhdGg9JXNcbiIsICh2b2lkKilmcCwgdHJhY2tlZF9maWxlc1tudW1fdHJhY2tlZF9maWxlcy0xXS5wYXRoKTsKICAgICAgICAgICAgZmZsdXNoKHN0ZGVycik7CiAgICAgICAgfQogICAgICAgIHB0aHJlYWRfbXV0ZXhfdW5sb2NrKCZ0cmFja2VkX2ZpbGVzX211dGV4KTsKICAgIH0KICAgIAogICAgcmV0dXJuIGZwOwp9CgovKiBJbnRlcmNlcHQgZnJlYWQoKSBmb3IgUENJIGRldmljZSBmaWxlcyAqLwpzaXplX3QgZnJlYWQodm9pZCAqcHRyLCBzaXplX3Qgc2l6ZSwgc2l6ZV90IG5tZW1iLCBGSUxFICpzdHJlYW0pCnsKICAgIHN0YXRpYyBzaXplX3QgKCpyZWFsX2ZyZWFkKSh2b2lkICosIHNpemVfdCwgc2l6ZV90LCBGSUxFICopID0gTlVMTDsKICAgIGlmICghcmVhbF9mcmVhZCkgewogICAgICAgIHJlYWxfZnJlYWQgPSAoc2l6ZV90ICgqKSh2b2lkICosIHNpemVfdCwgc2l6ZV90LCBGSUxFICopKQogICAgICAgICAgICAgICAgICAgICBkbHN5bShSVExEX05FWFQsICJmcmVhZCIpOwogICAgfQogICAgCiAgICAvKiBDUklUSUNBTDogQ2hlY2sgcHJvY2VzcyB0eXBlIEZJUlNUIC0gb25seSBpbnRlcmNlcHQgZm9yIGFwcGxpY2F0aW9uIHByb2Nlc3NlcyAqLwogICAgaWYgKCFpc19hcHBsaWNhdGlvbl9wcm9jZXNzKCkpIHsKICAgICAgICByZXR1cm4gcmVhbF9mcmVhZCA/IHJlYWxfZnJlYWQocHRyLCBzaXplLCBubWVtYiwgc3RyZWFtKSA6IDA7CiAgICB9CiAgICAKICAgIC8qIFNraXAgaW50ZXJjZXB0aW9uIGlmIGNhbGxlciBpcyBmcm9tIG91ciBvd24gY29kZSAqLwogICAgaWYgKGlzX3RyYWNrZWRfcGNpX2ZpbGUoc3RyZWFtKSAmJiAhaXNfY2FsbGVyX2Zyb21fb3VyX2NvZGUoKSkgewogICAgICAgIGNoYXIgcGF0aFs1MTJdID0gIiI7CiAgICAgICAgaW50IGk7CiAgICAgICAgCiAgICAgICAgcHRocmVhZF9tdXRleF9sb2NrKCZ0cmFja2VkX2ZpbGVzX211dGV4KTsKICAgICAgICAvKiBTZWFyY2ggZnJvbSB0aGUgZW5kIHRvIGZpbmQgdGhlIG1vc3QgcmVjZW50IG1hdGNoIChpbiBjYXNlIEZJTEUqIGlzIHJldXNlZCkgKi8KICAgICAgICBmb3IgKGkgPSBudW1fdHJhY2tlZF9maWxlcyAtIDE7IGkgPj0gMDsgaS0tKSB7CiAgICAgICAgICAgIGlmICh0cmFja2VkX2ZpbGVzW2ldLmZwID09IHN0cmVhbSkgewogICAgICAgICAgICAgICAgc3RybmNweShwYXRoLCB0cmFja2VkX2ZpbGVzW2ldLnBhdGgsIHNpemVvZihwYXRoKSAtIDEpOwogICAgICAgICAgICAgICAgcGF0aFtzaXplb2YocGF0aCkgLSAxXSA9ICdcMCc7CiAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBwdGhyZWFkX211dGV4X3VubG9jaygmdHJhY2tlZF9maWxlc19tdXRleCk7CiAgICAgICAgCiAgICAgICAgaWYgKHBhdGhbMF0gIT0gJ1wwJykgewogICAgICAgICAgICBmcHJpbnRmKHN0ZGVyciwgIltsaWJ2Z3B1LWN1ZGFdIGZyZWFkKCkgaW50ZXJjZXB0ZWQgZm9yIFBDSSBkZXZpY2UgZmlsZTogJXMgKHBpZD0lZCwgc2l6ZT0lenUsIG5tZW1iPSV6dSlcbiIsCiAgICAgICAgICAgICAgICAgICAgcGF0aCwgKGludClnZXRwaWQoKSwgc2l6ZSwgbm1lbWIpOwogICAgICAgICAgICBmZmx1c2goc3RkZXJyKTsKICAgICAgICAgICAgCiAgICAgICAgICAgIC8qIFJldHVybiBhcHByb3ByaWF0ZSB2YWx1ZSBiYXNlZCBvbiBmaWxlIHR5cGUgKi8KICAgICAgICAgICAgaWYgKHN0cnN0cihwYXRoLCAiL3ZlbmRvciIpICE9IE5VTEwpIHsKICAgICAgICAgICAgaWYgKHNpemUgKiBubWVtYiA+PSA2KSB7CiAgICAgICAgICAgICAgICBzdHJuY3B5KChjaGFyICopcHRyLCAiMHgxMGRlXG4iLCBzaXplICogbm1lbWIpOwogICAgICAgICAgICAgICAgZnByaW50ZihzdGRlcnIsICJbbGlidmdwdS1jdWRhXSBmcmVhZDogcmV0dXJuaW5nIHZlbmRvcj0weDEwZGUgKE5WSURJQSlcbiIpOwogICAgICAgICAgICAgICAgZmZsdXNoKHN0ZGVycik7CiAgICAgICAgICAgICAgICByZXR1cm4gMTsgIC8qIFJldHVybiAxIGVsZW1lbnQgcmVhZCAqLwogICAgICAgICAgICB9CiAgICAgICAgfSBlbHNlIGlmIChzdHJzdHIocGF0aCwgIi9kZXZpY2UiKSAhPSBOVUxMKSB7CiAgICAgICAgICAgIGlmIChzaXplICogbm1lbWIgPj0gNikgewogICAgICAgICAgICAgICAgc3RybmNweSgoY2hhciAqKXB0ciwgIjB4MjMzMVxuIiwgc2l6ZSAqIG5tZW1iKTsKICAgICAgICAgICAgICAgIGZwcmludGYoc3RkZXJyLCAiW2xpYnZncHUtY3VkYV0gZnJlYWQ6IHJldHVybmluZyBkZXZpY2U9MHgyMzMxIChIMTAwIFBDSWUpXG4iKTsKICAgICAgICAgICAgICAgIGZmbHVzaChzdGRlcnIpOwogICAgICAgICAgICAgICAgcmV0dXJuIDE7CiAgICAgICAgICAgIH0KICAgICAgICB9IGVsc2UgaWYgKHN0cnN0cihwYXRoLCAiL2NsYXNzIikgIT0gTlVMTCkgewogICAgICAgICAgICBpZiAoc2l6ZSAqIG5tZW1iID49IDgpIHsKICAgICAgICAgICAgICAgIHN0cm5jcHkoKGNoYXIgKilwdHIsICIweDAzMDIwMFxuIiwgc2l6ZSAqIG5tZW1iKTsKICAgICAgICAgICAgICAgIGZwcmludGYoc3RkZXJyLCAiW2xpYnZncHUtY3VkYV0gZnJlYWQ6IHJldHVybmluZyBjbGFzcz0weDAzMDIwMCAoM0QgY29udHJvbGxlcilcbiIpOwogICAgICAgICAgICAgICAgZmZsdXNoKHN0ZGVycik7CiAgICAgICAgICAgICAgICByZXR1cm4gMTsKICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgfQogICAgfQogICAgCiAgICByZXR1cm4gcmVhbF9mcmVhZCA/IHJlYWxfZnJlYWQocHRyLCBzaXplLCBubWVtYiwgc3RyZWFtKSA6IDA7Cn0KCi8qIEludGVyY2VwdCBmZ2V0cygpIGZvciBQQ0kgZGV2aWNlIGZpbGVzICovCmNoYXIgKmZnZXRzKGNoYXIgKnMsIGludCBzaXplLCBGSUxFICpzdHJlYW0pCnsKICAgIHN0YXRpYyBjaGFyICooKnJlYWxfZmdldHMpKGNoYXIgKiwgaW50LCBGSUxFICopID0gTlVMTDsKICAgIGlmICghcmVhbF9mZ2V0cykgewogICAgICAgIHJlYWxfZmdldHMgPSAoY2hhciAqKCopKGNoYXIgKiwgaW50LCBGSUxFICopKQogICAgICAgICAgICAgICAgICAgICBkbHN5bShSVExEX05FWFQsICJmZ2V0cyIpOwogICAgfQogICAgCiAgICAvKiBDUklUSUNBTDogQ2hlY2sgcHJvY2VzcyB0eXBlIEZJUlNUIC0gb25seSBpbnRlcmNlcHQgZm9yIGFwcGxpY2F0aW9uIHByb2Nlc3NlcyAqLwogICAgaWYgKCFpc19hcHBsaWNhdGlvbl9wcm9jZXNzKCkpIHsKICAgICAgICByZXR1cm4gcmVhbF9mZ2V0cyA/IHJlYWxfZmdldHMocywgc2l6ZSwgc3RyZWFtKSA6IE5VTEw7CiAgICB9CiAgICAKICAgIC8qIFNraXAgaW50ZXJjZXB0aW9uIGlmIGNhbGxlciBpcyBmcm9tIG91ciBvd24gY29kZSAqLwogICAgaWYgKGlzX3RyYWNrZWRfcGNpX2ZpbGUoc3RyZWFtKSAmJiAhaXNfY2FsbGVyX2Zyb21fb3VyX2NvZGUoKSkgewogICAgICAgIGNoYXIgcGF0aFs1MTJdID0gIiI7CiAgICAgICAgaW50IGk7CiAgICAgICAgCiAgICAgICAgcHRocmVhZF9tdXRleF9sb2NrKCZ0cmFja2VkX2ZpbGVzX211dGV4KTsKICAgICAgICAvKiBTZWFyY2ggZnJvbSB0aGUgZW5kIHRvIGZpbmQgdGhlIG1vc3QgcmVjZW50IG1hdGNoIChpbiBjYXNlIEZJTEUqIGlzIHJldXNlZCkgKi8KICAgICAgICBmb3IgKGkgPSBudW1fdHJhY2tlZF9maWxlcyAtIDE7IGkgPj0gMDsgaS0tKSB7CiAgICAgICAgICAgIGlmICh0cmFja2VkX2ZpbGVzW2ldLmZwID09IHN0cmVhbSkgewogICAgICAgICAgICAgICAgc3RybmNweShwYXRoLCB0cmFja2VkX2ZpbGVzW2ldLnBhdGgsIHNpemVvZihwYXRoKSAtIDEpOwogICAgICAgICAgICAgICAgcGF0aFtzaXplb2YocGF0aCkgLSAxXSA9ICdcMCc7CiAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBwdGhyZWFkX211dGV4X3VubG9jaygmdHJhY2tlZF9maWxlc19tdXRleCk7CiAgICAgICAgCiAgICAgICAgaWYgKHBhdGhbMF0gIT0gJ1wwJykgewogICAgICAgICAgICBmcHJpbnRmKHN0ZGVyciwgIltsaWJ2Z3B1LWN1ZGFdIGZnZXRzKCkgaW50ZXJjZXB0ZWQgZm9yIFBDSSBkZXZpY2UgZmlsZTogJXMgKHBpZD0lZCwgc2l6ZT0lZCwgZnA9JXApXG4iLAogICAgICAgICAgICAgICAgICAgIHBhdGgsIChpbnQpZ2V0cGlkKCksIHNpemUsICh2b2lkKilzdHJlYW0pOwogICAgICAgICAgICBmZmx1c2goc3RkZXJyKTsKICAgICAgICAgICAgCiAgICAgICAgICAgIC8qIFJldHVybiBhcHByb3ByaWF0ZSB2YWx1ZSBiYXNlZCBvbiBmaWxlIHR5cGUgKi8KICAgICAgICAgICAgaWYgKHN0cnN0cihwYXRoLCAiL3ZlbmRvciIpICE9IE5VTEwpIHsKICAgICAgICAgICAgICAgIGlmIChzaXplID49IDcpIHsKICAgICAgICAgICAgICAgICAgICBzdHJuY3B5KHMsICIweDEwZGVcbiIsIHNpemUgLSAxKTsKICAgICAgICAgICAgICAgICAgICBzW3NpemUgLSAxXSA9ICdcMCc7CiAgICAgICAgICAgICAgICAgICAgZnByaW50ZihzdGRlcnIsICJbbGlidmdwdS1jdWRhXSBmZ2V0czogcmV0dXJuaW5nIHZlbmRvcj0weDEwZGUgKE5WSURJQSlcbiIpOwogICAgICAgICAgICAgICAgICAgIGZmbHVzaChzdGRlcnIpOwogICAgICAgICAgICAgICAgICAgIHJldHVybiBzOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9IGVsc2UgaWYgKHN0cnN0cihwYXRoLCAiL2RldmljZSIpICE9IE5VTEwpIHsKICAgICAgICAgICAgICAgIGlmIChzaXplID49IDcpIHsKICAgICAgICAgICAgICAgICAgICBzdHJuY3B5KHMsICIweDIzMzFcbiIsIHNpemUgLSAxKTsKICAgICAgICAgICAgICAgICAgICBzW3NpemUgLSAxXSA9ICdcMCc7CiAgICAgICAgICAgICAgICAgICAgZnByaW50ZihzdGRlcnIsICJbbGlidmdwdS1jdWRhXSBmZ2V0czogcmV0dXJuaW5nIGRldmljZT0weDIzMzEgKEgxMDAgUENJZSlcbiIpOwogICAgICAgICAgICAgICAgICAgIGZmbHVzaChzdGRlcnIpOwogICAgICAgICAgICAgICAgICAgIHJldHVybiBzOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9IGVsc2UgaWYgKHN0cnN0cihwYXRoLCAiL2NsYXNzIikgIT0gTlVMTCkgewogICAgICAgICAgICAgICAgaWYgKHNpemUgPj0gOSkgewogICAgICAgICAgICAgICAgICAgIHN0cm5jcHkocywgIjB4MDMwMjAwXG4iLCBzaXplIC0gMSk7CiAgICAgICAgICAgICAgICAgICAgc1tzaXplIC0gMV0gPSAnXDAnOwogICAgICAgICAgICAgICAgICAgIGZwcmludGYoc3RkZXJyLCAiW2xpYnZncHUtY3VkYV0gZmdldHM6IHJldHVybmluZyBjbGFzcz0weDAzMDIwMCAoM0QgY29udHJvbGxlcilcbiIpOwogICAgICAgICAgICAgICAgICAgIGZmbHVzaChzdGRlcnIpOwogICAgICAgICAgICAgICAgICAgIHJldHVybiBzOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgfQogICAgfQogICAgCiAgICByZXR1cm4gcmVhbF9mZ2V0cyA/IHJlYWxfZmdldHMocywgc2l6ZSwgc3RyZWFtKSA6IE5VTEw7Cn0KCi8qID09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT0KICogQ1VEQSB0eXBlcyDigJQgbWluaW1hbCBkZWZpbml0aW9ucyBzbyB3ZSBjYW4gY29tcGlsZSB3aXRob3V0IHRoZQogKiByZWFsIENVREEgaGVhZGVycy4gIFRoZXNlIG11c3QgYmUgQUJJLWNvbXBhdGlibGUgd2l0aCBOVklESUEncwogKiBkZWZpbml0aW9ucy4KICogPT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PSAqLwoKdHlwZWRlZiBpbnQgICAgICAgICAgQ1VyZXN1bHQ7CnR5cGVkZWYgaW50ICAgICAgICAgIENVZGV2aWNlOwp0eXBlZGVmIHZvaWQgKiAgICAgICBDVWNvbnRleHQ7CnR5cGVkZWYgdm9pZCAqICAgICAgIENVbW9kdWxlOwp0eXBlZGVmIHZvaWQgKiAgICAgICBDVWZ1bmN0aW9uOwp0eXBlZGVmIHZvaWQgKiAgICAgICBDVXN0cmVhbTsKdHlwZWRlZiB2b2lkICogICAgICAgQ1VldmVudDsKdHlwZWRlZiB2b2lkICogICAgICAgQ1VtZW1vcnlQb29sOwp0eXBlZGVmIHVuc2lnbmVkIGxvbmcgbG9uZyBDVWRldmljZXB0cjsKdHlwZWRlZiBzaXplX3QgICAgICAgQ1VzaXplX3Q7CgovKiBDVWRldnByb3AgLSBMZWdhY3kgZGV2aWNlIHByb3BlcnRpZXMgc3RydWN0dXJlIChmb3IgY3VEZXZpY2VHZXRQcm9wZXJ0aWVzKSAqLwp0eXBlZGVmIHN0cnVjdCB7CiAgICBpbnQgbWFqb3I7CiAgICBpbnQgbWlub3I7CiAgICBjaGFyIG5hbWVbMjU2XTsKICAgIHNpemVfdCB0b3RhbEdsb2JhbE1lbTsKICAgIGludCBtdWx0aXByb2Nlc3NvckNvdW50OwogICAgaW50IG1heFRocmVhZHNQZXJCbG9jazsKICAgIGludCBtYXhUaHJlYWRzUGVyTXVsdGlwcm9jZXNzb3I7CiAgICBpbnQg
c2hhcmVkTWVtUGVyQmxvY2s7CiAgICBpbnQgcmVnc1BlckJsb2NrOwogICAgaW50IHdhcnBTaXplOwogICAgaW50IGNsb2NrUmF0ZTsKICAgIGludCBtZW1vcnlDbG9ja1JhdGU7CiAgICBpbnQgbWVtb3J5QnVzV2lkdGg7CiAgICBpbnQgdG90YWxDb25zdE1lbTsKICAgIGludCB0ZXh0dXJlQWxpZ25tZW50OwogICAgaW50IGRldmljZU92ZXJsYXA7CiAgICBpbnQgbXVsdGlQcm9jZXNzb3JDb3VudDsKfSBDVWRldnByb3A7CnR5cGVkZWYgdW5zaWduZWQgbG9uZyBsb25nIGN1dWludDY0X3Q7CgovKiBDVURBIFZpcnR1YWwgTWVtb3J5IE1hbmFnZW1lbnQgKFZNTSkgdHlwZXMgKi8KdHlwZWRlZiB2b2lkICogQ1VtZW1HZW5lcmljQWxsb2NhdGlvbkhhbmRsZTsKdHlwZWRlZiBzdHJ1Y3QgQ1VtZW1BbGxvY2F0aW9uUHJvcCBDVW1lbUFsbG9jYXRpb25Qcm9wOwp0eXBlZGVmIHN0cnVjdCBDVW1lbUFjY2Vzc0Rlc2MgQ1VtZW1BY2Nlc3NEZXNjOwoKLyogQ1VyZXN1bHQgY29uc3RhbnRzICovCiNkZWZpbmUgQ1VEQV9TVUNDRVNTICAgICAgICAgICAgICAgICAgICAgICAgMAojZGVmaW5lIENVREFfRVJST1JfSU5WQUxJRF9WQUxVRSAgICAgICAgICAgIDEKI2RlZmluZSBDVURBX0VSUk9SX09VVF9PRl9NRU1PUlkgICAgICAgICAgICAyCiNkZWZpbmUgQ1VEQV9FUlJPUl9OT1RfSU5JVElBTElaRUQgICAgICAgICAgMwojZGVmaW5lIENVREFfRVJST1JfREVJTklUSUFMSVpFRCAgICAgICAgICAgIDQKI2RlZmluZSBDVURBX0VSUk9SX05PX0RFVklDRSAgICAgICAgICAgICAgICAxMDAKI2RlZmluZSBDVURBX0VSUk9SX0lOVkFMSURfREVWSUNFICAgICAgICAgICAxMDEKI2RlZmluZSBDVURBX0VSUk9SX0lOVkFMSURfQ09OVEVYVCAgICAgICAgICAyMDEKI2RlZmluZSBDVURBX0VSUk9SX05PVF9GT1VORCAgICAgICAgICAgICAgICA1MDAKI2RlZmluZSBDVURBX0VSUk9SX05PVF9TVVBQT1JURUQgICAgICAgICAgICA4MDEKI2RlZmluZSBDVURBX0VSUk9SX1VOS05PV04gICAgICAgICAgICAgICAgICA5OTkKCi8qIEdsb2JhbCBmbGFnIHRvIHRyYWNrIGlmIHdlJ3JlIGluIGluaXRpYWxpemF0aW9uIHBoYXNlICovCnN0YXRpYyBpbnQgZ19pbl9pbml0X3BoYXNlID0gMTsgIC8qIFN0YXJ0IGFzIHRydWUsIHNldCB0byAwIGFmdGVyIGZpcnN0IHN1Y2Nlc3NmdWwgY29udGV4dCBjcmVhdGlvbiAqLwoKLyogQ1VkZXZpY2VfYXR0cmlidXRlIChzdWJzZXQg4oCUIG9ubHkgd2hhdCBPbGxhbWEgLyBsbGFtYS5jcHAgbmVlZHMpICovCnR5cGVkZWYgZW51bSB7CiAgICBDVV9ERVZJQ0VfQVRUUklCVVRFX01BWF9USFJFQURTX1BFUl9CTE9DSyAgICAgICAgICAgICAgICA9IDEsCiAgICBDVV9ERVZJQ0VfQVRUUklCVVRFX01BWF9CTE9DS19ESU1fWCAgICAgICAgICAgICAgICAgICAgICA9IDIsCiAgICBDVV9ERVZJQ0VfQVRUUklCVVRFX01BWF9CTE9DS19ESU1fWSAgICAgICAgICAgICAgICAgICAgICA9IDMsCiAgICBDVV9ERVZJQ0VfQVRUUklCVVRFX01BWF9CTE9DS19ESU1fWiAgICAgICAgICAgICAgICAgICAgICA9IDQsCiAgICBDVV9ERVZJQ0VfQVRUUklCVVRFX01BWF9HUklEX0RJTV9YICAgICAgICAgICAgICAgICAgICAgICA9IDUsCiAgICBDVV9ERVZJQ0VfQVRUUklCVVRFX01BWF9HUklEX0RJTV9ZICAgICAgICAgICAgICAgICAgICAgICA9IDYsCiAgICBDVV9ERVZJQ0VfQVRUUklCVVRFX01BWF9HUklEX0RJTV9aICAgICAgICAgICAgICAgICAgICAgICA9IDcsCiAgICBDVV9ERVZJQ0VfQVRUUklCVVRFX01BWF9TSEFSRURfTUVNT1JZX1BFUl9CTE9DSyAgICAgICAgICA9IDgsCiAgICBDVV9ERVZJQ0VfQVRUUklCVVRFX1RPVEFMX0NPTlNUQU5UX01FTU9SWSAgICAgICAgICAgICAgICA9IDksCiAgICBDVV9ERVZJQ0VfQVRUUklCVVRFX1dBUlBfU0laRSAgICAgICAgICAgICAgICAgICAgICAgICAgICA9IDEwLAogICAgQ1VfREVWSUNFX0FUVFJJQlVURV9NQVhfUElUQ0ggICAgICAgICAgICAgICAgICAgICAgICAgICAgPSAxMSwKICAgIENVX0RFVklDRV9BVFRSSUJVVEVfTUFYX1JFR0lTVEVSU19QRVJfQkxPQ0sgICAgICAgICAgICAgID0gMTIsCiAgICBDVV9ERVZJQ0VfQVRUUklCVVRFX0NMT0NLX1JBVEUgICAgICAgICAgICAgICAgICAgICAgICAgICA9IDEzLAogICAgQ1VfREVWSUNFX0FUVFJJQlVURV9URVhUVVJFX0FMSUdOTUVOVCAgICAgICAgICAgICAgICAgICAgPSAxNCwKICAgIENVX0RFVklDRV9BVFRSSUJVVEVfTVVMVElQUk9DRVNTT1JfQ09VTlQgICAgICAgICAgICAgICAgID0gMTYsCiAgICBDVV9ERVZJQ0VfQVRUUklCVVRFX0tFUk5FTF9FWEVDX1RJTUVPVVQgICAgICAgICAgICAgICAgICA9IDE3LAogICAgQ1VfREVWSUNFX0FUVFJJQlVURV9JTlRFR1JBVEVEICAgICAgICAgICAgICAgICAgICAgICAgICAgPSAxOCwKICAgIENVX0RFVklDRV9BVFRSSUJVVEVfQ0FOX01BUF9IT1NUX01FTU9SWSAgICAgICAgICAgICAgICAgID0gMTksCiAgICBDVV9ERVZJQ0VfQVRUUklCVVRFX0NPTVBVVEVfTU9ERSAgICAgICAgICAgICAgICAgICAgICAgICA9IDIwLAogICAgQ1VfREVWSUNFX0FUVFJJQlVURV9NQVhfVEVYVFVSRTFEX1dJRFRIICAgICAgICAgICAgICAgICAgPSAyMSwKICAgIENVX0RFVklDRV9BVFRSSUJVVEVfTUFYX1RFWFRVUkUyRF9XSURUSCAgICAgICAgICAgICAgICAgID0gMjIsCiAgICBDVV9ERVZJQ0VfQVRUUklCVVRFX01BWF9URVhUVVJFMkRfSEVJR0hUICAgICAgICAgICAgICAgICA9IDIzLAogICAgQ1VfREVWSUNFX0FUVFJJQlVURV9NQVhfVEVYVFVSRTNEX1dJRFRIICAgICAgICAgICAgICAgICAgPSAyNCwKICAgIENVX0RFVklDRV9BVFRSSUJVVEVfTUFYX1RFWFRVUkUzRF9IRUlHSFQgICAgICAgICAgICAgICAgID0gMjUsCiAgICBDVV9ERVZJQ0VfQVRUUklCVVRFX01BWF9URVhUVVJFM0RfREVQVEggICAgICAgICAgICAgICAgICA9IDI2LAogICAgQ1VfREVWSUNFX0FUVFJJQlVURV9DT05DVVJSRU5UX0tFUk5FTFMgICAgICAgICAgICAgICAgICAgPSAzMSwKICAgIENVX0RFVklDRV9BVFRSSUJVVEVfRUNDX0VOQUJMRUQgICAgICAgICAgICAgICAgICAgICAgICAgID0gMzIsCiAgICBDVV9ERVZJQ0VfQVRUUklCVVRFX1BDSV9CVVNfSUQgICAgICAgICAgICAgICAgICAgICAgICAgICA9IDMzLAogICAgQ1VfREVWSUNFX0FUVFJJQlVURV9QQ0lfREVWSUNFX0lEICAgICAgICAgICAgICAgICAgICAgICAgPSAzNCwKICAgIENVX0RFVklDRV9BVFRSSUJVVEVfTUVNT1JZX0NMT0NLX1JBVEUgICAgICAgICAgICAgICAgICAgID0gMzYsCiAgICBDVV9ERVZJQ0VfQVRUUklCVVRFX0dMT0JBTF9NRU1PUllfQlVTX1dJRFRIICAgICAgICAgICAgICA9IDM3LAogICAgQ1VfREVWSUNFX0FUVFJJQlVURV9MMl9DQUNIRV9TSVpFICAgICAgICAgICAgICAgICAgICAgICAgPSAzOCwKICAgIENVX0RFVklDRV9BVFRSSUJVVEVfTUFYX1RIUkVBRFNfUEVSX01VTFRJUFJPQ0VTU09SICAgICAgID0gMzksCiAgICBDVV9ERVZJQ0VfQVRUUklCVVRFX0FTWU5DX0VOR0lORV9DT1VOVCAgICAgICAgICAgICAgICAgICA9IDQwLAogICAgQ1VfREVWSUNFX0FUVFJJQlVURV9VTklGSUVEX0FERFJFU1NJTkcgICAgICAgICAgICAgICAgICAgPSA0MSwKICAgIENVX0RFVklDRV9BVFRSSUJVVEVfUENJX0RPTUFJTl9JRCAgICAgICAgICAgICAgICAgICAgICAgID0gNTAsCiAgICBDVV9ERVZJQ0VfQVRUUklCVVRFX0NPTVBVVEVfQ0FQQUJJTElUWV9NQUpPUiAgICAgICAgICAgICA9IDc1LAogICAgQ1VfREVWSUNFX0FUVFJJQlVURV9DT01QVVRFX0NBUEFCSUxJVFlfTUlOT1IgICAgICAgICAgICAgPSA3NiwKICAgIENVX0RFVklDRV9BVFRSSUJVVEVfTUFOQUdFRF9NRU1PUlkgICAgICAgICAgICAgICAgICAgICAgID0gODMsCiAgICBDVV9ERVZJQ0VfQVRUUklCVVRFX01VTFRJX0dQVV9CT0FSRCAgICAgICAgICAgICAgICAgICAgICA9IDg0LAogICAgQ1VfREVWSUNFX0FUVFJJQlVURV9DT09QRVJBVElWRV9MQVVOQ0ggICAgICAgICAgICAgICAgICAgPSA5NSwKICAgIENVX0RFVklDRV9BVFRSSUJVVEVfTUFYX1NIQVJFRF9NRU1PUllfUEVSX01VTFRJUFJPQ0VTU09SID0gODEsCiAgICBDVV9ERVZJQ0VfQVRUUklCVVRFX01BWF9SRUdJU1RFUlNfUEVSX01VTFRJUFJPQ0VTU09SICAgICA9IDgyLAogICAgQ1VfREVWSUNFX0FUVFJJQlVURV9NQVhfU0hBUkVEX01FTU9SWV9QRVJfQkxPQ0tfT1BUSU4gICAgPSA5NywKICAgIENVX0RFVklDRV9BVFRSSUJVVEVfR0xPQkFMX0wxX0NBQ0hFX1NVUFBPUlRFRCAgICAgICAgICAgID0gOTEsCiAgICBDVV9ERVZJQ0VfQVRUUklCVVRFX0xPQ0FMX0wxX0NBQ0hFX1NVUFBPUlRFRCAgICAgICAgICAgICA9IDkyLAogICAgQ1VfREVWSUNFX0FUVFJJQlVURV9NQVggICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgPSAyMDAsCn0gQ1VkZXZpY2VfYXR0cmlidXRlOwoKLyogQ1VfQ1RYX1NDSEVEIGZsYWdzICovCiNkZWZpbmUgQ1VfQ1RYX1NDSEVEX0FVVE8gICAgICAgIDAKI2RlZmluZSBDVV9DVFhfTUFQX0hPU1QgICAgICAgICAgMHgwOAoKLyogQ1VfU1RSRUFNIGZsYWdzICovCiNkZWZpbmUgQ1VfU1RSRUFNX0RFRkFVTFQgICAgICAgIDB4MDAKI2RlZmluZSBDVV9TVFJFQU1fTk9OX0JMT0NLSU5HICAgMHgwMQoKLyogQ1VfRVZFTlQgZmxhZ3MgKi8KI2RlZmluZSBDVV9FVkVOVF9ERUZBVUxUICAgICAgICAgMHgwMAojZGVmaW5lIENVX0VWRU5UX0JMT0NLSU5HX1NZTkMgICAweDAxCiNkZWZpbmUgQ1VfRVZFTlRfRElTQUJMRV9USU1JTkcgIDB4MDIKCi8qIEZvcndhcmQgZGVjbGFyYXRpb25zIOKAlCB2ZXJzaW9uZWQgQVBJIHdyYXBwZXJzICovCkNVcmVzdWx0IGN1RGV2aWNlUHJpbWFyeUN0eFJlbGVhc2VfdjIoQ1VkZXZpY2UgZGV2KTsKQ1VyZXN1bHQgY3VEZXZpY2VQcmltYXJ5Q3R4UmVzZXRfdjIoQ1VkZXZpY2UgZGV2KTsKQ1VyZXN1bHQgY3VEZXZpY2VQcmltYXJ5Q3R4U2V0RmxhZ3NfdjIoQ1VkZXZpY2UgZGV2LCB1bnNpZ25lZCBpbnQgZmxhZ3MpOwoKLyogRm9yd2FyZCBkZWNsYXJhdGlvbnMgZm9yIGNvbnRleHQgZnVuY3Rpb25zIHVzZWQgaW4gY3VHZXRQcm9jQWRkcmVzcyAqLwpDVXJlc3VsdCBjdUN0eENyZWF0ZShDVWNvbnRleHQgKnBjdHgsIHVuc2lnbmVkIGludCBmbGFncywgQ1VkZXZpY2UgZGV2KTsKQ1VyZXN1bHQgY3VDdHhDcmVhdGVfdjIoQ1Vjb250ZXh0ICpwY3R4LCB1bnNpZ25lZCBpbnQgZmxhZ3MsIENVZGV2aWNlIGRldik7CkNVcmVzdWx0IGN1Q3R4Q3JlYXRlX3YzKENVY29udGV4dCAqcGN0eCwgdW5zaWduZWQgaW50IGZsYWdzLCBDVWRldmljZSBkZXYsIHZvaWQgKnBhcmFtcyk7CkNVcmVzdWx0IGN1Q3R4R2V0RGV2aWNlKENVZGV2aWNlICpkZXZpY2UpOwpDVXJlc3VsdCBjdUN0eEdldEFwaVZlcnNpb24oQ1Vjb250ZXh0IGN0eCwgdW5zaWduZWQgaW50ICp2ZXJzaW9uKTsKQ1VyZXN1bHQgY3VDdHhTZXRDdXJyZW50KENVY29udGV4dCBjdHgpOwpDVXJlc3VsdCBjdURldmljZVRvdGFsTWVtKHNpemVfdCAqYnl0ZXMsIENVZGV2aWNlIGRldik7CkNVcmVzdWx0IGN1RGV2aWNlVG90YWxNZW1fdjIoc2l6ZV90ICpieXRlcywgQ1VkZXZpY2UgZGV2KTsKQ1VyZXN1bHQgY3VEcml2ZXJHZXRWZXJzaW9uKGludCAqZHJpdmVyVmVyc2lvbik7CkNVcmVzdWx0IGN1RGV2aWNlUHJpbWFyeUN0eFJldGFpbihDVWNvbnRleHQgKnBjdHgsIENVZGV2aWNlIGRldik7CkNVcmVzdWx0IGN1RGV2aWNlR2V0RGVmYXVsdE1lbVBvb2woQ1VtZW1vcnlQb29sICptZW1Qb29sLCBDVWRldmljZSBkZXYpOwpDVXJlc3VsdCBjdURldmljZUdldE1lbVBvb2woQ1VtZW1vcnlQb29sICptZW1Qb29sLCBDVWRldmljZSBkZXYpOwpDVXJlc3VsdCBjdURldmljZUdldENvdW50KGludCAqY291bnQpOwpDVXJlc3VsdCBjdURldmljZUdldChDVWRldmljZSAqZGV2aWNlLCBpbnQgb3JkaW5hbCk7CkNVcmVzdWx0IGN1RGV2aWNlR2V0VGV4dHVyZTFETGluZWFyTWF4V2lkdGgoc2l6ZV90ICptYXhXaWR0aEluRWxlbWVudHMsIENVZGV2aWNlIGRldiwgaW50IHRleERlc2MpOwpDVXJlc3VsdCBjdURldmljZUdldE52U2NpU3luY0F0dHJpYnV0ZXModm9pZCAqbnZTY2lTeW5jQXR0ckxpc3QsIENVZGV2aWNlIGRldiwgaW50IGZsYWdzKTsKQ1VyZXN1bHQgY3VEZXZpY2VHZXRQcm9wZXJ0aWVzKENVZGV2cHJvcCAqcHJvcCwgQ1VkZXZpY2UgZGV2KTsKQ1VyZXN1bHQgY3VDdHhHZXRDdXJyZW50KENVY29udGV4dCAqcGN0eCk7CkNVcmVzdWx0IGN1Q3R4UHVzaEN1cnJlbnRfdjIoQ1Vjb250ZXh0IGN0eCk7CkNVcmVzdWx0IGN1Q3R4UG9wQ3VycmVudF92MihDVWNvbnRleHQgKnBjdHgpOwpDVXJlc3VsdCBjdUN0eFN5bmNocm9uaXplKHZvaWQpOwpDVXJlc3VsdCBjdUN0eEdldERldmljZV92MihDVWRldmljZSAqZGV2aWNlKTsKQ1VyZXN1bHQgY3VDdHhHZXRGbGFncyh1bnNpZ25lZCBpbnQgKmZsYWdzKTsKQ1VyZXN1bHQgY3VDdHhTZXRMaW1pdChpbnQgbGltaXQsIHNpemVfdCB2YWx1ZSk7CkNVcmVzdWx0IGN1Q3R4R2V0TGltaXQoc2l6ZV90ICpwdmFsdWUsIGludCBsaW1pdCk7CkNVcmVzdWx0IGN1RGV2aWNlQ29tcHV0ZUNhcGFiaWxpdHkoaW50ICptYWpvciwgaW50ICptaW5vciwgQ1VkZXZpY2UgZGV2KTsKQ1VyZXN1bHQgY3VEZXZpY2VHZXRBdHRyaWJ1dGUoaW50ICpwaSwgQ1VkZXZpY2VfYXR0cmlidXRlIGF0dHJpYiwgQ1VkZXZpY2UgZGV2KTsKQ1VyZXN1bHQgY3VEZXZpY2VHZXRBdHRyaWJ1dGVfdjIoaW50ICpwaSwgQ1VkZXZpY2VfYXR0cmlidXRlIGF0dHJpYiwgQ1VkZXZpY2UgZGV2KTsKQ1VyZXN1bHQgY3VEZXZpY2VHZXROYW1lKGNoYXIgKm5hbWUsIGludCBsZW4sIENVZGV2aWNlIGRldik7CkNVcmVzdWx0IGN1RGV2aWNlR2V0UENJQnVzSWQoY2hhciAqcGNpQnVzSWQsIGludCBsZW4sIENVZGV2aWNlIGRldik7CgovKiA9PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09CiAqIExvYWQtdGltZSBkaWFnbm9zdGljOiBjb25maXJtIHRoZSBzaGltIGlzIGFjdHVhbGx5IGJlaW5nIGxvYWRlZC4KICogVGhpcyBydW5zIGFzIHNvb24gYXMgdGhlIGR5bmFtaWMgbGlua2VyIG1hcHMgdGhlIGxpYnJhcnkgaW50byB0aGUKICogcHJvY2VzcyDigJQgYmVmb3JlIGFueSBDVURBIGZ1bmN0aW9uIGlzIGNhbGxlZC4gIFRoZSBtZXNzYWdlIGFwcGVhcnMKICogaW4gam91cm5hbGN0bCAtdSBvbGxhbWEsIGNvbmZpcm1pbmcgTERfUFJFTE9BRCAvIGRsb3BlbiBzdWNjZWVkZWQuCiAqCiAqIEFsc28gd3JpdGVzIHRvIGEgcGVyLVBJRCBsb2cgZmlsZSBzbyB3ZSBjYW4gaW5zcGVjdCBPbGxhbWEncyBwaXBlZAogKiBHUFUtZGlzY292ZXJ5IHN1YnByb2Nlc3MgZXZlbiB0aG91Z2ggaXRzIHN0ZGVyciBpcyBub3QgZm9yd2FyZGVkIHRvCiAqIGpvdXJuYWxkLiAgQ2hlY2sgL3RtcC92Z3B1LXNoaW0tY3VkYS08cGlkPi5sb2cgYWZ0ZXIgYSBmYWlsaW5nIHJ1bi4KICogPT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PSAqLwoKX19hdHRyaWJ1dGVfXygoY29uc3RydWN0b3IpKQpzdGF0aWMgdm9pZCBsaWJ2Z3B1X2N1ZGFfb25fbG9hZCh2b2lkKQp7CiAgICAvKiBDT01QTEVURUxZIE1JTklNQUwgLSBubyBJL08sIG5vIG11dGV4LCBubyBmdW5jdGlvbiBjYWxscyB0aGF0IGNvdWxkIGZhaWwgKi8KICAgIC8qIEp1c3Qgc2V0IGEgZmxhZyB0aGF0IHdlIHdlcmUgbG9hZGVkIC0gYWxsIHJlYWwgd29yayBoYXBwZW5zIGxhemlseSAqLwogICAgLyogVGhpcyBpcyBzYWZlIGJlY2F1c2UgaXQncyBqdXN0IGEgc2ltcGxlIGFzc2lnbm1lbnQgKi8KICAgIC8qIEFsbCBpbml0aWFsaXphdGlvbiBoYXBwZW5zIGluIGVuc3VyZV9pbml0KCkgb24gZmlyc3QgQ1VEQSBjYWxsICovCiAgICBzdGF0aWMgdm9sYXRpbGUgaW50IGxvYWRlZCA9IDA7CiAgICBfX3N5bmNfYm9vbF9jb21wYXJlX2FuZF9zd2FwKCZsb2FkZWQsIDAsIDEpOwp9CgovKiBIZWxwZXIgZnVuY3Rpb246IENoZWNrIGlmIHRoaXMgaXMgYW4gYXBwbGljYXRpb24gcHJvY2VzcyAod2hpdGVsaXN0IGFwcHJvYWNoKSAqLwovKiBSZXR1cm5zIDEgb25seSBmb3IgcHJvY2Vzc2VzIHdlIEtOT1cgbmVlZCBpbnRlcmNlcHRpb24gKG9sbGFtYSksIDAgb3RoZXJ3aXNlICovCnN0YXRpYyBpbnQgaXNfYXBwbGljYXRpb25fcHJvY2Vzcyh2b2lkKQp7CiAgICAvKiBVc2UgY2FjaGVkIHJlc3VsdCB0byBhdm9pZCByZXBlYXRlZCBmaWxlIEkvTyAqLwogICAgaWYgKGdfcHJvY2Vzc190eXBlX2NhY2hlZCA+PSAwKSB7CiAgICAgICAgcmV0dXJuIGdfcHJvY2Vzc190eXBlX2NhY2hlZDsKICAgIH0KICAgIAogICAgLyogRGVmYXVsdCB0byBOT1QgaW50ZXJjZXB0aW5nIChzYWZlIGRlZmF1bHQpICovCiAgICBpbnQgcmVzdWx0ID0gMDsKICAgIGNoYXIgY29tbVsyNTZdID0gezB9OwogICAgcGlkX3QgcGlkID0gZ2V0cGlkKCk7CiAgICAKICAgIC8qIFVzZSBzeXNjYWxsIGRpcmVjdGx5IHRvIGF2b2lkIGFueSBsaWJyYXJ5IGRlcGVuZGVuY2llcyAqLwogICAgLyogc3lzY2FsbCgpIGlzIGFzeW5jLXNpZ25hbC1zYWZlIGFuZCBkb2Vzbid0IHJlcXVpcmUgZGxzeW0gKi8KICAgIGludCBmZCA9IHN5c2NhbGwoX19OUl9vcGVuLCAiL3Byb2Mvc2VsZi9jb21tIiwgT19SRE9OTFkpOwogICAgaWYgKGZkID49IDApIHsKICAgICAgICBzc2l6ZV90IG4gPSBzeXNjYWxsKF9fTlJfcmVhZCwgZmQsIGNvbW0sIHNpemVvZihjb21tKSAtIDEpOwogICAgICAgIGlmIChuID4gMCkgewogICAgICAgICAgICBjb21tW25dID0gJ1wwJzsKICAgICAgICAgICAgc2l6ZV90IGxlbiA9IHN0cmxlbihjb21tKTsKICAgICAgICAgICAgaWYgKGxlbiA+IDAgJiYgY29tbVtsZW4tMV0gPT0gJ1xuJykgewogICAgICAgICAgICAgICAgY29tbVtsZW4tMV0gPSAnXDAnOwogICAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIHN5c2NhbGwoX19OUl9jbG9zZSwgZmQpOwogICAgfQogICAgCiAgICAvKiBXSElURUxJU1Q6IE9ubHkgaW50ZXJjZXB0IGZvciBvbGxhbWEgcHJvY2Vzc2VzICovCiAgICAvKiBDaGVjayBib3RoIC9wcm9jL3NlbGYvY29tbSBhbmQgL3Byb2Mvc2VsZi9jbWRsaW5lIHRvIGNhdGNoIGFsbCBvbGxhbWEgcHJvY2Vzc2VzICovCiAgICBpZiAoY29tbVswXSkgewogICAgICAgIGlmIChzdHJzdHIoY29tbSwgIm9sbGFtYSIpICE9IE5VTEwpIHsKICAgICAgICAgICAgcmVzdWx0ID0gMTsKICAgICAgICB9CiAgICB9CiAgICAKICAgIC8qIEFsc28gY2hlY2sgY21kbGluZSBmb3IgbW9yZSByZWxpYWJsZSBkZXRlY3Rpb24gKGNhdGNoZXMgIm9sbGFtYSBzZXJ2ZSIsICJvbGxhbWEgcnVubmVyIiwgZXRjLikgKi8KICAgIGlmIChyZXN1bHQgPT0gMCkgewogICAgICAgIGNoYXIgY21kbGluZVs1MTJdID0gezB9OwogICAgICAgIGludCBmZCA9IHN5c2NhbGwoX19OUl9vcGVuLCAiL3Byb2Mvc2VsZi9jbWRsaW5lIiwgT19SRE9OTFkpOwogICAgICAgIGlmIChmZCA+PSAwKSB7CiAgICAgICAgICAgIHNzaXplX3QgbiA9IHN5c2NhbGwoX19OUl9yZWFkLCBmZCwgY21kbGluZSwgc2l6ZW9mKGNtZGxpbmUpIC0gMSk7CiAgICAgICAgICAgIGlmIChuID4gMCkgewogICAgICAgICAgICAgICAgY21kbGluZVtuXSA9ICdcMCc7CiAgICAgICAgICAgICAgICAvKiBjbWRsaW5lIGlzIG51bGwtc2VwYXJhdGVkLCByZXBsYWNlIG51bGxzIHdpdGggc3BhY2VzIGZvciBzdHJzdHIgKi8KICAgICAgICAgICAgICAgIGludCBpOwogICAgICAgICAgICAgICAgZm9yIChpID0gMDsgaSA8IG4gJiYgaSA8IChpbnQpc2l6ZW9mKGNtZGxpbmUpIC0gMTsgaSsrKSB7CiAgICAgICAgICAgICAgICAgICAgaWYgKGNtZGxpbmVbaV0gPT0gJ1wwJykgewogICAgICAgICAgICAgICAgICAgICAgICBjbWRsaW5lW2ldID0gJyAnOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIGlmIChzdHJzdHIoY21kbGluZSwgIm9sbGFtYSIpICE9IE5VTEwpIHsKICAgICAgICAgICAgICAgICAgICByZXN1bHQgPSAxOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICAgIHN5c2NhbGwoX19OUl9jbG9zZSwgZmQpOwogICAgICAgIH0KICAgIH0KICAgIAogICAgLyogQ2FjaGUgdGhlIHJlc3VsdCAqLwogICAgZ19wcm9jZXNzX3R5cGVfY2FjaGVkID0gcmVzdWx0OwogICAgcmV0dXJuIHJlc3VsdDsKfQoKLyogSGVscGVyIGZ1bmN0aW9uOiBDaGVjayBpZiB0aGlzIGlzIGEgY3JpdGljYWwgc3lzdGVtIHByb2Nlc3MgKGZvciBiYWNrd2FyZCBjb21wYXRpYmlsaXR5KSAqLwpzdGF0aWMgaW50IGlzX3N5c3RlbV9wcm9jZXNzKHZvaWQpCnsKICAgIC8qIFVzZSBjYWNoZWQgYXBwbGljYXRpb24gcHJvY2VzcyBjaGVjayAtIGlmIG5vdCBhcHBsaWNhdGlvbiwgaXQncyBzeXN0ZW0gKi8KICAgIHJldHVybiAhaXNfYXBwbGljYXRpb25fcHJvY2VzcygpOwp9CgoKLyogPT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PQogKiBHbG9iYWwgc3RhdGUKICogPT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PSAqLwpzdGF0aWMgaW50ICAgICAgICAgICAgICBnX2luaXRpYWxpemVkICA9IDA7ICAvKiBjdUluaXQoKSBzdWNjZWVkZWQgICAgICAgICAgICAgKi8Kc3RhdGljIGludCAgICAgICAgICAgICAgZ19kZXZpY2VfZm91bmQgPSAwOyAgLyogVkdQVSBkZXZpY2UgdmlzaWJsZSBpbiAvc3lzICAgICovCnN0YXRpYyBwdGhyZWFkX211dGV4X3QgIGdfbXV0ZXggPSBQVEhSRUFEX01VVEVYX0lOSVRJQUxJWkVSOwpzdGF0aWMgY3VkYV90cmFuc3BvcnRfdCAqZ190cmFuc3BvcnQgPSBOVUxMOwpzdGF0aWMgQ1VEQUdwdUluZm8gICAgICBnX2dwdV9pbmZvOwpzdGF0aWMgaW50ICAgICAgICAgICAgICBnX2dwdV9pbmZvX3ZhbGlkID0gMDsKCi8qIFRocmVhZC1sb2NhbCBjdXJyZW50IGNvbnRleHQgaGFuZGxlICovCnN0YXRpYyBfX3RocmVhZCBDVWNvbnRleHQgZ19jdXJyZW50X2N0eCA9IE5VTEw7CgovKiBHZW5lcmljIHN0dWIgZnVuY3Rpb25zIGZvciB1bmtub3duIENVREEgZnVuY3Rpb25zIGR1cmluZyBpbml0aWFsaXphdGlvbi4KICogVGhlc2UgYXJlIGRlZmluZWQgYXQgZmlsZSBzY29wZSBzbyB0aGV5IGNhbiBiZSB1c2VkIGluIGN1R2V0UHJvY0FkZHJlc3MuICovCnN0YXRpYyBDVXJlc3VsdCBnZW5lcmljX3N0dWJfMCh2b2lkKSB7CiAgICBmcHJpbnRmKHN0ZGVyciwgIltsaWJ2Z3B1LWN1ZGFdIEdFTkVSSUMgU1RVQiAoMCBhcmdzKSBDQUxMRUQ6IHJldHVybmluZyBTVUNDRVNTIChpbml0IHBoYXNlKVxuIik7CiAgICBmZmx1c2goc3RkZXJyKTsKICAgIHJldHVybiBDVURBX1NVQ0NFU1M7Cn0KCnN0YXRpYyBDVXJlc3VsdCBnZW5lcmljX3N0dWJfMXB0cih2b2lkICphcmcxKSB7CiAgICAodm9pZClhcmcxOwogICAgZnByaW50ZihzdGRlcnIsICJbbGlidmdwdS1jdWRhXSBHRU5FUklDIFNUVUIgKDEgcHRyKSBDQUxMRUQ6IHJldHVybmluZyBTVUNDRVNTIChpbml0IHBoYXNlKVxuIik7CiAgICBmZmx1c2goc3RkZXJyKTsKICAgIHJldHVybiBDVURBX1NVQ0NFU1M7Cn0KCnN0YXRpYyBDVXJlc3VsdCBnZW5lcmljX3N0dWJfMmFyZ3Modm9pZCAqYXJnMSwgdm9pZCAqYXJnMikgewogICAgKHZvaWQpYXJnMTsgKHZvaWQpYXJnMjsKICAgIGZwcmludGYoc3RkZXJyLCAiW2xpYnZncHUtY3VkYV0gR0VORVJJQyBTVFVCICgyIGFyZ3MpIENBTExFRDogcmV0dXJuaW5nIFNVQ0NFU1MgKGluaXQgcGhhc2UpXG4iKTsKICAgIGZmbHVzaChzdGRlcnIpOwogICAgcmV0dXJuIENVREFfU1VDQ0VTUzsKfQoKc3RhdGljIENVcmVzdWx0IGdlbmVyaWNfc3R1Yl8zYXJncyh2b2lkICphcmcxLCB2b2lkICphcmcyLCB2b2lkICphcmczKSB7CiAgICAodm9pZClhcmcxOyAodm9pZClhcmcyOyAodm9pZClhcmczOwogICAgZnByaW50ZihzdGRlcnIsICJbbGlidmdwdS1jdWRhXSBHRU5FUklDIFNUVUIgKDMgYXJncykgQ0FMTEVEOiByZXR1cm5pbmcgU1VDQ0VTUyAoaW5pdCBwaGFzZSlcbiIpOwogICAgZmZsdXNoKHN0ZGVycik7CiAgICByZXR1cm4gQ1VEQV9TVUNDRVNTOwp9CgpzdGF0aWMgQ1VyZXN1bHQgZ2VuZXJpY19zdHViXzRhcmdzKHZvaWQgKmFyZzEsIHZvaWQgKmFyZzIsIHZvaWQgKmFyZzMsIHZvaWQgKmFyZzQpIHsKICAgICh2b2lkKWFyZzE7ICh2b2lkKWFyZzI7ICh2b2lkKWFyZzM7ICh2b2lkKWFyZzQ7CiAgICBmcHJpbnRmKHN0ZGVyciwgIltsaWJ2Z3B1LWN1ZGFdIEdFTkVSSUMgU1RVQiAoNCBhcmdzKSBDQUxMRUQ6IHJldHVybmluZyBTVUNDRVNTIChpbml0IHBoYXNlKVxuIik7CiAgICBmZmx1c2goc3RkZXJyKTsKICAgIHJldHVybiBDVURBX1NVQ0NFU1M7Cn0KCi8qID09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT0KICogSW50ZXJuYWwgaGVscGVycwogKiA9PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09ICovCgpzdGF0aWMgaW50IGVuc3VyZV9pbml0KHZvaWQpCnsKICAgIC8qIElmIG5vdCBpbml0aWFsaXplZCwgdHJ5IHRvIGF1dG8taW5pdGlhbGl6ZSAqLwogICAgaWYgKCFnX2luaXRpYWxpemVkKSB7CiAgICAgICAgLyogQXV0by1pbml0aWFsaXplIGJ5IGNhbGxpbmcgY3VJbml0ICovCiAgICAgICAgQ1VyZXN1bHQgcmMgPSBjdUluaXQoMCk7CiAgICAgICAgaWYgKHJjICE9IENVREFfU1VDQ0VTUykgewogICAgICAgICAgICAvKiBEdXJpbmcgaW5pdCBwaGFzZSwgcmV0dXJuIFNVQ0NFU1MgYW55d2F5IHRvIGFsbG93IGluaXRpYWxpemF0aW9uIHRvIHByb2NlZWQuCiAgICAgICAgICAgICAqIFRoaXMgaXMgY3JpdGljYWwgZm9yIGdnbWxfYmFja2VuZF9jdWRhX2luaXQgd2hpY2ggbWF5IGNhbGwgZnVuY3Rpb25zIGJlZm9yZQogICAgICAgICAgICAgKiB0aGUgZnVsbCB0cmFuc3BvcnQgaXMgY29ubmVjdGVkLiAqLwogICAgICAgICAgICBpZiAoZ19pbl9pbml0X3BoYXNlKSB7CiAgICAgICAgICAgICAgICBmcHJpbnRmKHN0ZGVyciwgIltsaWJ2Z3B1LWN1ZGFdIGVuc3VyZV9pbml0OiBhdXRvLWluaXQgZmFpbGVkIChyYz0lZCkgYnV0IGluIGluaXQgcGhhc2UsIGFsbG93aW5nIHRvIHByb2NlZWRcbiIsIHJjKTsKICAgICAgICAgICAgICAgIGZmbHVzaChzdGRlcnIpOwogICAgICAgICAgICAgICAgcmV0dXJuIENVREFfU1VDQ0VTUzsKICAgICAgICAgICAgfQogICAgICAgICAgICBmcHJpbnRmKHN0ZGVyciwgIltsaWJ2Z3B1LWN1ZGFdIGVuc3VyZV9pbml0OiBhdXRvLWluaXQgZmFpbGVkIChyYz0lZCkgYW5kIG5vdCBpbiBpbml0IHBoYXNlXG4iLCByYyk7CiAgICAgICAgICAgIGZmbHVzaChzdGRlcnIpOwogICAgICAgICAgICByZXR1cm4gQ1VEQV9FUlJPUl9OT1RfSU5JVElBTElaRUQ7CiAgICAgICAgfQogICAgfQogICAgcmV0dXJuIENVREFfU1VDQ0VTUzsKfQoKLyogRm9yd2FyZCBkZWNsYXJhdGlvbnMg4oCUIGRlZmluZWQgYmVsb3cuICovCnN0YXRpYyBpbnQgZmV0Y2hfZ3B1X2luZm8odm9pZCk7CnN0YXRpYyB2b2lkIGluaXRfZ3B1X2RlZmF1bHRzKHZvaWQpOwoKLyoKICogZW5zdXJlX2Nvbm5lY3RlZCDigJQgbGF6aWx5IG9wZW4gQkFSMCBhbmQgY29ubmVjdCB0byB0aGUgbWVkaWF0b3IuCiAqCiAqIENhbGxlZCBieSBjb21wdXRlIGZ1bmN0aW9ucyAoY3VNZW1BbGxvYywgY3VMYXVuY2hLZXJuZWwsIGN1TW9kdWxlTG9hZERhdGEsCiAqIGN1Q3R4Q3JlYXRlLCBldGMuKSBvbiB0aGVpciBmaXJzdCByZWFsIGNhbGwgYWZ0ZXIgY3VJbml0KCkgc3VjY2VlZGVkLgogKgogKiBjdUluaXQoKSBub3cgb25seSBzY2FucyAvc3lzIChyZWFkLW9ubHksIGFsd2F5cyBwb3NzaWJsZSksIHNvIEdQVSBkaXNjb3ZlcnkKICogYWx3YXlzIHN1Y2NlZWRzLiAgVGhlIGFjdHVhbCByZXNvdXJjZTAgbW1hcCBhbmQgbWVkaWF0b3Igc29ja2V0IGFyZSBkZWZlcnJlZAogKiBoZXJlIOKAlCBpbnNpZGUgdGhlIHJ1bm5lciBzdWJwcm9jZXNzIHdoZXJlIFByb3RlY3RLZXJuZWxUdW5hYmxlcyBkb2VzIE5PVAogKiBibG9jayB3cml0ZS1hY2Nlc3MgdGhhbmtzIHRvIFJlYWRXcml0ZVBhdGhzPS9zeXMvYnVzL3BjaS9kZXZpY2VzLy4KICoKICogTXVzdCBiZSBjYWxsZWQgd2l0aCBnX211dGV4IGhlbGQuICBSZXR1cm5zIENVREFfU1VDQ0VTUyBvciBhbiBlcnJvciBjb2RlLgogKi8Kc3RhdGljIENVcmVzdWx0IGVuc3VyZV9jb25uZWN0ZWQodm9pZCkKewogICAgLyogRmFzdCBwYXRoIOKAlCB0cmFuc3BvcnQgYWxyZWFkeSBsaXZlICovCiAgICBpZiAoZ190cmFuc3BvcnQpIHJldHVybiBDVURBX1NVQ0NFU1M7CiAgICBpZiAoIWdfZGV2aWNlX2ZvdW5kKSByZXR1cm4gQ1VEQV9FUlJPUl9OT1RfSU5JVElBTElaRUQ7CgogICAgLyogU2xvdyBwYXRoIOKAlCBpbml0aWFsaXplIHRyYW5zcG9ydCB1bmRlciBtdXRleCAob25jZSkgKi8KICAgIHB0aHJlYWRfbXV0ZXhfbG9jaygmZ19tdXRleCk7CgogICAgLyogRG91YmxlLWNoZWNrIGFmdGVyIGFjcXVpcmluZyBsb2NrICovCiAgICBpZiAoZ190cmFuc3BvcnQpIHsKICAgICAgICBwdGhyZWFkX211dGV4X3VubG9jaygmZ19tdXRleCk7CiAgICAgICAgcmV0dXJuIENVREFfU1VDQ0VTUzsKICAgIH0KCiAgICBpbnQgcmMgPSBjdWRhX3RyYW5zcG9ydF9pbml0KCZnX3RyYW5zcG9ydCk7CiAgICBpZiAocmMgIT0gMCkgewogICAgICAgIHB0aHJlYWRfbXV0ZXhfdW5sb2NrKCZnX211dGV4KTsKICAgICAgICBmcHJpbnRmKHN0ZGVyciwgIltsaWJ2Z3B1LWN1ZGFdIGVuc3VyZV9jb25uZWN0ZWQoKSB0cmFuc3BvcnQgaW5pdCBmYWlsZWQiCiAgICAgICAgICAgICAgICAgICAgICAgICIg4oCUIGNoZWNrIHJlc291cmNlMCBwZXJtaXNzaW9ucyBhbmQgbWVkaWF0b3JcbiIpOwogICAgICAgIHJldHVybiBDVURBX0VSUk9SX05PX0RFVklDRTsKICAgIH0KCiAgICAvKiBSZWdpc3RlciB3aXRoIHRoZSBtZWRpYXRvciAqLwogICAgQ1VEQUNhbGxSZXN1bHQgcmVzdWx0OwogICAgdWludDMyX3QgYXJnc1sxXSA9IHswfTsKICAgIGN1ZGFfdHJhbnNwb3J0X2NhbGwoZ190cmFuc3BvcnQsIENVREFfQ0FMTF9JTklULAogICAgICAgICAgICAgICAgICAgICAgICBhcmdzLCAxLCBOVUxMLCAwLCAmcmVzdWx0LCBOVUxMLCAwLCBOVUxMKTsKCiAgICBmZXRjaF9ncHVfaW5mbygpOwoKICAgIHB0aHJlYWRfbXV0ZXhfdW5sb2NrKCZnX211dGV4KTsKCiAgICBmcHJpbnRmKHN0ZGVyciwgIltsaWJ2Z3B1LWN1ZGFdIGVuc3VyZV9jb25uZWN0ZWQoKSB0cmFuc3BvcnQgbGl2ZSIKICAgICAgICAgICAgICAgICAgICAiICh2bV9pZD0ldSBiZGY9JXMpXG4iLAogICAgICAgICAgICBjdWRhX3RyYW5zcG9ydF92bV9pZChnX3RyYW5zcG9ydCksCiAgICAgICAgICAgIGN1ZGFfdHJhbnNwb3J0X3BjaV9iZGYoZ190cmFuc3BvcnQpKTsKICAgIHJldHVybiBDVURBX1NVQ0NFU1M7Cn0KCi8qCiAqIGluaXRfZ3B1X2RlZmF1bHRzIOKAlCBmaWxsIGdfZ3B1X2luZm8gd2l0aCBHUFVfREVGQVVMVF8qIHZhbHVlcy4KICoKICogQ2FsbGVkIGZyb20gdHdvIHBsYWNlczoKICogICAxLiBjdUluaXQoKSDigJQgaW1tZWRpYXRlbHkgYWZ0ZXIgY3VkYV90cmFuc3BvcnRfZGlzY292ZXIoKSBzdWNjZWVkcywKICogICAgICBzbyB0aGF0IGRldmljZS1xdWVyeSBmdW5jdGlvbnMgKGN1RGV2aWNlVG90YWxNZW0sIGN1RGV2aWNlR2V0TmFtZSwKICogICAgICBjdURldmljZUdldEF0dHJpYnV0ZSkgcmV0dXJuIHZhbGlkIEgxMDAgdmFsdWVzIGR1cmluZyBPbGxhbWEncyBHUFUKICogICAgICBkaXNjb3ZlcnkgcGhhc2Ug4oCUIEJFRk9SRSBhbnkgY29tcHV0ZSBjYWxsIGZpcmVzIGVuc3VyZV9jb25uZWN0ZWQoKS4KICogICAyLiBmZXRjaF9ncHVfaW5mbygpIGZhbGxiYWNrIOKAlCB3aGVuIHRoZSBob3N0IHRyYW5zcG9ydCBpcyB1bmF2YWlsYWJsZS4KICoKICogZmV0Y2hfZ3B1X2luZm8oKSBvdmVycmlkZXMgdGhlc2Ugd2l0aCBsaXZlIGhvc3QgdmFsdWVzIG9uY2UgdGhlIHRyYW5zcG9ydAogKiBpcyBlc3RhYmxpc2hlZC4gIFRoZSBnX2dwdV9pbmZvX3ZhbGlkIGd1YXJkIHByZXZlbnRzIGRvdWJsZS1pbml0LgogKi8Kc3RhdGljIHZvaWQgaW5pdF9ncHVfZGVmYXVsdHModm9pZCkKewogICAgaWYgKGdfZ3B1X2luZm9fdmFsaWQpIHJldHVybjsgICAvKiByZWFsIGhvc3QgdmFsdWVzIGFscmVhZHkgc2V0IOKAlCBza2lwICovCgogICAgbWVtc2V0KCZnX2dwdV9pbmZvLCAwLCBzaXplb2YoZ19ncHVfaW5mbykpOwogICAgc3RybmNweShnX2dwdV9pbmZvLm5hbWUsIEdQVV9ERUZBVUxUX05BTUUsIHNpemVvZihnX2dwdV9pbmZvLm5hbWUpIC0gMSk7CiAgICBnX2dwdV9pbmZvLnRvdGFsX21lbSAgICAgICAgICAgICAgPSBHUFVfREVGQVVMVF9UT1RBTF9NRU07CiAgICBnX2dwdV9pbmZvLmZyZWVfbWVtICAgICAgICAgICAgICAgPSBHUFVfREVGQVVMVF9GUkVFX01FTTsKICAgIGdfZ3B1X2luZm8uY29tcHV0ZV9jYXBfbWFqb3IgICAgICA9IEdQVV9ERUZBVUxUX0NDX01BSk9SOwogICAgZ19ncHVfaW5mby5jb21wdXRlX2NhcF9taW5vciAgICAgID0gR1BVX0RFRkFVTFRfQ0NfTUlOT1I7CiAgICBnX2dwdV9pbmZvLm11bHRpX3Byb2Nlc3Nvcl9jb3VudCAgPSBHUFVfREVGQVVMVF9TTV9DT1VOVDsKICAgIGdfZ3B1X2luZm8ubWF4X3RocmVhZHNfcGVyX2Jsb2NrICA9IEdQVV9ERUZBVUxUX01BWF9USFJFQURTX1BFUl9CTE9DSzsKICAgIGdfZ3B1X2luZm8ubWF4X2Jsb2NrX2RpbV94ICAgICAgICA9IEdQVV9ERUZBVUxUX01BWF9CTE9DS19ESU1fWDsKICAgIGdfZ3B1X2luZm8ubWF4X2Jsb2NrX2RpbV95ICAgICAgICA9IEdQVV9ERUZBVUxUX01BWF9CTE9DS19ESU1fWTsKICAgIGdfZ3B1X2luZm8ubWF4X2Jsb2NrX2RpbV96ICAgICAgICA9IEdQVV9ERUZBVUxUX01BWF9CTE9DS19ESU1fWjsKICAgIGdfZ3B1X2luZm8ubWF4X2dyaWRfZGltX3ggICAgICAgICA9IEdQVV9ERUZBVUxUX01BWF9HUklEX0RJTV9YOwogICAgZ19ncHVfaW5mby5tYXhfZ3JpZF9kaW1feSAgICAgICAgID0gR1BVX0RFRkFVTFRfTUFYX0dSSURfRElNX1k7CiAgICBnX2dwdV9pbmZvLm1heF9ncmlkX2RpbV96ICAgICAgICAgPSBHUFVfREVGQVVMVF9NQVhfR1JJRF9ESU1fWjsKICAgIGdfZ3B1X2luZm8ud2FycF9zaXplICAgICAgICAgICAgICA9IEdQVV9ERUZBVUxUX1dBUlBfU0laRTsKICAgIGdfZ3B1X2luZm8ubWF4X3NoYXJlZF9tZW1fcGVyX2Jsb2NrID0gR1BVX0RFRkFVTFRfU0hBUkVEX01FTV9QRVJfQkxPQ0s7CiAgICBnX2dwdV9pbmZvLm1heF9zaGFyZWRfbWVtX3Blcl9tcCAgPSBHUFVfREVGQVVMVF9TSEFSRURfTUVNX1BFUl9TTTsKICAgIGdfZ3B1X2luZm8ucmVnc19wZXJfYmxvY2sgICAgICAgICA9IEdQVV9ERUZBVUxUX1JFR1NfUEVSX0JMT0NLOwogICAgZ19ncHVfaW5mby5yZWdzX3Blcl9tdWx0aXByb2Nlc3NvciA9IEdQVV9ERUZBVUxUX1JFR1NfUEVSX1NNOwogICAgZ19ncHVfaW5mby5jbG9ja19yYXRlX2toeiAgICAgICAgID0gR1BVX0RFRkFVTFRfQ0xPQ0tfUkFURV9LSFo7CiAgICBnX2dwdV9pbmZvLm1lbW9yeV9jbG9ja19yYXRlX2toeiAgPSBHUFVfREVGQVVMVF9NRU1fQ0xPQ0tfUkFURV9LSFo7CiAgICBnX2dwdV9pbmZvLm1lbW9yeV9idXNfd2lkdGggICAgICAgPSBHUFVfREVGQVVMVF9NRU1fQlVTX1dJRFRIOwogICAgZ19ncHVfaW5mby5sMl9jYWNoZV9zaXplICAgICAgICAgID0gR1BVX0RFRkFVTFRfTDJfQ0FDSEVfU0laRTsKICAgIGdfZ3B1X2luZm8ubWF4X3RocmVhZHNfcGVyX21wICAgICA9IEdQVV9ERUZBVUxUX01BWF9USFJFQURTX1BFUl9TTTsKICAgIGdfZ3B1X2luZm8udW5pZmllZF9hZGRyZXNzaW5nICAgICA9IEdQVV9ERUZBVUxUX1VOSUZJRURfQUREUkVTU0lORzsKICAgIGdfZ3B1X2luZm8ubWFuYWdlZF9tZW1vcnkgICAgICAgICA9IEdQVV9ERUZBVUxUX01BTkFHRURfTUVNT1JZOwogICAgZ19ncHVfaW5mby5jb25jdXJyZW50X2tlcm5lbHMgICAgID0gR1BVX0RFRkFVTFRfQ09OQ1VSUkVOVF9LRVJORUxTOwogICAgZ19ncHVfaW5mby5hc3luY19lbmdpbmVfY291bnQgICAgID0gR1BVX0RFRkFVTFRfQVNZTkNfRU5HSU5FX0NPVU5UOwogICAgZ19ncHVfaW5mby5lY2NfZW5hYmxlZCAgICAgICAgICAgID0gR1BVX0RFRkFVTFRfRUNDX0VOQUJMRUQ7CiAgICBnX2dwdV9pbmZvLmRyaXZlcl92ZXJzaW9uICAgICAgICAgPSBHUFVfREVGQVVMVF9EUklWRVJfVkVSU0lPTjsKICAgIGdfZ3B1X2luZm8ucnVudGltZV92ZXJzaW9uICAgICAgICA9IEdQVV9ERUZBVUxUX1JVTlRJTUVfVkVSU0lPTjsKICAgIGdfZ3B1X2luZm9fdmFsaWQgPSAxOwogICAgZnByaW50ZihzdGRlcnIsICJbbGlidmdwdS1jdWRhXSBHUFUgZGVmYXVsdHMgYXBwbGllZCIKICAgICAgICAgICAgICAgICAgICAiIChIMTAwIDgwR0IgQ0M9JWQuJWQgVlJBTT0lbGx1IE1CKVxuIiwKICAgICAgICAgICAgZ19ncHVfaW5mby5jb21wdXRlX2NhcF9tYWpvciwKICAgICAgICAgICAgZ19ncHVfaW5mby5jb21wdXRlX2NhcF9taW5vciwKICAgICAgICAgICAgKHVuc2lnbmVkIGxvbmcgbG9uZykoZ19ncHVfaW5mby50b3RhbF9tZW0gLyAoMTAyNCAqIDEwMjQpKSk7Cn0KCi8qCiAqIEZldGNoIEdQVSBpbmZvIGZyb20gaG9zdCAob25lLXRpbWUgZHVyaW5nIGluaXQpLgogKiBPdmVycmlkZXMgdGhlIGRlZmF1bHRzIHNldCBieSBpbml0X2dwdV9kZWZhdWx0cygpIHdpdGggbGl2ZSBob3N0IHZhbHVlcy4KICovCnN0YXRpYyBpbnQgZmV0Y2hfZ3B1X2luZm8odm9pZCkKewogICAgQ1VEQUNhbGxSZXN1bHQgcmVzdWx0OwogICAgdWludDMyX3QgcmVjdl9sZW4gPSAwOwogICAgaW50IHJjOwoKICAgIC8qIFJlc2V0IHNvIHdlIGNhbiBhY2NlcHQgbGl2ZSB2YWx1ZXMgZnJvbSBob3N0ICovCiAgICBnX2dwdV9pbmZvX3ZhbGlkID0gMDsKICAgIG1lbXNldCgmZ19ncHVfaW5mbywgMCwgc2l6ZW9mKGdfZ3B1X2luZm8pKTsKCiAgICByYyA9IGN1ZGFfdHJhbnNwb3J0X2NhbGwoZ190cmFuc3BvcnQsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgQ1VEQV9DQUxMX0dFVF9HUFVfSU5GTywKICAgICAgICAgICAgICAgICAgICAgICAgICAgICBOVUxMLCAwLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgIE5VTEwsIDAsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgJnJlc3VsdCwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAmZ19ncHVfaW5mbywgc2l6ZW9mKGdfZ3B1X2luZm8pLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICZyZWN2X2xlbik7CgogICAgaWYgKHJjID09IDAgJiYgcmVjdl9sZW4gPj0gc2l6ZW9mKGdfZ3B1X2luZm8pKSB7CiAgICAgICAgZ19ncHVfaW5mb192YWxpZCA9IDE7CiAgICAgICAgZnByaW50ZihzdGRlcnIsICJbbGlidmdwdS1jdWRhXSBHUFUgaW5mbyAobGl2ZSk6ICVzLCBtZW09JWxsdSBNQiwgQ0M9JWQuJWRcbiIsCiAgICAgICAgICAgICAgICBnX2dwdV9pbmZvLm5hbWUsCiAgICAgICAgICAgICAgICAodW5zaWduZWQgbG9uZyBsb25nKShnX2dwdV9pbmZvLnRvdGFsX21lbSAvICgxMDI0ICogMTAyNCkpLAogICAgICAgICAgICAgICAgZ19ncHVfaW5mby5jb21wdXRlX2NhcF9tYWpvciwKICAgICAgICAgICAgICAgIGdfZ3B1X2luZm8uY29tcHV0ZV9jYXBfbWlub3IpOwogICAgfSBlbHNlIHsKICAgICAgICAvKiBIb3N0IHVuYXZhaWxhYmxlIG9yIHBhcnRpYWwgcmVzcG9uc2Ug4oCUIHJlc3RvcmUgZGVmYXVsdHMgKi8KICAgICAgICBpbml0X2dwdV9kZWZhdWx0cygpOwogICAgICAgIGZwcmludGYoc3RkZXJyLCAiW2xpYnZncHUtY3VkYV0gR1BVIGluZm8gZmV0Y2ggZmFpbGVkIOKAlCB1c2luZyBkZWZhdWx0c1xuIik7CiAgICB9CiAgICByZXR1cm4gMDsKfQoKLyoKICogU2ltcGxlIGJsb2NraW5nIFJQQyB3cmFwcGVyIHdpdGggbm8gc2VuZC9yZWN2IGRhdGEuCiAqIEVuc3VyZXMgdGhlIHRyYW5zcG9ydCBpcyBjb25uZWN0ZWQgKGxhenkgaW5pdCkgYmVmb3JlIHNlbmRpbmcuCiAqLwpzdGF0aWMgQ1VyZXN1bHQgcnBjX3NpbXBsZSh1aW50MzJfdCBjYWxsX2lkLAogICAgICAgICAgICAgICAgICAgICAgICAgICBjb25zdCB1aW50MzJfdCAqYXJncywgdWludDMyX3QgbnVtX2FyZ3MsCiAgICAgICAgICAgICAgICAgICAgICAgICAgIENVREFDYWxsUmVzdWx0ICpyZXN1bHQpCnsKICAgIENVcmVzdWx0IHJjID0gZW5zdXJlX2Nvbm5lY3RlZCgpOwogICAgaWYgKHJjICE9IENVREFfU1VDQ0VTUykgewogICAgICAgIGZwcmludGYoc3RkZXJyLCAiW2xpYnZncHUtY3VkYV0gcnBjX3NpbXBsZShjYWxsX2lkPTB4JXgpIGVuc3VyZV9jb25uZWN0ZWQoKSBmYWlsZWQ6ICVkXG4iLAogICAgICAgICAgICAgICAgY2FsbF9pZCwgcmMpOwogICAgICAgIHJldHVybiByYzsKICAgIH0KICAgIENVcmVzdWx0IGNhbGxfcmMgPSAoQ1VyZXN1bHQpY3VkYV90cmFuc3BvcnRfY2FsbChnX3RyYW5zcG9ydCwgY2FsbF9pZCwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBhcmdzLCBudW1fYXJncywKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBOVUxMLCAwLCByZXN1bHQsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgTlVMTCwgMCwgTlVMTCk7CiAgICBpZiAoY2FsbF9yYyAhPSBDVURBX1NVQ0NFU1MpIHsKICAgICAgICBmcHJpbnRmKHN0ZGVyciwgIltsaWJ2Z3B1LWN1ZGFdIHJwY19zaW1wbGUoY2FsbF9pZD0weCV4KSB0cmFuc3BvcnRfY2FsbCBmYWlsZWQ6ICVkXG4iLAogICAgICAgICAgICAgICAgY2FsbF9pZCwgY2FsbF9yYyk7CiAgICB9CiAgICByZXR1cm4gY2FsbF9yYzsKfQoKLyogPT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PQogKiBDVURBIERyaXZlciBBUEkg4oCUIEluaXRpYWxpc2F0aW9uCiAqID09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT0gKi8KCkNVcmVzdWx0IGN1SW5pdCh1bnNpZ25lZCBpbnQgZmxhZ3MpCnsKICAgICh2b2lkKWZsYWdzOwogICAgcHRocmVhZF9tdXRleF9sb2NrKCZnX211dGV4KTsKCiAgICBpZiAoZ19pbml0aWFsaXplZCkgewogICAgICAgIHB0aHJlYWRfbXV0ZXhfdW5sb2NrKCZnX211dGV4KTsKICAgICAgICByZXR1cm4gQ1VEQV9TVUNDRVNTOwogICAgfQoKICAgIC8qCiAgICAgKiBQaGFzZSAxIOKAlCBsaWdodHdlaWdodCBkZXZpY2Ugc2Nhbi4KICAgICAqCiAgICAgKiBPbmx5IHZlcmlmeSB0aGUgVkdQVS1TVFVCIFBDSSBkZXZpY2UgaXMgdmlzaWJsZSBpbiAvc3lzLiAgVGhpcwogICAgICogcmVxdWlyZXMgb25seSByZWFkIGFjY2VzcyB0byAvc3lzL2J1cy9wY2kvZGV2aWNlcy8sIHdoaWNoIHdvcmtzIGV2ZW4KICAgICAqIGluc2lkZSB0aGUgc3lzdGVtZCBzZXJ2aWNlIHNhbmRib3ggKFByb3RlY3RLZXJuZWxUdW5hYmxlcyBhcHBsaWVzIGEKICAgICAqIHJlYWQtb25seSBtb3VudCwgYnV0IHN5c2ZzIGRpcmVjdG9yeSBsaXN0aW5nIGlzIHN0aWxsIGFsbG93ZWQpLgogICAgICoKICAgICAqIFRoaXMgZGVsaWJlcmF0ZWx5IGRvZXMgTk9UIG9wZW4gcmVzb3VyY2UwIG9yIG1hcCBCQVIwLiAgVGhvc2Ugc3RlcHMKICAgICAqIGFyZSBkZWZlcnJlZCB0byBlbnN1cmVfY29ubmVjdGVkKCksIGNhbGxlZCBvbiB0aGUgZmlyc3QgcmVhbCBjb21wdXRlCiAgICAgKiBvcGVyYXRpb24gaW5zaWRlIHRoZSBpbmZlcmVuY2UgcnVubmVyIHN1YnByb2Nlc3MuCiAgICAgKi8KICAgIGlmIChjdWRhX3RyYW5zcG9ydF9kaXNjb3ZlcigpICE9IDApIHsKICAgICAgICBwdGhyZWFkX211dGV4X3VubG9jaygmZ19tdXRleCk7CiAgICAgICAgZnByaW50ZihzdGRlcnIsICJbbGlidmdwdS1jdWRhXSBjdUluaXQoKSBubyBWR1BVIGRldmljZSBmb3VuZCBpbiAvc3lzXG4iKTsKICAgICAgICByZXR1cm4gQ1VEQV9FUlJPUl9OT19ERVZJQ0U7CiAgICB9CgogICAgLyoKICAgICAqIFBvcHVsYXRlIGdfZ3B1X2luZm8gd2l0aCBHUFVfREVGQVVMVF8qIHZhbHVlcyBpbW1lZGlhdGVseS4KICAgICAqCiAgICAgKiBFdmVuIHRob3VnaCB0aGUgZnVsbCB0cmFuc3BvcnQgKEJBUjAgbW1hcCArIG1lZGlhdG9yIHNvY2tldCkgaXMKICAgICAqIGRlZmVycmVkIHRvIGVuc3VyZV9jb25uZWN0ZWQoKSwgT2xsYW1hJ3MgZGlzY292ZXJ5IGNvZGUgY2FsbHMKICAgICAqIGN1RGV2aWNlVG90YWxNZW0oKSwgY3VEZXZpY2VHZXROYW1lKCksIGFuZCBjdURldmljZUdldEF0dHJpYnV0ZSgpCiAgICAgKiByaWdodCBoZXJlIGluIHRoZSBwcm9iZSBwaGFzZSDigJQgYmVmb3JlIGFueSBjb21wdXRlIG9wIGZpcmVzLgogICAgICogV2l0aG91dCB0aGlzIGNhbGwgdGhvc2UgZnVuY3Rpb25zIHJldHVybiAwIC8gIiIgYmVjYXVzZSBnX2dwdV9pbmZvCiAgICAgKiBpcyBDLXplcm8taW5pdGlhbGlzZWQsIGFuZCBPbGxhbWEgZGlzY2FyZHMgYSBkZXZpY2Ugd2l0aCBDQz0wIG9yCiAgICAgKiBWUkFNPTAsIHVsdGltYXRlbHkgcmVwb3J0aW5nIGxpYnJhcnk9Y3B1LgogICAgICoKICAgICAqIGZldGNoX2dwdV9pbmZvKCkgd2lsbCBsYXRlciBvdmVyd3JpdGUgdGhlc2Ugd2l0aCBsaXZlIGhvc3QgdmFsdWVzCiAgICAgKiBvbmNlIGVuc3VyZV9jb25uZWN0ZWQoKSBzdWNjZWVkcyBpbiB0aGUgaW5mZXJlbmNlIHJ1bm5lci4KICAgICAqLwogICAgaW5pdF9ncHVfZGVmYXVsdHMoKTsKCiAgICBnX2RldmljZV9mb3VuZCA9IDE7CiAgICBnX2luaXRpYWxpemVkICA9IDE7CiAgICBnX2luX2luaXRfcGhhc2UgPSAxOyAgLyogU3RhcnQgaW4gaW5pdCBwaGFzZSAtIHdpbGwgYmUgY2xlYXJlZCBhZnRlciBmaXJzdCBjb250ZXh0IGNyZWF0aW9uICovCiAgICBwdGhyZWFkX211dGV4X3VubG9jaygmZ19tdXRleCk7CgogICAgZnByaW50ZihzdGRlcnIsCiAgICAgICAgICAgICJbbGlidmdwdS1jdWRhXSBjdUluaXQoKSBkZXZpY2UgZm91bmQgYXQgJXMg4oCUIHRyYW5zcG9ydCBkZWZlcnJlZCIKICAgICAgICAgICAgIiAoQ0M9JWQuJWQgVlJBTT0lbGx1IE1CLCBpbml0X3BoYXNlPTEpXG4iLAogICAgICAgICAgICBjdWRhX3RyYW5zcG9ydF9wY2lfYmRmKE5VTEwpLAogICAgICAgICAgICBnX2dwdV9pbmZvLmNvbXB1dGVfY2FwX21ham9yLAogICAgICAgICAgICBnX2dwdV9pbmZvLmNvbXB1dGVfY2FwX21pbm9yLAogICAgICAgICAgICAodW5zaWduZWQgbG9uZyBsb25nKShnX2dwdV9pbmZvLnRvdGFsX21lbSAvICgxMDI0ICogMTAyNCkpKTsKCiAgICAvKiBNaXJyb3Iga2V5IGV2ZW50IHRvIHRoZSBwZXItUElEIGxvZyBmaWxlLiAqLwogICAgewogICAgICAgIGNoYXIgbG9ncGF0aFsxMjhdOwogICAgICAgIHNucHJpbnRmKGxvZ3BhdGgsIHNpemVvZihsb2dwYXRoKSwKICAgICAgICAgICAgICAgICAiL3RtcC92Z3B1LXNoaW0tY3VkYS0lZC5sb2ciLCAoaW50KWdldHBpZCgpKTsKICAgICAgICBGSUxFICpsZiA9IGZvcGVuKGxvZ3BhdGgsICJhIik7CiAgICAgICAgaWYgKGxmKSB7CiAgICAgICAgICAgIGZwcmludGYobGYsCiAgICAgICAgICAgICAgICAgICAgIltsaWJ2Z3B1LWN1ZGFdIGN1SW5pdCgpIE9LOiBiZGY9JXMgQ0M9JWQuJWQgVlJBTT0lbGx1IE1CXG4iLAogICAgICAgICAgICAgICAgICAgIGN1ZGFfdHJhbnNwb3J0X3BjaV9iZGYoTlVMTCksCiAgICAgICAgICAgICAgICAgICAgZ19ncHVfaW5mby5jb21wdXRlX2NhcF9tYWpvciwKICAgICAgICAgICAgICAgICAgICBnX2dwdV9pbmZvLmNvbXB1dGVfY2FwX21pbm9yLAogICAgICAgICAgICAgICAgICAgICh1bnNpZ25lZCBsb25nIGxvbmcpKGdfZ3B1X2luZm8udG90YWxfbWVtIC8gKDEwMjQgKiAxMDI0KSkpOwogICAgICAgICAgICBmY2xvc2UobGYpOwogICAgICAgIH0KICAgIH0KICAgIHJldHVybiBDVURBX1NVQ0NFU1M7Cn0KCkNVcmVzdWx0IGN1R2V0UHJvY0FkZHJlc3MoY29uc3QgY2hhciAqc3ltYm9sLCB2b2lkICoqZnVuY1B0ciwgCiAgICAgICAgICAgICAgICAgICAgICAgICAgaW50IGN1ZGFWZXJzaW9uLCBjdXVpbnQ2NF90IGZsYWdzKQp7CiAgICBmcHJpbnRmKHN0ZGVyciwgIltsaWJ2Z3B1LWN1ZGFdIENBTExFRDogY3VHZXRQcm9jQWRkcmVzcyhzeW1ib2w9XCIlc1wiLCBjdWRhVmVyc2lvbj0lZCwgZmxhZ3M9MHglbGx4LCBpbml0X3BoYXNlPSVkKVxuIiwKICAgICAgICAgICAgc3ltYm9sID8gc3ltYm9sIDogIihudWxsKSIsIGN1ZGFWZXJzaW9uLCAodW5zaWduZWQgbG9uZyBsb25nKWZsYWdzLCBnX2luX2luaXRfcGhhc2UpOwogICAgZmZsdXNoKHN0ZGVycik7CiAgICAKICAgIGlmICghc3ltYm9sIHx8ICFmdW5jUHRyKSB7CiAgICAgICAgZnByaW50ZihzdGRlcnIsICJbbGlidmdwdS1jdWRhXSBjdUdldFByb2NBZGRyZXNzOiBpbnZhbGlkIGFyZ3VtZW50c1xuIik7CiAgICAgICAgcmV0dXJuIENVREFfRVJST1JfSU5WQUxJRF9WQUxVRTsKICAgIH0KICAgIAogICAgLyogUmVzb2x2ZSBmdW5jdGlvbiBwb2ludGVyIGZyb20gb3VyIHNoaW0uCiAgICAgKiBGaXJzdCB0cnkgdG8gZ2V0IGEgaGFuZGxlIHRvIG91ciBvd24gc2hpbSBsaWJyYXJ5LCB0aGVuIHVzZSBkbHN5bSBvbiB0aGF0LgogICAgICogVGhpcyBlbnN1cmVzIHdlIGZpbmQgZnVuY3Rpb25zIGluIG91ciBzaGltIGV2ZW4gaWYgdGhleSdyZSBub3QgaW4gdGhlIGdsb2JhbCBzY29wZS4gKi8KICAgIHN0YXRpYyB2b2lkICpzaGltX2hhbmRsZSA9IE5VTEw7CiAgICBpZiAoIXNoaW1faGFuZGxlKSB7CiAgICAgICAgLyogR2V0IGhhbmRsZSB0byBvdXIgb3duIHNoaW0gbGlicmFyeSAqLwogICAgICAgIHNoaW1faGFuZGxlID0gZGxvcGVuKCIvdXNyL2xpYjY0L2xpYnZncHUtY3VkYS5zbyIsIFJUTERfTEFaWSk7CiAgICAgICAgaWYgKCFzaGltX2hhbmRsZSkgewogICAgICAgICAgICAvKiBGYWxsYmFjazogdHJ5IHRvIGZpbmQgb3Vyc2VsdmVzIHZpYSBSVExEX0RFRkFVTFQgKi8KICAgICAgICAgICAgc2hpbV9oYW5kbGUgPSBkbG9wZW4oTlVMTCwgUlRMRF9MQVpZKTsKICAgICAgICB9CiAgICB9CiAgICAKICAgIGlmICghc2hpbV9oYW5kbGUpIHsKICAgICAgICBmcHJpbnRmKHN0ZGVyciwgIltsaWJ2Z3B1LWN1ZGFdIGN1R2V0UHJvY0FkZHJlc3M6IGZhaWxlZCB0byBnZXQgc2hpbSBoYW5kbGVcbiIpOwogICAgICAgIHJldHVybiBDVURBX0VSUk9SX1VOS05PV047CiAgICB9CiAgICAKICAgIC8qIFRyeSBtdWx0aXBsZSBtZXRob2RzIHRvIGZpbmQgdGhlIHN5bWJvbCAqLwogICAgdm9pZCAqZnVuYyA9IE5VTEw7CiAgICAKICAgIC8qIE1ldGhvZCAxOiBUcnkgZGxzeW0gb24gb3VyIHNoaW0gaGFuZGxlICovCiAgICBmdW5jID0gZGxzeW0oc2hpbV9oYW5kbGUsIHN5bWJvbCk7CiAgICAKICAgIC8qIE1ldGhvZCAyOiBJZiBub3QgZm91bmQsIHRyeSBSVExEX0RFRkFVTFQgKHNlYXJjaGVzIGFsbCBsb2FkZWQgbGlicmFyaWVzKSAqLwogICAgaWYgKCFmdW5jKSB7CiAgICAgICAgZnVuYyA9IGRsc3ltKFJUTERfREVGQVVMVCwgc3ltYm9sKTsKICAgIH0KICAgIAogICAgLyogTWV0aG9kIDM6IFRyeSBSVExEX05FWFQgKHNlYXJjaGVzIGxpYnJhcmllcyBsb2FkZWQgYWZ0ZXIgdGhpcyBvbmUpICovCiAgICBpZiAoIWZ1bmMpIHsKICAgICAgICBmdW5jID0gZGxzeW0oUlRMRF9ORVhULCBzeW1ib2wpOwogICAgfQogICAgCiAgICAvKiBNZXRob2QgNDogRHVyaW5nIGluaXRpYWxpemF0aW9uIHBoYXNlLCBwcm92aWRlIGRpcmVjdCBmdW5jdGlvbiBwb2ludGVycwogICAgICogZm9yIGNvbW1vbiBDVURBIGZ1bmN0aW9ucyB0aGF0IG1pZ2h0IGJlIHJlcXVlc3RlZC4gVGhpcyBlbnN1cmVzIHRoYXQKICAgICAqIGV2ZW4gaWYgZGxzeW0gZmFpbHMsIHdlIGNhbiBzdGlsbCBwcm92aWRlIHRoZSBmdW5jdGlvbi4gKi8KICAgIGlmICghZnVuYyAmJiBnX2luX2luaXRfcGhhc2UpIHsKICAgICAgICAvKiBQcm92aWRlIGRpcmVjdCBmdW5jdGlvbiBwb2ludGVycyBmb3IgY29tbW9uIGZ1bmN0aW9ucyAqLwogICAgICAgIHN0YXRpYyBzdHJ1Y3QgewogICAgICAgICAgICBjb25zdCBjaGFyICpuYW1lOwogICAgICAgICAgICB2b2lkICpmdW5jOwogICAgICAgIH0gc3R1Yl9mdW5jc1tdID0gewogICAgICAgICAgICB7ImN1RGV2aWNlR2V0UHJvcGVydGllcyIsICh2b2lkKiljdURldmljZUdldFByb3BlcnRpZXN9LAogICAgICAgICAgICB7ImN1RGV2aWNlR2V0UHJvcGVydGllc192MiIsICh2b2lkKiljdURldmljZUdldFByb3BlcnRpZXN9LAogICAgICAgICAgICB7ImN1Q3R4R2V0Q3VycmVudCIsICh2b2lkKiljdUN0eEdldEN1cnJlbnR9LAogICAgICAgICAgICB7ImN1Q3R4R2V0Q3VycmVudF92MiIsICh2b2lkKiljdUN0eEdldEN1cnJlbnR9LAogICAgICAgICAgICB7ImN1Q3R4UHVzaEN1cnJlbnQiLCAodm9pZCopY3VDdHhQdXNoQ3VycmVudF92Mn0sCiAgICAgICAgICAgIHsiY3VDdHhQdXNoQ3VycmVudF92MiIsICh2b2lkKiljdUN0eFB1c2hDdXJyZW50X3YyfSwKICAgICAgICAgICAgeyJjdUN0eFBvcEN1cnJlbnQiLCAodm9pZCopY3VDdHhQb3BDdXJyZW50X3YyfSwKICAgICAgICAgICAgeyJjdUN0eFBvcEN1cnJlbnRfdjIiLCAodm9pZCopY3VDdHhQb3BDdXJyZW50X3YyfSwKICAgICAgICAgICAgeyJjdUN0eFN5bmNocm9uaXplIiwgKHZvaWQqKWN1Q3R4U3luY2hyb25pemV9LAogICAgICAgICAgICB7ImN1Q3R4R2V0RGV2aWNlIiwgKHZvaWQqKWN1Q3R4R2V0RGV2aWNlfSwKICAgICAgICAgICAgeyJjdUN0eEdldERldmljZV92MiIsICh2b2lkKiljdUN0eEdldERldmljZV92Mn0sCiAgICAgICAgICAgIHsiY3VDdHhHZXRGbGFncyIsICh2b2lkKiljdUN0eEdldEZsYWdzfSwKICAgICAgICAgICAgeyJjdUN0eFNldExpbWl0IiwgKHZvaWQqKWN1Q3R4U2V0TGltaXR9LAogICAgICAgICAgICB7ImN1Q3R4R2V0TGltaXQiLCAodm9pZCopY3VDdHhHZXRMaW1pdH0sCiAgICAgICAgICAgIHsiY3VDdHhHZXRBcGlWZXJzaW9uIiwgKHZvaWQqKWN1Q3R4R2V0QXBpVmVyc2lvbn0sCiAgICAgICAgICAgIHsiY3VEZXZpY2VDb21wdXRlQ2FwYWJpbGl0eSIsICh2b2lkKiljdURldmljZUNvbXB1dGVDYXBhYmlsaXR5fSwKICAgICAgICAgICAgeyJjdURldmljZUdldEF0dHJpYnV0ZSIsICh2b2lkKiljdURldmljZUdldEF0dHJpYnV0ZX0sCiAgICAgICAgICAgIHsiY3VEZXZpY2VHZXRBdHRyaWJ1dGVfdjIiLCAodm9pZCopY3VEZXZpY2VHZXRBdHRyaWJ1dGVfdjJ9LAogICAgICAgICAgICB7ImN1RGV2aWNlR2V0TmFtZSIsICh2b2lkKiljdURldmljZUdldE5hbWV9LAogICAgICAgICAgICB7ImN1RGV2aWNlR2V0UENJQnVzSWQiLCAodm9pZCopY3VEZXZpY2VHZXRQQ0lCdXNJZH0sCiAgICAgICAgICAgIHsiY3VEZXZpY2VHZXRQQ0lCdXNJZF92MiIsICh2b2lkKiljdURldmljZUdldFBDSUJ1c0lkfSwKICAgICAgICAgICAgeyJjdURldmljZUdldENvdW50IiwgKHZvaWQqKWN1RGV2aWNlR2V0Q291bnR9LAogICAgICAgICAgICB7ImN1RGV2aWNlR2V0Q291bnRfdjIiLCAodm9pZCopY3VEZXZpY2VHZXRDb3VudH0sCiAgICAgICAgICAgIHsiY3VEZXZpY2VHZXQiLCAodm9pZCopY3VEZXZpY2VHZXR9LAogICAgICAgICAgICB7ImN1RGV2aWNlR2V0X3YyIiwgKHZvaWQqKWN1RGV2aWNlR2V0fSwKICAgICAgICAgICAgeyJjdURldmljZVRvdGFsTWVtIiwgKHZvaWQqKWN1RGV2aWNlVG90YWxNZW19LAogICAgICAgICAgICB7ImN1RGV2aWNlVG90YWxNZW1fdjIiLCAodm9pZCopY3VEZXZpY2VUb3RhbE1lbV92Mn0sCiAgICAgICAgICAgIHsiY3VEcml2ZXJHZXRWZXJzaW9uIiwgKHZvaWQqKWN1RHJpdmVyR2V0VmVyc2lvbn0sCiAgICAgICAgICAgIHsiY3VJbml0IiwgKHZvaWQqKWN1SW5pdH0sCiAgICAgICAgICAgIHsiY3VEZXZpY2VQcmltYXJ5Q3R4UmV0YWluIiwgKHZvaWQqKWN1RGV2aWNlUHJpbWFyeUN0eFJldGFpbn0sCiAgICAgICAgICAgIHsiY3VEZXZpY2VQcmltYXJ5Q3R4UmV0YWluX3YyIiwgKHZvaWQqKWN1RGV2aWNlUHJpbWFyeUN0eFJldGFpbn0sCiAgICAgICAgICAgIHsiY3VDdHhTZXRDdXJyZW50IiwgKHZvaWQqKWN1Q3R4U2V0Q3VycmVudH0sCiAgICAgICAgICAgIHsiY3VDdHhDcmVhdGUiLCAodm9pZCopY3VDdHhDcmVhdGV9LAogICAgICAgICAgICB7ImN1Q3R4Q3JlYXRlX3YyIiwgKHZvaWQqKWN1Q3R4Q3JlYXRlX3YyfSwKICAgICAgICAgICAgeyJjdUN0eENyZWF0ZV92MyIsICh2b2lkKiljdUN0eENyZWF0ZV92M30sCiAgICAgICAgICAgIHsiY3VEZXZpY2VHZXRUZXh0dXJlMURMaW5lYXJNYXhXaWR0aCIsICh2b2lkKiljdURldmljZUdldFRleHR1cmUxRExpbmVhck1heFdpZHRofSwKICAgICAgICAgICAgeyJjdURldmljZUdldE52U2NpU3luY0F0dHJpYnV0ZXMiLCAodm9pZCopY3VEZXZpY2VHZXROdlNjaVN5bmNBdHRyaWJ1dGVzfSwKICAgICAgICAgICAgeyJjdURldmljZUdldERlZmF1bHRNZW1Qb29sIiwgKHZvaWQqKWN1RGV2aWNlR2V0RGVmYXVsdE1lbVBvb2x9LAogICAgICAgICAgICB7ImN1RGV2aWNlR2V0TWVtUG9vbCIsICh2b2lkKiljdURldmljZUdldE1lbVBvb2x9LAogICAgICAgICAgICB7TlVMTCwgTlVMTH0KICAgICAgICB9OwogICAgICAgIAogICAgICAgIGZvciAoaW50IGkgPSAwOyBzdHViX2Z1bmNzW2ldLm5hbWU7IGkrKykgewogICAgICAgICAgICBpZiAoc3RyY21wKHN5bWJvbCwgc3R1Yl9mdW5jc1tpXS5uYW1lKSA9PSAwKSB7CiAgICAgICAgICAgICAgICBmdW5jID0gc3R1Yl9mdW5jc1tpXS5mdW5jOwogICAgICAgICAgICAgICAgZnByaW50ZihzdGRlcnIsICJbbGlidmdwdS1jdWRhXSBjdUdldFByb2NBZGRyZXNzOiBwcm92aWRpbmcgZGlyZWN0IHBvaW50ZXIgZm9yIFwiJXNcIiBkdXJpbmcgaW5pdCBwaGFzZVxuIiwgc3ltYm9sKTsKICAgICAgICAgICAgICAgIGZmbHVzaChzdGRlcnIpOwogICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgIH0KICAgICAgICB9CiAgICB9CiAgICAKICAgIC8qIENSSVRJQ0FMIEZJWDogRHVyaW5nIGluaXRpYWxpemF0aW9uIHBoYXNlLCBpZiB3ZSBzdGlsbCBoYXZlbid0IGZvdW5kCiAgICAgKiB0aGUgZnVuY3Rpb24sIHJldHVybiBhIGdlbmVyaWMgc3R1YiBmdW5jdGlvbiBwb2ludGVyIGluc3RlYWQgb2YgTk9UX0ZPVU5ELgogICAgICogVGhpcyBlbnN1cmVzIHRoYXQgZ2dtbF9iYWNrZW5kX2N1ZGFfaW5pdCBkb2Vzbid0IGZhaWwganVzdCBiZWNhdXNlCiAgICAgKiBpdCByZXF1ZXN0cyBhIGZ1bmN0aW9uIHdlIGhhdmVuJ3QgaW1wbGVtZW50ZWQgeWV0LgogICAgICogCiAgICAgKiBXZSB1c2UgYSB1bml2ZXJzYWwgc3R1YiBmdW5jdGlvbiB0aGF0IGNhbiBiZSBzYWZlbHkgY2FzdCB0byBhbnkgQ1VEQQogICAgICogZnVuY3Rpb24gc2lnbmF0dXJlLiBUaGUgc3R1YiB1c2VzIHZhcmlhZGljIGFyZ3VtZW50cyB0byBhY2NlcHQgYW55CiAgICAgKiBudW1iZXIgYW5kIHR5cGUgb2YgYXJndW1lbnRzLCBlbnN1cmluZyBjb21wYXRpYmlsaXR5IHdpdGggYWxsIENVREEKICAgICAqIGZ1bmN0aW9uIHNpZ25hdHVyZXMuCiAgICAgKi8KICAgIGlmICghZnVuYyAmJiBnX2luX2luaXRfcGhhc2UpIHsKICAgICAgICAvKiBVc2UgdGhlIGZpbGUtc2NvcGUgZ2VuZXJpYyBzdHViIGZ1bmN0aW9ucyBkZWZpbmVkIGFib3ZlLgogICAgICAgICAqIFRyeSB0byBndWVzcyB0aGUgc2lnbmF0dXJlIGJhc2VkIG9uIHRoZSBmdW5jdGlvbiBuYW1lIHBhdHRlcm4gKi8KICAgICAgICBpZiAoc3Ryc3RyKHN5bWJvbCwgIkdldCIpIHx8IHN0cnN0cihzeW1ib2wsICJRdWVyeSIpIHx8IHN0cnN0cihzeW1ib2wsICJSZXRhaW4iKSkgewogICAgICAgICAgICAvKiBRdWVyeS9HZXQgZnVuY3Rpb25zIHR5cGljYWxseSB0YWtlIDEtMiBhcmd1bWVudHMgKGRldmljZSArIG91dHB1dCkgKi8KICAgICAgICAgICAgZnVuYyA9ICh2b2lkKilnZW5lcmljX3N0dWJfMmFyZ3M7CiAgICAgICAgfSBlbHNlIGlmIChzdHJzdHIoc3ltYm9sLCAiU2V0IikgfHwgc3Ryc3RyKHN5bWJvbCwgIkNyZWF0ZSIpIHx8IHN0cnN0cihzeW1ib2wsICJBbGxvYyIpKSB7CiAgICAgICAgICAgIC8qIFNldC9DcmVhdGUvQWxsb2MgZnVuY3Rpb25zIHR5cGljYWxseSB0YWtlIDItMyBhcmd1bWVudHMgKi8KICAgICAgICAgICAgZnVuYyA9ICh2b2lkKilnZW5lcmljX3N0dWJfM2FyZ3M7CiAgICAgICAgfSBlbHNlIGlmIChzdHJzdHIoc3ltYm9sLCAiRGVzdHJveSIpIHx8IHN0cnN0cihzeW1ib2wsICJSZWxlYXNlIikgfHwgc3Ryc3RyKHN5bWJvbCwgIkZyZWUiKSkgewogICAgICAgICAgICAvKiBEZXN0cm95L1JlbGVhc2UvRnJlZSBmdW5jdGlvbnMgdHlwaWNhbGx5IHRha2UgMSBhcmd1bWVudCAqLwogICAgICAgICAgICBmdW5jID0gKHZvaWQqKWdlbmVyaWNfc3R1Yl8xcHRyOwogICAgICAgIH0gZWxzZSBpZiAoc3Ryc3RyKHN5bWJvbCwgIkxhdW5jaCIpIHx8IHN0cnN0cihzeW1ib2wsICJNZW1jcHkiKSkgewogICAgICAgICAgICAvKiBMYXVuY2gvTWVtY3B5IGZ1bmN0aW9ucyB0eXBpY2FsbHkgdGFrZSA0KyBhcmd1bWVudHMgKi8KICAgICAgICAgICAgZnVuYyA9ICh2b2lkKilnZW5lcmljX3N0dWJfNGFyZ3M7CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgLyogRGVmYXVsdDogdXNlIDItYXJnIHN0dWIgKG1vc3QgY29tbW9uIENVREEgcGF0dGVybikgKi8KICAgICAgICAgICAgZnVuYyA9ICh2b2lkKilnZW5lcmljX3N0dWJfMmFyZ3M7CiAgICAgICAgfQogICAgICAgIAogICAgICAgIGZwcmludGYoc3RkZXJyLCAiW2xpYnZncHUtY3VkYV0gY3VHZXRQcm9jQWRkcmVzczogcHJvdmlkaW5nIGdlbmVyaWMgc3R1YiBmb3IgXCIlc1wiIGR1cmluZyBpbml0IHBoYXNlXG4iLCBzeW1ib2wpOwogICAgICAgIGZmbHVzaChzdGRlcnIpOwogICAgfQogICAgCiAgICBpZiAoIWZ1bmMpIHsKICAgICAgICBmcHJpbnRmKHN0ZGVyciwgIltsaWJ2Z3B1LWN1ZGFdIGN1R2V0UHJvY0FkZHJlc3M6IHN5bWJvbCBcIiVzXCIgbm90IGZvdW5kIC0gUkVUVVJOSU5HIE5PVF9GT1VORFxuIiwgc3ltYm9sKTsKICAgICAgICBmZmx1c2goc3RkZXJyKTsKICAgICAgICByZXR1cm4gQ1VEQV9FUlJPUl9OT1RfRk9VTkQ7CiAgICB9CiAgICAKICAgICpmdW5jUHRyID0gZnVuYzsKICAgIGZwcmludGYoc3RkZXJyLCAiW2xpYnZncHUtY3VkYV0gY3VHZXRQcm9jQWRkcmVzczogcmVzb2x2ZWQgXCIlc1wiIC0+ICVwIC0gUkVUVVJOSU5HIFNVQ0NFU1MgKGluaXRfcGhhc2U9JWQpXG4iLCAKICAgICAgICAgICAgc3ltYm9sLCBmdW5jLCBnX2luX2luaXRfcGhhc2UpOwogICAgZmZsdXNoKHN0ZGVycik7CiAgICByZXR1cm4gQ1VEQV9TVUNDRVNTOwp9CgovKiA9PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09CiAqIENVREEgVmlydHVhbCBNZW1vcnkgTWFuYWdlbWVudCAoVk1NKSBBUEkgc3R1YnMKICogCiAqIGxpYmdnbWwtY3VkYS5zbyB1c2VzIHRoZXNlIGZ1bmN0aW9ucyBkdXJpbmcgaW5pdGlhbGl6YXRpb24uCiAqIEZvciBub3csIHJldHVybiBzdWNjZXNzIHdpdGggZHVtbXkgdmFsdWVzIHRvIGFsbG93IGluaXRpYWxpemF0aW9uCiAqIHRvIHByb2NlZWQuIEFjdHVhbCBtZW1vcnkgb3BlcmF0aW9ucyB3aWxsIGJlIGhhbmRsZWQgYnkgY3VNZW1BbGxvYwogKiBhbmQgcmVsYXRlZCBmdW5jdGlvbnMuCiAqID09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT0gKi8KCkNVcmVzdWx0IGN1TWVtQ3JlYXRlKENVbWVtR2VuZXJpY0FsbG9jYXRpb25IYW5kbGUgKmhhbmRsZSwgc2l6ZV90IHNpemUsCiAgICAgICAgICAgICAgICAgICAgIGNvbnN0IENVbWVtQWxsb2NhdGlvblByb3AgKnByb3AsIHVuc2lnbmVkIGxvbmcgbG9uZyBmbGFncykKewogICAgZnByaW50ZihzdGRlcnIsICJbbGlidmdwdS1jdWRhXSBDQUxMRUQ6IGN1TWVtQ3JlYXRlKGhhbmRsZT0lcCwgc2l6ZT0lenUsIGZsYWdzPTB4JWxseClcbiIsCiAgICAgICAgICAgIGhhbmRsZSwgc2l6ZSwgKHVuc2lnbmVkIGxvbmcgbG9uZylmbGFncyk7CiAgICAKICAgIENVcmVzdWx0IHJjID0gZW5zdXJlX2luaXQoKTsKICAgIGlmIChyYyAhPSBDVURBX1NVQ0NFU1MpIHJldHVybiByYzsKICAgIGlmICghaGFuZGxlKSByZXR1cm4gQ1VEQV9FUlJPUl9JTlZBTElEX1ZBTFVFOwogICAgCiAgICAvKiBSZXR1cm4gYSBkdW1teSBoYW5kbGUgLSBhY3R1YWwgYWxsb2NhdGlvbiBkZWZlcnJlZCB0byBjdU1lbUFsbG9jICovCiAgICAqaGFuZGxlID0gKENVbWVtR2VuZXJpY0FsbG9jYXRpb25IYW5kbGUpKHVpbnRwdHJfdCkweDEwMDA7CiAgICBmcHJpbnRmKHN0ZGVyciwgIltsaWJ2Z3B1LWN1ZGFdIGN1TWVtQ3JlYXRlIHJldHVybmluZyBTVUNDRVNTIChkdW1teSBoYW5kbGUpXG4iKTsKICAgIHJldHVybiBDVURBX1NVQ0NFU1M7Cn0KCkNVcmVzdWx0IGN1TWVtQWRkcmVzc1Jlc2VydmUoQ1VkZXZpY2VwdHIgKnB0ciwgc2l6ZV90IHNpemUsIHNpemVfdCBhbGlnbm1lbnQsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgQ1VkZXZpY2VwdHIgYWRkciwgdW5zaWduZWQgbG9uZyBsb25nIGZsYWdzKQp7CiAgICBmcHJpbnRmKHN0ZGVyciwgIltsaWJ2Z3B1LWN1ZGFdIENBTExFRDogY3VNZW1BZGRyZXNzUmVzZXJ2ZShwdHI9JXAsIHNpemU9JXp1LCBhbGlnbm1lbnQ9JXp1LCBmbGFncz0weCVsbHgpXG4iLAogICAgICAgICAgICBwdHIsIHNpemUsIGFsaWdubWVudCwgKHVuc2lnbmVkIGxvbmcgbG9uZylmbGFncyk7CiAgICAKICAgIENVcmVzdWx0IHJjID0gZW5zdXJlX2luaXQoKTsKICAgIGlmIChyYyAhPSBDVURBX1NVQ0NFU1MpIHJldHVybiByYzsKICAgIGlmICghcHRyKSByZXR1cm4gQ1VEQV9FUlJPUl9JTlZBTElEX1ZBTFVFOwogICAgCiAgICAvKiBSZXR1cm4gYSBkdW1teSBhZGRyZXNzIC0gYWN0dWFsIHJlc2VydmF0aW9uIGRlZmVycmVkICovCiAgICAqcHRyID0gKENVZGV2aWNlcHRyKTB4MTAwMDAwMDsKICAgIGZwcmludGYoc3RkZXJyLCAiW2xpYnZncHUtY3VkYV0gY3VNZW1BZGRyZXNzUmVzZXJ2ZSByZXR1cm5pbmcgU1VDQ0VTUyAoZHVtbXkgYWRkcmVzcylcbiIpOwogICAgcmV0dXJuIENVREFfU1VDQ0VTUzsKfQoKQ1VyZXN1bHQgY3VNZW1Vbm1hcChDVWRldmljZXB0ciBwdHIsIHNpemVfdCBzaXplKQp7CiAgICBmcHJpbnRmKHN0ZGVyciwgIltsaWJ2Z3B1LWN1ZGFdIENBTExFRDogY3VNZW1Vbm1hcChwdHI9MHglbGx4LCBzaXplPSV6dSlcbiIsCiAgICAgICAgICAgICh1bnNpZ25lZCBsb25nIGxvbmcpcHRyLCBzaXplKTsKICAgIAogICAgQ1VyZXN1bHQgcmMgPSBlbnN1cmVfaW5pdCgpOwogICAgaWYgKHJjICE9IENVREFfU1VDQ0VTUykgcmV0dXJuIHJjOwogICAgCiAgICAvKiBBbHdheXMgc3VjY2VlZCAtIHVubWFwcGluZyBpcyBhIG5vLW9wIGZvciBkdW1teSBhZGRyZXNzZXMgKi8KICAgIGZwcmludGYoc3RkZXJyLCAiW2xpYnZncHUtY3VkYV0gY3VNZW1Vbm1hcCByZXR1cm5pbmcgU1VDQ0VTU1xuIik7CiAgICByZXR1cm4gQ1VEQV9TVUNDRVNTOwp9CgpDVXJlc3VsdCBjdU1lbVNldEFjY2VzcyhDVWRldmljZXB0ciBwdHIsIHNpemVfdCBzaXplLAogICAgICAgICAgICAgICAgICAgICAgICBjb25zdCBDVW1lbUFjY2Vzc0Rlc2MgKmRlc2MsIHNpemVfdCBjb3VudCkKewogICAgZnByaW50ZihzdGRlcnIsICJbbGlidmdwdS1jdWRhXSBDQUxMRUQ6IGN1TWVtU2V0QWNjZXNzKHB0cj0weCVsbHgsIHNpemU9JXp1LCBjb3VudD0lenUpXG4iLAogICAgICAgICAgICAodW5zaWduZWQgbG9uZyBsb25nKXB0ciwgc2l6ZSwgY291bnQpOwogICAgCiAgICBDVXJlc3VsdCByYyA9IGVuc3VyZV9pbml0KCk7CiAgICBpZiAocmMgIT0gQ1VEQV9TVUNDRVNTKSByZXR1cm4gcmM7CiAgICAKICAgIC8qIEFsd2F5cyBzdWNjZWVkIC0gYWNjZXNzIGNvbnRyb2wgZGVmZXJyZWQgdG8gYWN0dWFsIG1lbW9yeSBvcHMgKi8KICAgIGZwcmludGYoc3RkZXJyLCAiW2xpYnZncHUtY3VkYV0gY3VNZW1TZXRBY2Nlc3MgcmV0dXJuaW5nIFNVQ0NFU1NcbiIpOwogICAgcmV0dXJuIENVREFfU1VDQ0VTUzsKfQoKQ1VyZXN1bHQgY3VNZW1BZGRyZXNzRnJlZShDVWRldmljZXB0ciBwdHIsIHNpemVfdCBzaXplKQp7CiAgICBmcHJpbnRmKHN0ZGVyciwgIltsaWJ2Z3B1LWN1ZGFdIENBTExFRDogY3VNZW1BZGRyZXNzRnJlZShwdHI9MHglbGx4LCBzaXplPSV6dSlcbiIsCiAgICAgICAgICAgICh1bnNpZ25lZCBsb25nIGxvbmcpcHRyLCBzaXplKTsKICAgIAogICAgQ1VyZXN1bHQgcmMgPSBlbnN1cmVfaW5pdCgpOwogICAgaWYgKHJjICE9IENVREFfU1VDQ0VTUykgcmV0dXJuIHJjOwogICAgCiAgICAvKiBBbHdheXMgc3VjY2VlZCAtIGZyZWVpbmcgaXMgYSBuby1vcCBmb3IgZHVtbXkgYWRkcmVzc2VzICovCiAgICBmcHJpbnRmKHN0ZGVyciwgIltsaWJ2Z3B1LWN1ZGFdIGN1TWVtQWRkcmVzc0ZyZWUgcmV0dXJuaW5nIFNVQ0NFU1NcbiIpOwogICAgcmV0dXJuIENVREFfU1VDQ0VTUzsKfQoKQ1VyZXN1bHQgY3VNZW1NYXAoQ1VkZXZpY2VwdHIgcHRyLCBzaXplX3Qgc2l6ZSwgc2l6ZV90IG9mZnNldCwKICAgICAgICAgICAgICAgICAgQ1VtZW1HZW5lcmljQWxsb2NhdGlvbkhhbmRsZSBoYW5kbGUsIHVuc2lnbmVkIGxvbmcgbG9uZyBmbGFncykKewogICAgZnByaW50ZihzdGRlcnIsICJbbGlidmdwdS1jdWRhXSBDQUxMRUQ6IGN1TWVtTWFwKHB0cj0weCVsbHgsIHNpemU9JXp1LCBvZmZzZXQ9JXp1LCBmbGFncz0weCVsbHgpXG4iLAogICAgICAgICAgICAodW5zaWduZWQgbG9uZyBsb25nKXB0ciwgc2l6ZSwgb2Zmc2V0LCAodW5zaWduZWQgbG9uZyBsb25nKWZsYWdzKTsKICAgIAogICAgQ1VyZXN1bHQgcmMgPSBlbnN1cmVfaW5pdCgpOwogICAgaWYgKHJjICE9IENVREFfU1VDQ0VTUykgcmV0dXJuIHJjOwogICAgCiAgICAvKiBBbHdheXMgc3VjY2VlZCAtIG1hcHBpbmcgZGVmZXJyZWQgdG8gYWN0dWFsIG1lbW9yeSBvcHMgKi8KICAgIGZwcmludGYoc3RkZXJyLCAiW2xpYnZncHUtY3VkYV0gY3VNZW1NYXAgcmV0dXJuaW5nIFNVQ0NFU1NcbiIpOwogICAgcmV0dXJuIENVREFfU1VDQ0VTUzsKfQoKQ1VyZXN1bHQgY3VNZW1SZWxlYXNlKENVbWVtR2VuZXJpY0FsbG9jYXRpb25IYW5kbGUgaGFuZGxlKQp7CiAgICBmcHJpbnRmKHN0ZGVyciwgIltsaWJ2Z3B1LWN1ZGFdIENBTExFRDogY3VNZW1SZWxlYXNlKGhhbmRsZT0lcClcbiIsIGhhbmRsZSk7CiAgICAKICAgIENVcmVzdWx0IHJjID0gZW5zdXJlX2luaXQoKTsKICAgIGlmIChyYyAhPSBDVURBX1NVQ0NFU1MpIHJldHVybiByYzsKICAgIAogICAgLyogQWx3YXlzIHN1Y2NlZWQgLSByZWxlYXNlIGRlZmVycmVkIHRvIGFjdHVhbCBtZW1vcnkgb3BzICovCiAgICBmcHJpbnRmKHN0ZGVyciwgIltsaWJ2Z3B1LWN1ZGFdIGN1TWVtUmVsZWFzZSByZXR1cm5pbmcgU1VDQ0VTU1xuIik7CiAgICByZXR1cm4gQ1VEQV9TVUNDRVNTOwp9CgpDVXJlc3VsdCBjdU1lbUdldEFsbG9jYXRpb25HcmFudWxhcml0eShzaXplX3QgKmdyYW51bGFyaXR5LAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBjb25zdCBDVW1lbUFsbG9jYXRpb25Qcm9wICpwcm9wLCB1bnNpZ25lZCBpbnQgb3B0aW9uKQp7CiAgICBmcHJpbnRmKHN0ZGVyciwgIltsaWJ2Z3B1LWN1ZGFdIENBTExFRDogY3VNZW1HZXRBbGxvY2F0aW9uR3JhbnVsYXJpdHkoZ3JhbnVsYXJpdHk9JXAsIG9wdGlvbj0weCV4KVxuIiwKICAgICAgICAgICAgZ3JhbnVsYXJpdHksIG9wdGlvbik7CiAgICAKICAgIENVcmVzdWx0IHJjID0gZW5zdXJlX2luaXQoKTsKICAgIGlmIChyYyAhPSBDVURBX1NVQ0NFU1MpIHJldHVybiByYzsKICAgIGlmICghZ3JhbnVsYXJpdHkpIHJldHVybiBDVURBX0VSUk9SX0lOVkFMSURfVkFMVUU7CiAgICAKICAgIC8qIFJldHVybiBhIHJlYXNvbmFibGUgZGVmYXVsdCBncmFudWxhcml0eSAoNjRLQikgKi8KICAgICpncmFudWxhcml0eSA9IDY0ICogMTAyNDsKICAgIGZwcmludGYoc3RkZXJyLCAiW2xpYnZncHUtY3VkYV0gY3VNZW1HZXRBbGxvY2F0aW9uR3JhbnVsYXJpdHkgcmV0dXJuaW5nIFNVQ0NFU1MgKGdyYW51bGFyaXR5PSV6dSlcbiIsCiAgICAgICAgICAgICpncmFudWxhcml0eSk7CiAgICByZXR1cm4gQ1VEQV9TVUNDRVNTOwp9CgovKiBjdUdldEVycm9yU3RyaW5nIGlzIGRlZmluZWQgbGF0ZXIgaW4gdGhlIGZpbGUgaW4gdGhlIEVycm9yIGhhbmRsaW5nIHNlY3Rpb24gKi8KCkNVcmVzdWx0IGN1RHJpdmVyR2V0VmVyc2lvbihpbnQgKmRyaXZlclZlcnNpb24pCnsKICAgIGZwcmludGYoc3RkZXJyLCAiW2xpYnZncHUtY3VkYV0gQ0FMTEVEOiBjdURyaXZlckdldFZlcnNpb24oZHJpdmVyVmVyc2lvbj0lcClcbiIsIGRyaXZlclZlcnNpb24pOwogICAgZmZsdXNoKHN0ZGVycik7CiAgICBpZiAoIWRyaXZlclZlcnNpb24pIHsKICAgICAgICBmcHJpbnRmKHN0ZGVyciwgIltsaWJ2Z3B1LWN1ZGFdIGN1RHJpdmVyR2V0VmVyc2lvbjogaW52YWxpZCBwb2ludGVyXG4iKTsKICAgICAgICBmZmx1c2goc3RkZXJyKTsKICAgICAgICByZXR1cm4gQ1VEQV9FUlJPUl9JTlZBTElEX1ZBTFVFOwogICAgfQogICAgLyogUmV0dXJuIGhvc3QgZHJpdmVyIHZlcnNpb24gaWYga25vd24sIGVsc2UgZGVmYXVsdCAqLwogICAgaWYgKGdfZ3B1X2luZm9fdmFsaWQgJiYgZ19ncHVfaW5mby5kcml2ZXJfdmVyc2lvbiA+IDApCiAgICAgICAgKmRyaXZlclZlcnNpb24gPSBnX2dwdV9pbmZvLmRyaXZlcl92ZXJzaW9uOwogICAgZWxzZQogICAgICAgICpkcml2ZXJWZXJzaW9uID0gR1BVX0RFRkFVTFRfRFJJVkVSX1ZFUlNJT047CiAgICBmcHJpbnRmKHN0ZGVyciwgIltsaWJ2Z3B1LWN1ZGFdIGN1RHJpdmVyR2V0VmVyc2lvbiBTVUNDRVNTOiB2ZXJzaW9uPSVkXG4iLCAqZHJpdmVyVmVyc2lvbik7CiAgICBmZmx1c2goc3RkZXJyKTsKICAgIHJldHVybiBDVURBX1NVQ0NFU1M7Cn0KCi8qID09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT0KICogQ1VEQSBEcml2ZXIgQVBJIOKAlCBEZXZpY2UgbWFuYWdlbWVudCAoYW5zd2VyZWQgbG9jYWxseSkKICogPT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PSAqLwoKQ1VyZXN1bHQgY3VEZXZpY2VHZXRDb3VudChpbnQgKmNvdW50KQp7CiAgICBmcHJpbnRmKHN0ZGVyciwgIltsaWJ2Z3B1LWN1ZGFdIGN1RGV2aWNlR2V0Q291bnQoKSBDQUxMRUQgKHBpZD0lZCwgY291bnQ9JXApXG4iLCAoaW50KWdldHBpZCgpLCBjb3VudCk7CiAgICBmZmx1c2goc3RkZXJyKTsKICAgIENVcmVzdWx0IHJjID0gZW5zdXJlX2luaXQoKTsKICAgIGlmIChyYyAhPSBDVURBX1NVQ0NFU1MpIHsKICAgICAgICBmcHJpbnRmKHN0ZGVyciwgIltsaWJ2Z3B1LWN1ZGFdIGN1RGV2aWNlR2V0Q291bnQoKSBlbnN1
cmVfaW5pdCgpIGZhaWxlZDogJWRcbiIsIHJjKTsKICAgICAgICBmZmx1c2goc3RkZXJyKTsKICAgICAgICByZXR1cm4gcmM7CiAgICB9CiAgICBpZiAoIWNvdW50KSB7CiAgICAgICAgZnByaW50ZihzdGRlcnIsICJbbGlidmdwdS1jdWRhXSBjdURldmljZUdldENvdW50KCkgaW52YWxpZCBwb2ludGVyXG4iKTsKICAgICAgICBmZmx1c2goc3RkZXJyKTsKICAgICAgICByZXR1cm4gQ1VEQV9FUlJPUl9JTlZBTElEX1ZBTFVFOwogICAgfQogICAgKmNvdW50ID0gMTsgIC8qIFdlIGFsd2F5cyBwcmVzZW50IGV4YWN0bHkgb25lIEdQVSAqLwogICAgZnByaW50ZihzdGRlcnIsICJbbGlidmdwdS1jdWRhXSBjdURldmljZUdldENvdW50KCkgU1VDQ0VTUzogcmV0dXJuaW5nIGNvdW50PTEgKHBpZD0lZClcbiIsIChpbnQpZ2V0cGlkKCkpOwogICAgZmZsdXNoKHN0ZGVycik7CiAgICByZXR1cm4gQ1VEQV9TVUNDRVNTOwp9CgovKiBfdjIgdmVyc2lvbiBpcyBpZGVudGljYWwgKi8KQ1VyZXN1bHQgY3VEZXZpY2VHZXRDb3VudF92MihpbnQgKmNvdW50KQp7CiAgICByZXR1cm4gY3VEZXZpY2VHZXRDb3VudChjb3VudCk7Cn0KCkNVcmVzdWx0IGN1RGV2aWNlR2V0KENVZGV2aWNlICpkZXZpY2UsIGludCBvcmRpbmFsKQp7CiAgICBmcHJpbnRmKHN0ZGVyciwgIltsaWJ2Z3B1LWN1ZGFdIENBTExFRDogY3VEZXZpY2VHZXQoZGV2aWNlPSVwLCBvcmRpbmFsPSVkKSAocGlkPSVkKVxuIiwgCiAgICAgICAgICAgIGRldmljZSwgb3JkaW5hbCwgKGludClnZXRwaWQoKSk7CiAgICBmZmx1c2goc3RkZXJyKTsKICAgIENVcmVzdWx0IHJjID0gZW5zdXJlX2luaXQoKTsKICAgIGlmIChyYyAhPSBDVURBX1NVQ0NFU1MpIHsKICAgICAgICBmcHJpbnRmKHN0ZGVyciwgIltsaWJ2Z3B1LWN1ZGFdIGN1RGV2aWNlR2V0IGVuc3VyZV9pbml0KCkgZmFpbGVkOiAlZCAocGlkPSVkKVxuIiwgcmMsIChpbnQpZ2V0cGlkKCkpOwogICAgICAgIGZmbHVzaChzdGRlcnIpOwogICAgICAgIHJldHVybiByYzsKICAgIH0KICAgIGlmICghZGV2aWNlKSB7CiAgICAgICAgZnByaW50ZihzdGRlcnIsICJbbGlidmdwdS1jdWRhXSBjdURldmljZUdldDogaW52YWxpZCBkZXZpY2UgcG9pbnRlciAocGlkPSVkKVxuIiwgKGludClnZXRwaWQoKSk7CiAgICAgICAgZmZsdXNoKHN0ZGVycik7CiAgICAgICAgcmV0dXJuIENVREFfRVJST1JfSU5WQUxJRF9WQUxVRTsKICAgIH0KICAgIGlmIChvcmRpbmFsICE9IDApIHsKICAgICAgICBmcHJpbnRmKHN0ZGVyciwgIltsaWJ2Z3B1LWN1ZGFdIGN1RGV2aWNlR2V0OiBpbnZhbGlkIGRldmljZSBvcmRpbmFsICVkIChwaWQ9JWQpXG4iLCBvcmRpbmFsLCAoaW50KWdldHBpZCgpKTsKICAgICAgICBmZmx1c2goc3RkZXJyKTsKICAgICAgICByZXR1cm4gQ1VEQV9FUlJPUl9JTlZBTElEX0RFVklDRTsKICAgIH0KICAgICpkZXZpY2UgPSAwOwogICAgZnByaW50ZihzdGRlcnIsICJbbGlidmdwdS1jdWRhXSBjdURldmljZUdldCBTVUNDRVNTOiByZXR1cm5pbmcgZGV2aWNlPTAgKHBpZD0lZClcbiIsIChpbnQpZ2V0cGlkKCkpOwogICAgZmZsdXNoKHN0ZGVycik7CiAgICByZXR1cm4gQ1VEQV9TVUNDRVNTOwp9CgovKiBfdjIgdmVyc2lvbiBpcyBpZGVudGljYWwgKi8KQ1VyZXN1bHQgY3VEZXZpY2VHZXRfdjIoQ1VkZXZpY2UgKmRldmljZSwgaW50IG9yZGluYWwpCnsKICAgIHJldHVybiBjdURldmljZUdldChkZXZpY2UsIG9yZGluYWwpOwp9CgpDVXJlc3VsdCBjdURldmljZUdldE5hbWUoY2hhciAqbmFtZSwgaW50IGxlbiwgQ1VkZXZpY2UgZGV2KQp7CiAgICBmcHJpbnRmKHN0ZGVyciwgIltsaWJ2Z3B1LWN1ZGFdIENBTExFRDogY3VEZXZpY2VHZXROYW1lKG5hbWU9JXAsIGxlbj0lZCwgZGV2PSVkKSAocGlkPSVkKVxuIiwKICAgICAgICAgICAgbmFtZSwgbGVuLCBkZXYsIChpbnQpZ2V0cGlkKCkpOwogICAgZmZsdXNoKHN0ZGVycik7CiAgICBDVXJlc3VsdCByYyA9IGVuc3VyZV9pbml0KCk7CiAgICBpZiAocmMgIT0gQ1VEQV9TVUNDRVNTKSB7CiAgICAgICAgZnByaW50ZihzdGRlcnIsICJbbGlidmdwdS1jdWRhXSBjdURldmljZUdldE5hbWUgZW5zdXJlX2luaXQoKSBmYWlsZWQ6ICVkXG4iLCByYyk7CiAgICAgICAgZmZsdXNoKHN0ZGVycik7CiAgICAgICAgcmV0dXJuIHJjOwogICAgfQogICAgaWYgKCFuYW1lIHx8IGxlbiA8PSAwKSB7CiAgICAgICAgZnByaW50ZihzdGRlcnIsICJbbGlidmdwdS1jdWRhXSBjdURldmljZUdldE5hbWU6IGludmFsaWQgYXJndW1lbnRzXG4iKTsKICAgICAgICBmZmx1c2goc3RkZXJyKTsKICAgICAgICByZXR1cm4gQ1VEQV9FUlJPUl9JTlZBTElEX1ZBTFVFOwogICAgfQogICAgaWYgKGRldiAhPSAwKSB7CiAgICAgICAgZnByaW50ZihzdGRlcnIsICJbbGlidmdwdS1jdWRhXSBjdURldmljZUdldE5hbWU6IGludmFsaWQgZGV2aWNlICVkXG4iLCBkZXYpOwogICAgICAgIGZmbHVzaChzdGRlcnIpOwogICAgICAgIHJldHVybiBDVURBX0VSUk9SX0lOVkFMSURfREVWSUNFOwogICAgfQoKICAgIHN0cm5jcHkobmFtZSwgZ19ncHVfaW5mby5uYW1lLCAoc2l6ZV90KWxlbiAtIDEpOwogICAgbmFtZVtsZW4gLSAxXSA9ICdcMCc7CiAgICBmcHJpbnRmKHN0ZGVyciwgIltsaWJ2Z3B1LWN1ZGFdIGN1RGV2aWNlR2V0TmFtZSBTVUNDRVNTOiByZXR1cm5pbmcgbmFtZT1cIiVzXCJcbiIsIG5hbWUpOwogICAgZmZsdXNoKHN0ZGVycik7CiAgICByZXR1cm4gQ1VEQV9TVUNDRVNTOwp9CgpDVXJlc3VsdCBjdURldmljZVRvdGFsTWVtX3YyKHNpemVfdCAqYnl0ZXMsIENVZGV2aWNlIGRldikKewogICAgZnByaW50ZihzdGRlcnIsICJbbGlidmdwdS1jdWRhXSBjdURldmljZVRvdGFsTWVtX3YyKCkgQ0FMTEVEIChwaWQ9JWQgZGV2PSVkKVxuIiwgKGludClnZXRwaWQoKSwgZGV2KTsKICAgIGZmbHVzaChzdGRlcnIpOwogICAgQ1VyZXN1bHQgcmMgPSBlbnN1cmVfaW5pdCgpOwogICAgaWYgKHJjICE9IENVREFfU1VDQ0VTUykgewogICAgICAgIGZwcmludGYoc3RkZXJyLCAiW2xpYnZncHUtY3VkYV0gY3VEZXZpY2VUb3RhbE1lbV92MiBlbnN1cmVfaW5pdCgpIGZhaWxlZDogJWRcbiIsIHJjKTsKICAgICAgICBmZmx1c2goc3RkZXJyKTsKICAgICAgICByZXR1cm4gcmM7CiAgICB9CiAgICBpZiAoIWJ5dGVzKSB7CiAgICAgICAgZnByaW50ZihzdGRlcnIsICJbbGlidmdwdS1jdWRhXSBjdURldmljZVRvdGFsTWVtX3YyOiBpbnZhbGlkIHBvaW50ZXJcbiIpOwogICAgICAgIGZmbHVzaChzdGRlcnIpOwogICAgICAgIHJldHVybiBDVURBX0VSUk9SX0lOVkFMSURfVkFMVUU7CiAgICB9CiAgICBpZiAoZGV2ICE9IDApIHsKICAgICAgICBmcHJpbnRmKHN0ZGVyciwgIltsaWJ2Z3B1LWN1ZGFdIGN1RGV2aWNlVG90YWxNZW1fdjI6IGludmFsaWQgZGV2aWNlICVkXG4iLCBkZXYpOwogICAgICAgIGZmbHVzaChzdGRlcnIpOwogICAgICAgIHJldHVybiBDVURBX0VSUk9SX0lOVkFMSURfREVWSUNFOwogICAgfQogICAgKmJ5dGVzID0gKHNpemVfdClnX2dwdV9pbmZvLnRvdGFsX21lbTsKICAgIGZwcmludGYoc3RkZXJyLCAiW2xpYnZncHUtY3VkYV0gY3VEZXZpY2VUb3RhbE1lbV92MigpIFNVQ0NFU1M6IHJldHVybmluZyAlenUgYnl0ZXMgKCV6dSBNQikgKHBpZD0lZClcbiIsIAogICAgICAgICAgICAqYnl0ZXMsICpieXRlcyAvICgxMDI0ICogMTAyNCksIChpbnQpZ2V0cGlkKCkpOwogICAgZmZsdXNoKHN0ZGVycik7CiAgICByZXR1cm4gQ1VEQV9TVUNDRVNTOwp9CgovKiBMZWdhY3kgdmVyc2lvbiAqLwpDVXJlc3VsdCBjdURldmljZVRvdGFsTWVtKHNpemVfdCAqYnl0ZXMsIENVZGV2aWNlIGRldikKewogICAgcmV0dXJuIGN1RGV2aWNlVG90YWxNZW1fdjIoYnl0ZXMsIGRldik7Cn0KCkNVcmVzdWx0IGN1RGV2aWNlR2V0QXR0cmlidXRlKGludCAqcGksIENVZGV2aWNlX2F0dHJpYnV0ZSBhdHRyaWIsIENVZGV2aWNlIGRldikKewogICAgZnByaW50ZihzdGRlcnIsICJbbGlidmdwdS1jdWRhXSBDQUxMRUQ6IGN1RGV2aWNlR2V0QXR0cmlidXRlKHBpPSVwLCBhdHRyaWI9JWQsIGRldj0lZClcbiIsIHBpLCBhdHRyaWIsIGRldik7CiAgICBDVXJlc3VsdCByYyA9IGVuc3VyZV9pbml0KCk7CiAgICBpZiAocmMgIT0gQ1VEQV9TVUNDRVNTKSB7CiAgICAgICAgZnByaW50ZihzdGRlcnIsICJbbGlidmdwdS1jdWRhXSBjdURldmljZUdldEF0dHJpYnV0ZSBlbnN1cmVfaW5pdCgpIGZhaWxlZDogJWRcbiIsIHJjKTsKICAgICAgICByZXR1cm4gcmM7CiAgICB9CiAgICBpZiAoIXBpKSB7CiAgICAgICAgZnByaW50ZihzdGRlcnIsICJbbGlidmdwdS1jdWRhXSBjdURldmljZUdldEF0dHJpYnV0ZTogaW52YWxpZCBwb2ludGVyXG4iKTsKICAgICAgICByZXR1cm4gQ1VEQV9FUlJPUl9JTlZBTElEX1ZBTFVFOwogICAgfQogICAgaWYgKGRldiAhPSAwKSB7CiAgICAgICAgZnByaW50ZihzdGRlcnIsICJbbGlidmdwdS1jdWRhXSBjdURldmljZUdldEF0dHJpYnV0ZTogaW52YWxpZCBkZXZpY2UgJWRcbiIsIGRldik7CiAgICAgICAgcmV0dXJuIENVREFfRVJST1JfSU5WQUxJRF9ERVZJQ0U7CiAgICB9CgogICAgc3dpdGNoIChhdHRyaWIpIHsKICAgIGNhc2UgQ1VfREVWSUNFX0FUVFJJQlVURV9NQVhfVEhSRUFEU19QRVJfQkxPQ0s6CiAgICAgICAgKnBpID0gZ19ncHVfaW5mby5tYXhfdGhyZWFkc19wZXJfYmxvY2s7IGJyZWFrOwogICAgY2FzZSBDVV9ERVZJQ0VfQVRUUklCVVRFX01BWF9CTE9DS19ESU1fWDoKICAgICAgICAqcGkgPSBnX2dwdV9pbmZvLm1heF9ibG9ja19kaW1feDsgYnJlYWs7CiAgICBjYXNlIENVX0RFVklDRV9BVFRSSUJVVEVfTUFYX0JMT0NLX0RJTV9ZOgogICAgICAgICpwaSA9IGdfZ3B1X2luZm8ubWF4X2Jsb2NrX2RpbV95OyBicmVhazsKICAgIGNhc2UgQ1VfREVWSUNFX0FUVFJJQlVURV9NQVhfQkxPQ0tfRElNX1o6CiAgICAgICAgKnBpID0gZ19ncHVfaW5mby5tYXhfYmxvY2tfZGltX3o7IGJyZWFrOwogICAgY2FzZSBDVV9ERVZJQ0VfQVRUUklCVVRFX01BWF9HUklEX0RJTV9YOgogICAgICAgICpwaSA9IGdfZ3B1X2luZm8ubWF4X2dyaWRfZGltX3g7IGJyZWFrOwogICAgY2FzZSBDVV9ERVZJQ0VfQVRUUklCVVRFX01BWF9HUklEX0RJTV9ZOgogICAgICAgICpwaSA9IGdfZ3B1X2luZm8ubWF4X2dyaWRfZGltX3k7IGJyZWFrOwogICAgY2FzZSBDVV9ERVZJQ0VfQVRUUklCVVRFX01BWF9HUklEX0RJTV9aOgogICAgICAgICpwaSA9IGdfZ3B1X2luZm8ubWF4X2dyaWRfZGltX3o7IGJyZWFrOwogICAgY2FzZSBDVV9ERVZJQ0VfQVRUUklCVVRFX01BWF9TSEFSRURfTUVNT1JZX1BFUl9CTE9DSzoKICAgICAgICAqcGkgPSBnX2dwdV9pbmZvLm1heF9zaGFyZWRfbWVtX3Blcl9ibG9jazsgYnJlYWs7CiAgICBjYXNlIENVX0RFVklDRV9BVFRSSUJVVEVfVE9UQUxfQ09OU1RBTlRfTUVNT1JZOgogICAgICAgICpwaSA9IEdQVV9ERUZBVUxUX1RPVEFMX0NPTlNUQU5UX01FTTsgYnJlYWs7CiAgICBjYXNlIENVX0RFVklDRV9BVFRSSUJVVEVfV0FSUF9TSVpFOgogICAgICAgICpwaSA9IGdfZ3B1X2luZm8ud2FycF9zaXplOyBicmVhazsKICAgIGNhc2UgQ1VfREVWSUNFX0FUVFJJQlVURV9NQVhfUElUQ0g6CiAgICAgICAgKnBpID0gR1BVX0RFRkFVTFRfTUFYX1BJVENIOyBicmVhazsKICAgIGNhc2UgQ1VfREVWSUNFX0FUVFJJQlVURV9NQVhfUkVHSVNURVJTX1BFUl9CTE9DSzoKICAgICAgICAqcGkgPSBnX2dwdV9pbmZvLnJlZ3NfcGVyX2Jsb2NrOyBicmVhazsKICAgIGNhc2UgQ1VfREVWSUNFX0FUVFJJQlVURV9DTE9DS19SQVRFOgogICAgICAgICpwaSA9IGdfZ3B1X2luZm8uY2xvY2tfcmF0ZV9raHo7IGJyZWFrOwogICAgY2FzZSBDVV9ERVZJQ0VfQVRUUklCVVRFX1RFWFRVUkVfQUxJR05NRU5UOgogICAgICAgICpwaSA9IEdQVV9ERUZBVUxUX1RFWFRVUkVfQUxJR05NRU5UOyBicmVhazsKICAgIGNhc2UgQ1VfREVWSUNFX0FUVFJJQlVURV9NVUxUSVBST0NFU1NPUl9DT1VOVDoKICAgICAgICAqcGkgPSBnX2dwdV9pbmZvLm11bHRpX3Byb2Nlc3Nvcl9jb3VudDsgYnJlYWs7CiAgICBjYXNlIENVX0RFVklDRV9BVFRSSUJVVEVfS0VSTkVMX0VYRUNfVElNRU9VVDoKICAgICAgICAqcGkgPSAwOyBicmVhazsgIC8qIE5vIHRpbWVvdXQgKi8KICAgIGNhc2UgQ1VfREVWSUNFX0FUVFJJQlVURV9JTlRFR1JBVEVEOgogICAgICAgICpwaSA9IEdQVV9ERUZBVUxUX0lOVEVHUkFURUQ7IGJyZWFrOwogICAgY2FzZSBDVV9ERVZJQ0VfQVRUUklCVVRFX0NBTl9NQVBfSE9TVF9NRU1PUlk6CiAgICAgICAgKnBpID0gR1BVX0RFRkFVTFRfQ0FOX01BUF9IT1NUX01FTTsgYnJlYWs7CiAgICBjYXNlIENVX0RFVklDRV9BVFRSSUJVVEVfQ09NUFVURV9NT0RFOgogICAgICAgICpwaSA9IEdQVV9ERUZBVUxUX0NPTVBVVEVfTU9ERTsgYnJlYWs7CiAgICBjYXNlIENVX0RFVklDRV9BVFRSSUJVVEVfTUFYX1RFWFRVUkUxRF9XSURUSDoKICAgICAgICAqcGkgPSBHUFVfREVGQVVMVF9NQVhfVEVYVFVSRV8xRDsgYnJlYWs7CiAgICBjYXNlIENVX0RFVklDRV9BVFRSSUJVVEVfTUFYX1RFWFRVUkUyRF9XSURUSDoKICAgICAgICAqcGkgPSBHUFVfREVGQVVMVF9NQVhfVEVYVFVSRV8yRF9XOyBicmVhazsKICAgIGNhc2UgQ1VfREVWSUNFX0FUVFJJQlVURV9NQVhfVEVYVFVSRTJEX0hFSUdIVDoKICAgICAgICAqcGkgPSBHUFVfREVGQVVMVF9NQVhfVEVYVFVSRV8yRF9IOyBicmVhazsKICAgIGNhc2UgQ1VfREVWSUNFX0FUVFJJQlVURV9NQVhfVEVYVFVSRTNEX1dJRFRIOgogICAgICAgICpwaSA9IEdQVV9ERUZBVUxUX01BWF9URVhUVVJFXzNEX1c7IGJyZWFrOwogICAgY2FzZSBDVV9ERVZJQ0VfQVRUUklCVVRFX01BWF9URVhUVVJFM0RfSEVJR0hUOgogICAgICAgICpwaSA9IEdQVV9ERUZBVUxUX01BWF9URVhUVVJFXzNEX0g7IGJyZWFrOwogICAgY2FzZSBDVV9ERVZJQ0VfQVRUUklCVVRFX01BWF9URVhUVVJFM0RfREVQVEg6CiAgICAgICAgKnBpID0gR1BVX0RFRkFVTFRfTUFYX1RFWFRVUkVfM0RfRDsgYnJlYWs7CiAgICBjYXNlIENVX0RFVklDRV9BVFRSSUJVVEVfQ09OQ1VSUkVOVF9LRVJORUxTOgogICAgICAgICpwaSA9IGdfZ3B1X2luZm8uY29uY3VycmVudF9rZXJuZWxzOyBicmVhazsKICAgIGNhc2UgQ1VfREVWSUNFX0FUVFJJQlVURV9FQ0NfRU5BQkxFRDoKICAgICAgICAqcGkgPSBnX2dwdV9pbmZvLmVjY19lbmFibGVkOyBicmVhazsKICAgIGNhc2UgQ1VfREVWSUNFX0FUVFJJQlVURV9QQ0lfQlVTX0lEOgogICAgICAgICpwaSA9IGdfZ3B1X2luZm8ucGNpX2J1c19pZDsgYnJlYWs7CiAgICBjYXNlIENVX0RFVklDRV9BVFRSSUJVVEVfUENJX0RFVklDRV9JRDoKICAgICAgICAqcGkgPSBnX2dwdV9pbmZvLnBjaV9kZXZpY2VfaWQ7IGJyZWFrOwogICAgY2FzZSBDVV9ERVZJQ0VfQVRUUklCVVRFX01FTU9SWV9DTE9DS19SQVRFOgogICAgICAgICpwaSA9IGdfZ3B1X2luZm8ubWVtb3J5X2Nsb2NrX3JhdGVfa2h6OyBicmVhazsKICAgIGNhc2UgQ1VfREVWSUNFX0FUVFJJQlVURV9HTE9CQUxfTUVNT1JZX0JVU19XSURUSDoKICAgICAgICAqcGkgPSBnX2dwdV9pbmZvLm1lbW9yeV9idXNfd2lkdGg7IGJyZWFrOwogICAgY2FzZSBDVV9ERVZJQ0VfQVRUUklCVVRFX0wyX0NBQ0hFX1NJWkU6CiAgICAgICAgKnBpID0gZ19ncHVfaW5mby5sMl9jYWNoZV9zaXplOyBicmVhazsKICAgIGNhc2UgQ1VfREVWSUNFX0FUVFJJQlVURV9NQVhfVEhSRUFEU19QRVJfTVVMVElQUk9DRVNTT1I6CiAgICAgICAgKnBpID0gZ19ncHVfaW5mby5tYXhfdGhyZWFkc19wZXJfbXA7IGJyZWFrOwogICAgY2FzZSBDVV9ERVZJQ0VfQVRUUklCVVRFX0FTWU5DX0VOR0lORV9DT1VOVDoKICAgICAgICAqcGkgPSBnX2dwdV9pbmZvLmFzeW5jX2VuZ2luZV9jb3VudDsgYnJlYWs7CiAgICBjYXNlIENVX0RFVklDRV9BVFRSSUJVVEVfVU5JRklFRF9BRERSRVNTSU5HOgogICAgICAgICpwaSA9IGdfZ3B1X2luZm8udW5pZmllZF9hZGRyZXNzaW5nOyBicmVhazsKICAgIGNhc2UgQ1VfREVWSUNFX0FUVFJJQlVURV9QQ0lfRE9NQUlOX0lEOgogICAgICAgICpwaSA9IGdfZ3B1X2luZm8ucGNpX2RvbWFpbl9pZDsgYnJlYWs7CiAgICBjYXNlIENVX0RFVklDRV9BVFRSSUJVVEVfQ09NUFVURV9DQVBBQklMSVRZX01BSk9SOgogICAgICAgICpwaSA9IGdfZ3B1X2luZm8uY29tcHV0ZV9jYXBfbWFqb3I7IGJyZWFrOwogICAgY2FzZSBDVV9ERVZJQ0VfQVRUUklCVVRFX0NPTVBVVEVfQ0FQQUJJTElUWV9NSU5PUjoKICAgICAgICAqcGkgPSBnX2dwdV9pbmZvLmNvbXB1dGVfY2FwX21pbm9yOyBicmVhazsKICAgIGNhc2UgQ1VfREVWSUNFX0FUVFJJQlVURV9NQU5BR0VEX01FTU9SWToKICAgICAgICAqcGkgPSBnX2dwdV9pbmZvLm1hbmFnZWRfbWVtb3J5OyBicmVhazsKICAgIGNhc2UgQ1VfREVWSUNFX0FUVFJJQlVURV9NVUxUSV9HUFVfQk9BUkQ6CiAgICAgICAgKnBpID0gR1BVX0RFRkFVTFRfTVVMVElfR1BVX0JPQVJEOyBicmVhazsKICAgIGNhc2UgQ1VfREVWSUNFX0FUVFJJQlVURV9DT09QRVJBVElWRV9MQVVOQ0g6CiAgICAgICAgKnBpID0gR1BVX0RFRkFVTFRfQ09PUEVSQVRJVkVfTEFVTkNIOyBicmVhazsKICAgIGNhc2UgQ1VfREVWSUNFX0FUVFJJQlVURV9NQVhfU0hBUkVEX01FTU9SWV9QRVJfTVVMVElQUk9DRVNTT1I6CiAgICAgICAgKnBpID0gZ19ncHVfaW5mby5tYXhfc2hhcmVkX21lbV9wZXJfbXA7IGJyZWFrOwogICAgY2FzZSBDVV9ERVZJQ0VfQVRUUklCVVRFX01BWF9SRUdJU1RFUlNfUEVSX01VTFRJUFJPQ0VTU09SOgogICAgICAgICpwaSA9IGdfZ3B1X2luZm8ucmVnc19wZXJfbXVsdGlwcm9jZXNzb3I7IGJyZWFrOwogICAgY2FzZSBDVV9ERVZJQ0VfQVRUUklCVVRFX01BWF9TSEFSRURfTUVNT1JZX1BFUl9CTE9DS19PUFRJTjoKICAgICAgICAqcGkgPSBnX2dwdV9pbmZvLm1heF9zaGFyZWRfbWVtX3Blcl9ibG9jazsgYnJlYWs7CiAgICBjYXNlIENVX0RFVklDRV9BVFRSSUJVVEVfR0xPQkFMX0wxX0NBQ0hFX1NVUFBPUlRFRDoKICAgICAgICAqcGkgPSBHUFVfREVGQVVMVF9HTE9CQUxfTDFfQ0FDSEVfU1VQUE9SVDsgYnJlYWs7CiAgICBjYXNlIENVX0RFVklDRV9BVFRSSUJVVEVfTE9DQUxfTDFfQ0FDSEVfU1VQUE9SVEVEOgogICAgICAgICpwaSA9IEdQVV9ERUZBVUxUX0xPQ0FMX0wxX0NBQ0hFX1NVUFBPUlQ7IGJyZWFrOwogICAgZGVmYXVsdDoKICAgICAgICAvKiBSZXR1cm4gMCBmb3IgdW5rbm93biBhdHRyaWJ1dGVzIChiZXR0ZXIgdGhhbiBmYWlsaW5nKSAqLwogICAgICAgIGZwcmludGYoc3RkZXJyLCAiW2xpYnZncHUtY3VkYV0gY3VEZXZpY2VHZXRBdHRyaWJ1dGU6IHVua25vd24gYXR0cmlidXRlICVkLCByZXR1cm5pbmcgMFxuIiwgYXR0cmliKTsKICAgICAgICAqcGkgPSAwOwogICAgICAgIGJyZWFrOwogICAgfQogICAgZnByaW50ZihzdGRlcnIsICJbbGlidmdwdS1jdWRhXSBjdURldmljZUdldEF0dHJpYnV0ZSBTVUNDRVNTOiBhdHRyaWI9JWQsIHZhbHVlPSVkXG4iLCBhdHRyaWIsICpwaSk7CiAgICByZXR1cm4gQ1VEQV9TVUNDRVNTOwp9CgovKiBfdjIgdmVyc2lvbiBpcyBpZGVudGljYWwgKi8KQ1VyZXN1bHQgY3VEZXZpY2VHZXRBdHRyaWJ1dGVfdjIoaW50ICpwaSwgQ1VkZXZpY2VfYXR0cmlidXRlIGF0dHJpYiwgQ1VkZXZpY2UgZGV2KQp7CiAgICByZXR1cm4gY3VEZXZpY2VHZXRBdHRyaWJ1dGUocGksIGF0dHJpYiwgZGV2KTsKfQoKQ1VyZXN1bHQgY3VEZXZpY2VHZXRVdWlkKHZvaWQgKnV1aWQsIENVZGV2aWNlIGRldikKewogICAgQ1VyZXN1bHQgcmMgPSBlbnN1cmVfaW5pdCgpOwogICAgaWYgKHJjICE9IENVREFfU1VDQ0VTUykgcmV0dXJuIHJjOwogICAgaWYgKCF1dWlkKSByZXR1cm4gQ1VEQV9FUlJPUl9JTlZBTElEX1ZBTFVFOwogICAgaWYgKGRldiAhPSAwKSByZXR1cm4gQ1VEQV9FUlJPUl9JTlZBTElEX0RFVklDRTsKICAgIG1lbWNweSh1dWlkLCBnX2dwdV9pbmZvLnV1aWQsIDE2KTsKICAgIHJldHVybiBDVURBX1NVQ0NFU1M7Cn0KCkNVcmVzdWx0IGN1RGV2aWNlR2V0VXVpZF92Mih2b2lkICp1dWlkLCBDVWRldmljZSBkZXYpCnsKICAgIHJldHVybiBjdURldmljZUdldFV1aWQodXVpZCwgZGV2KTsKfQoKLyogY3VEZXZpY2VHZXRMdWlkIC0gR2V0IExVSUQgZm9yIGRldmljZSAodXNlZCBmb3IgbXVsdGktR1BVIHNldHVwcykgKi8KQ1VyZXN1bHQgY3VEZXZpY2VHZXRMdWlkKGNoYXIgKmx1aWQsIHVuc2lnbmVkIGludCAqZGV2aWNlTm9kZU1hc2ssIENVZGV2aWNlIGRldikKewogICAgZnByaW50ZihzdGRlcnIsICJbbGlidmdwdS1jdWRhXSBDQUxMRUQ6IGN1RGV2aWNlR2V0THVpZChsdWlkPSVwLCBkZXZpY2VOb2RlTWFzaz0lcCwgZGV2PSVkKVxuIiwKICAgICAgICAgICAgbHVpZCwgZGV2aWNlTm9kZU1hc2ssIGRldik7CiAgICBDVXJlc3VsdCByYyA9IGVuc3VyZV9pbml0KCk7CiAgICBpZiAocmMgIT0gQ1VEQV9TVUNDRVNTKSB7CiAgICAgICAgZnByaW50ZihzdGRlcnIsICJbbGlidmdwdS1jdWRhXSBjdURldmljZUdldEx1aWQgZW5zdXJlX2luaXQoKSBmYWlsZWQ6ICVkXG4iLCByYyk7CiAgICAgICAgcmV0dXJuIHJjOwogICAgfQogICAgaWYgKGRldiAhPSAwKSB7CiAgICAgICAgZnByaW50ZihzdGRlcnIsICJbbGlidmdwdS1jdWRhXSBjdURldmljZUdldEx1aWQ6IGludmFsaWQgZGV2aWNlICVkXG4iLCBkZXYpOwogICAgICAgIHJldHVybiBDVURBX0VSUk9SX0lOVkFMSURfREVWSUNFOwogICAgfQogICAgaWYgKGx1aWQpIHsKICAgICAgICAvKiBSZXR1cm4gYSBkdW1teSBMVUlEICgxMjggYml0cywgdHlwaWNhbGx5IDE2IGJ5dGVzKSAqLwogICAgICAgIG1lbXNldChsdWlkLCAwLCAxNik7CiAgICAgICAgLyogU2V0IHNvbWUgbm9uLXplcm8gYnl0ZXMgdG8gaW5kaWNhdGUgYSB2YWxpZCBMVUlEICovCiAgICAgICAgbHVpZFswXSA9IDB4MDE7CiAgICAgICAgbHVpZFsxNV0gPSAweDAxOwogICAgfQogICAgaWYgKGRldmljZU5vZGVNYXNrKSB7CiAgICAgICAgKmRldmljZU5vZGVNYXNrID0gMTsgIC8qIFNpbmdsZSBkZXZpY2UsIG1hc2sgPSAxICovCiAgICB9CiAgICBmcHJpbnRmKHN0ZGVyciwgIltsaWJ2Z3B1LWN1ZGFdIGN1RGV2aWNlR2V0THVpZCBTVUNDRVNTXG4iKTsKICAgIGZmbHVzaChzdGRlcnIpOwogICAgcmV0dXJuIENVREFfU1VDQ0VTUzsKfQoKLyoKICogY3VEZXZpY2VHZXRQQ0lCdXNJZCDigJQgcmV0dXJuIFBDSSBidXM6ZGV2aWNlLmZ1bmN0aW9uIHN0cmluZyBmb3IgZGV2aWNlLgogKgogKiBPbGxhbWEncyBHUFUtZGlzY292ZXJ5IGNvZGUgY2FsbHMgdGhpcyAodmlhIGRsc3ltKSB0byBwYWlyIHRoZSBDVURBIGRldmljZQogKiB3aXRoIHRoZSBOVk1MIGRldmljZSBieSBQQ0kgYnVzIElELiAgV2l0aG91dCB0aGlzIGZ1bmN0aW9uIHRoZSBkbHN5bSBsb29rdXAKICogcmV0dXJucyBOVUxMLCB3aGljaCBPbGxhbWEgdHJlYXRzIGFzIGFuIGluY29tcGxldGUgQ1VEQSBsaWJyYXJ5IGFuZCBmYWxscwogKiBiYWNrIHRvIGxpYnJhcnk9Y3B1LgogKi8KQ1VyZXN1bHQgY3VEZXZpY2VHZXRQQ0lCdXNJZChjaGFyICpwY2lCdXNJZCwgaW50IGxlbiwgQ1VkZXZpY2UgZGV2KQp7CiAgICBmcHJpbnRmKHN0ZGVyciwgIltsaWJ2Z3B1LWN1ZGFdIENBTExFRDogY3VEZXZpY2VHZXRQQ0lCdXNJZChwY2lCdXNJZD0lcCwgbGVuPSVkLCBkZXY9JWQpXG4iLAogICAgICAgICAgICBwY2lCdXNJZCwgbGVuLCBkZXYpOwogICAgQ1VyZXN1bHQgcmMgPSBlbnN1cmVfaW5pdCgpOwogICAgaWYgKHJjICE9IENVREFfU1VDQ0VTUykgewogICAgICAgIGZwcmludGYoc3RkZXJyLCAiW2xpYnZncHUtY3VkYV0gY3VEZXZpY2VHZXRQQ0lCdXNJZCBlbnN1cmVfaW5pdCgpIGZhaWxlZDogJWRcbiIsIHJjKTsKICAgICAgICByZXR1cm4gcmM7CiAgICB9CiAgICBpZiAoIXBjaUJ1c0lkIHx8IGxlbiA8PSAwKSB7CiAgICAgICAgZnByaW50ZihzdGRlcnIsICJbbGlidmdwdS1jdWRhXSBjdURldmljZUdldFBDSUJ1c0lkOiBpbnZhbGlkIGFyZ3VtZW50c1xuIik7CiAgICAgICAgcmV0dXJuIENVREFfRVJST1JfSU5WQUxJRF9WQUxVRTsKICAgIH0KICAgIGlmIChkZXYgIT0gMCkgewogICAgICAgIGZwcmludGYoc3RkZXJyLCAiW2xpYnZncHUtY3VkYV0gY3VEZXZpY2VHZXRQQ0lCdXNJZDogaW52YWxpZCBkZXZpY2UgJWRcbiIsIGRldik7CiAgICAgICAgcmV0dXJuIENVREFfRVJST1JfSU5WQUxJRF9ERVZJQ0U7CiAgICB9CiAgICAvKiBVc2UgZGlzY292ZXJlZCBCREYgZXZlbiBpZiB0cmFuc3BvcnQgaXNuJ3QgY29ubmVjdGVkIHlldCAqLwogICAgY29uc3QgY2hhciAqYmRmID0gY3VkYV90cmFuc3BvcnRfcGNpX2JkZihnX3RyYW5zcG9ydCk7CiAgICBpZiAoIWJkZiB8fCAhYmRmWzBdKSB7CiAgICAgICAgLyogRmFsbGJhY2sgdG8gZGlzY292ZXJlZCBCREYgZnJvbSBjdWRhX3RyYW5zcG9ydF9kaXNjb3ZlcigpICovCiAgICAgICAgYmRmID0gY3VkYV90cmFuc3BvcnRfcGNpX2JkZihOVUxMKTsKICAgICAgICBpZiAoIWJkZiB8fCAhYmRmWzBdKSB7CiAgICAgICAgICAgIGJkZiA9ICIwMDAwOjAwOjA1LjAiOyAgLyogRmluYWwgZmFsbGJhY2sgKi8KICAgICAgICB9CiAgICB9CiAgICAKICAgIC8qIENSSVRJQ0FMIEZJWDogRm9ybWF0IEJERiB0byBtYXRjaCBmaWxlc3lzdGVtIGZvcm1hdCAoNC1kaWdpdCBkb21haW4pIGZvciBPbGxhbWEncyBtYXRjaGluZyBsb2dpYy4KICAgICAqIFRoZSBmaWxlc3lzdGVtIHByb3ZpZGVzICIwMDAwOjAwOjA1LjAiICg0LWRpZ2l0IGRvbWFpbiksIGFuZCBPbGxhbWEgbWF0Y2hlcyBQQ0kgZGV2aWNlcwogICAgICogd2l0aCBOVk1MIGRldmljZXMgYnkgY29tcGFyaW5nIHRoZSBidXMgSUQgZnJvbSBmaWxlc3lzdGVtIHdpdGggdGhlIGJ1cyBJRCBmcm9tIE5WTUwuCiAgICAgKiBUaGV5IG11c3QgbWF0Y2ggZXhhY3RseSwgc28gd2UgdXNlIDQtZGlnaXQgZm9ybWF0IHRvIG1hdGNoIHRoZSBmaWxlc3lzdGVtLiAqLwogICAgY2hhciBmb3JtYXR0ZWRfYmRmWzY0XTsKICAgIHVuc2lnbmVkIGludCBkb20gPSAwLCBidXMgPSAwLCBkZXZfbnVtID0gMCwgZm4gPSAwOwogICAgaWYgKHNzY2FuZihiZGYsICIleDoleDoleC4leCIsICZkb20sICZidXMsICZkZXZfbnVtLCAmZm4pID09IDQpIHsKICAgICAgICAvKiBGb3JtYXQgYXMgNC1kaWdpdCBkb21haW4gdG8gbWF0Y2ggZmlsZXN5c3RlbTogIjAwMDA6MDA6MDUuMCIgKi8KICAgICAgICBzbnByaW50Zihmb3JtYXR0ZWRfYmRmLCBzaXplb2YoZm9ybWF0dGVkX2JkZiksICIlMDR4OiUwMng6JTAyeC4leCIsIGRvbSwgYnVzLCBkZXZfbnVtLCBmbik7CiAgICAgICAgYmRmID0gZm9ybWF0dGVkX2JkZjsKICAgIH0KICAgIAogICAgLyogRW5zdXJlIHdlIGhhdmUgZW5vdWdoIHNwYWNlICovCiAgICBpZiAobGVuIDwgKGludClzdHJsZW4oYmRmKSArIDEpIHsKICAgICAgICBmcHJpbnRmKHN0ZGVyciwgIltsaWJ2Z3B1LWN1ZGFdIGN1RGV2aWNlR2V0UENJQnVzSWQ6IGJ1ZmZlciB0b28gc21hbGwgKG5lZWQgJXp1LCBnb3QgJWQpXG4iLAogICAgICAgICAgICAgICAgc3RybGVuKGJkZikgKyAxLCBsZW4pOwogICAgICAgIGZmbHVzaChzdGRlcnIpOwogICAgICAgIHJldHVybiBDVURBX0VSUk9SX0lOVkFMSURfVkFMVUU7CiAgICB9CiAgICBzdHJuY3B5KHBjaUJ1c0lkLCBiZGYsIChzaXplX3QpbGVuIC0gMSk7CiAgICBwY2lCdXNJZFtsZW4gLSAxXSA9ICdcMCc7CiAgICBmcHJpbnRmKHN0ZGVyciwgIltsaWJ2Z3B1LWN1ZGFdIGN1RGV2aWNlR2V0UENJQnVzSWQgU1VDQ0VTUzogcmV0dXJuaW5nIGJ1c0lkPVwiJXNcIiAocGlkPSVkKVxuIiwgCiAgICAgICAgICAgIHBjaUJ1c0lkLCAoaW50KWdldHBpZCgpKTsKICAgIGZmbHVzaChzdGRlcnIpOwogICAgcmV0dXJuIENVREFfU1VDQ0VTUzsKfQoKQ1VyZXN1bHQgY3VEZXZpY2VHZXRQQ0lCdXNJZF92MihjaGFyICpwY2lCdXNJZCwgaW50IGxlbiwgQ1VkZXZpY2UgZGV2KQp7CiAgICByZXR1cm4gY3VEZXZpY2VHZXRQQ0lCdXNJZChwY2lCdXNJZCwgbGVuLCBkZXYpOwp9CgpDVXJlc3VsdCBjdURldmljZUNvbXB1dGVDYXBhYmlsaXR5KGludCAqbWFqb3IsIGludCAqbWlub3IsIENVZGV2aWNlIGRldikKewogICAgZnByaW50ZihzdGRlcnIsICJbbGlidmdwdS1jdWRhXSBDQUxMRUQ6IGN1RGV2aWNlQ29tcHV0ZUNhcGFiaWxpdHkobWFqb3I9JXAsIG1pbm9yPSVwLCBkZXY9JWQpXG4iLAogICAgICAgICAgICBtYWpvciwgbWlub3IsIGRldik7CiAgICBmZmx1c2goc3RkZXJyKTsKICAgIENVcmVzdWx0IHJjID0gZW5zdXJlX2luaXQoKTsKICAgIGlmIChyYyAhPSBDVURBX1NVQ0NFU1MpIHJldHVybiByYzsKICAgIGlmICghbWFqb3IgfHwgIW1pbm9yKSByZXR1cm4gQ1VEQV9FUlJPUl9JTlZBTElEX1ZBTFVFOwogICAgaWYgKGRldiAhPSAwKSByZXR1cm4gQ1VEQV9FUlJPUl9JTlZBTElEX0RFVklDRTsKICAgICptYWpvciA9IGdfZ3B1X2luZm8uY29tcHV0ZV9jYXBfbWFqb3I7CiAgICAqbWlub3IgPSBnX2dwdV9pbmZvLmNvbXB1dGVfY2FwX21pbm9yOwogICAgZnByaW50ZihzdGRlcnIsICJbbGlidmdwdS1jdWRhXSBjdURldmljZUNvbXB1dGVDYXBhYmlsaXR5IFNVQ0NFU1M6ICVkLiVkXG4iLCAqbWFqb3IsICptaW5vcik7CiAgICBmZmx1c2goc3RkZXJyKTsKICAgIHJldHVybiBDVURBX1NVQ0NFU1M7Cn0KCi8qIEFkZGl0aW9uYWwgZGV2aWNlIHF1ZXJ5IGZ1bmN0aW9ucyB0aGF0IG1pZ2h0IGJlIGNhbGxlZCBkdXJpbmcgaW5pdGlhbGl6YXRpb24gKi8KCkNVcmVzdWx0IGN1RGV2aWNlR2V0VGV4dHVyZTFETGluZWFyTWF4V2lkdGgoc2l6ZV90ICptYXhXaWR0aEluRWxlbWVudHMsIENVZGV2aWNlIGRldiwgaW50IHRleERlc2MpCnsKICAgIGZwcmludGYoc3RkZXJyLCAiW2xpYnZncHUtY3VkYV0gQ0FMTEVEOiBjdURldmljZUdldFRleHR1cmUxRExpbmVhck1heFdpZHRoKG1heFdpZHRoSW5FbGVtZW50cz0lcCwgZGV2PSVkLCB0ZXhEZXNjPSVkKVxuIiwKICAgICAgICAgICAgbWF4V2lkdGhJbkVsZW1lbnRzLCBkZXYsIHRleERlc2MpOwogICAgZmZsdXNoKHN0ZGVycik7CiAgICBDVXJlc3VsdCByYyA9IGVuc3VyZV9pbml0KCk7CiAgICBpZiAocmMgIT0gQ1VEQV9TVUNDRVNTKSByZXR1cm4gcmM7CiAgICBpZiAoIW1heFdpZHRoSW5FbGVtZW50cykgcmV0dXJuIENVREFfRVJST1JfSU5WQUxJRF9WQUxVRTsKICAgIGlmIChkZXYgIT0gMCkgcmV0dXJuIENVREFfRVJST1JfSU5WQUxJRF9ERVZJQ0U7CiAgICAvKiBSZXR1cm4gYSByZWFzb25hYmxlIGRlZmF1bHQgZm9yIEgxMDAgKi8KICAgICptYXhXaWR0aEluRWxlbWVudHMgPSAxMzQyMTc3Mjg7IC8qIDEyOE0gZWxlbWVudHMgKi8KICAgIGZwcmludGYoc3RkZXJyLCAiW2xpYnZncHUtY3VkYV0gY3VEZXZpY2VHZXRUZXh0dXJlMURMaW5lYXJNYXhXaWR0aCBTVUNDRVNTOiAlenVcbiIsICptYXhXaWR0aEluRWxlbWVudHMpOwogICAgZmZsdXNoKHN0ZGVycik7CiAgICByZXR1cm4gQ1VEQV9TVUNDRVNTOwp9CgpDVXJlc3VsdCBjdURldmljZUdldE52U2NpU3luY0F0dHJpYnV0ZXModm9pZCAqbnZTY2lTeW5jQXR0ckxpc3QsIENVZGV2aWNlIGRldiwgaW50IGZsYWdzKQp7CiAgICBmcHJpbnRmKHN0ZGVyciwgIltsaWJ2Z3B1LWN1ZGFdIENBTExFRDogY3VEZXZpY2VHZXROdlNjaVN5bmNBdHRyaWJ1dGVzKG52U2NpU3luY0F0dHJMaXN0PSVwLCBkZXY9JWQsIGZsYWdzPSVkKVxuIiwKICAgICAgICAgICAgbnZTY2lTeW5jQXR0ckxpc3QsIGRldiwgZmxhZ3MpOwogICAgZmZsdXNoKHN0ZGVycik7CiAgICBDVXJlc3VsdCByYyA9IGVuc3VyZV9pbml0KCk7CiAgICBpZiAocmMgIT0gQ1VEQV9TVUNDRVNTKSByZXR1cm4gcmM7CiAgICBpZiAoIW52U2NpU3luY0F0dHJMaXN0KSByZXR1cm4gQ1VEQV9FUlJPUl9JTlZBTElEX1ZBTFVFOwogICAgaWYgKGRldiAhPSAwKSByZXR1cm4gQ1VEQV9FUlJPUl9JTlZBTElEX0RFVklDRTsKICAgIC8qIE52U2NpU3luYyBpcyBmb3IgbXVsdGktR1BVIHN5bmNocm9uaXphdGlvbiAtIG5vdCBjcml0aWNhbCBmb3Igc2luZ2xlIEdQVSAqLwogICAgLyogUmV0dXJuIHN1Y2Nlc3Mgd2l0aCB6ZXJvLWluaXRpYWxpemVkIGF0dHJpYnV0ZXMgKi8KICAgIG1lbXNldChudlNjaVN5bmNBdHRyTGlzdCwgMCwgMjU2KTsgLyogUmVhc29uYWJsZSBkZWZhdWx0IHNpemUgKi8KICAgIGZwcmludGYoc3RkZXJyLCAiW2xpYnZncHUtY3VkYV0gY3VEZXZpY2VHZXROdlNjaVN5bmNBdHRyaWJ1dGVzIFNVQ0NFU1MgKHN0dWIpXG4iKTsKICAgIGZmbHVzaChzdGRlcnIpOwogICAgcmV0dXJuIENVREFfU1VDQ0VTUzsKfQoKQ1VyZXN1bHQgY3VEZXZpY2VHZXREZWZhdWx0TWVtUG9vbChDVW1lbW9yeVBvb2wgKm1lbVBvb2wsIENVZGV2aWNlIGRldikKewogICAgZnByaW50ZihzdGRlcnIsICJbbGlidmdwdS1jdWRhXSBDQUxMRUQ6IGN1RGV2aWNlR2V0RGVmYXVsdE1lbVBvb2wobWVtUG9vbD0lcCwgZGV2PSVkKVxuIiwKICAgICAgICAgICAgbWVtUG9vbCwgZGV2KTsKICAgIGZmbHVzaChzdGRlcnIpOwogICAgQ1VyZXN1bHQgcmMgPSBlbnN1cmVfaW5pdCgpOwogICAgaWYgKHJjICE9IENVREFfU1VDQ0VTUykgcmV0dXJuIHJjOwogICAgaWYgKCFtZW1Qb29sKSByZXR1cm4gQ1VEQV9FUlJPUl9JTlZBTElEX1ZBTFVFOwogICAgaWYgKGRldiAhPSAwKSByZXR1cm4gQ1VEQV9FUlJPUl9JTlZBTElEX0RFVklDRTsKICAgIC8qIFJldHVybiBhIGR1bW15IG1lbW9yeSBwb29sIGhhbmRsZSAqLwogICAgKm1lbVBvb2wgPSAoQ1VtZW1vcnlQb29sKSh1aW50cHRyX3QpMHhERUFEQkVFRjsKICAgIGZwcmludGYoc3RkZXJyLCAiW2xpYnZncHUtY3VkYV0gY3VEZXZpY2VHZXREZWZhdWx0TWVtUG9vbCBTVUNDRVNTIChzdHViKVxuIik7CiAgICBmZmx1c2goc3RkZXJyKTsKICAgIHJldHVybiBDVURBX1NVQ0NFU1M7Cn0KCkNVcmVzdWx0IGN1RGV2aWNlR2V0TWVtUG9vbChDVW1lbW9yeVBvb2wgKm1lbVBvb2wsIENVZGV2aWNlIGRldikKewogICAgcmV0dXJuIGN1RGV2aWNlR2V0RGVmYXVsdE1lbVBvb2wobWVtUG9vbCwgZGV2KTsKfQoKLyogY3VEZXZpY2VHZXRQcm9wZXJ0aWVzIC0gTGVnYWN5IGZ1bmN0aW9uLCBkZXByZWNhdGVkIGJ1dCBzb21lIGNvZGUgc3RpbGwgdXNlcyBpdC4KICogUmV0dXJucyBkZXZpY2UgcHJvcGVydGllcyBpbiBhIHN0cnVjdHVyZS4gV2UgaW1wbGVtZW50IGl0IGZvciBjb21wYXRpYmlsaXR5LgogKiBDVWRldnByb3AgdHlwZWRlZiBpcyBkZWZpbmVkIGVhcmxpZXIgaW4gdGhlIGZpbGUuICovCgpDVXJlc3VsdCBjdURldmljZUdldFByb3BlcnRpZXMoQ1VkZXZwcm9wICpwcm9wLCBDVWRldmljZSBkZXYpCnsKICAgIGZwcmludGYoc3RkZXJyLCAiW2xpYnZncHUtY3VkYV0gQ0FMTEVEOiBjdURldmljZUdldFByb3BlcnRpZXMocHJvcD0lcCwgZGV2PSVkKVxuIiwgcHJvcCwgZGV2KTsKICAgIGZmbHVzaChzdGRlcnIpOwogICAgQ1VyZXN1bHQgcmMgPSBlbnN1cmVfaW5pdCgpOwogICAgaWYgKHJjICE9IENVREFfU1VDQ0VTUykgewogICAgICAgIGZwcmludGYoc3RkZXJyLCAiW2xpYnZncHUtY3VkYV0gY3VEZXZpY2VHZXRQcm9wZXJ0aWVzIGVuc3VyZV9pbml0KCkgZmFpbGVkOiAlZFxuIiwgcmMpOwogICAgICAgIGZmbHVzaChzdGRlcnIpOwogICAgICAgIHJldHVybiByYzsKICAgIH0KICAgIGlmICghcHJvcCkgewogICAgICAgIGZwcmludGYoc3RkZXJyLCAiW2xpYnZncHUtY3VkYV0gY3VEZXZpY2VHZXRQcm9wZXJ0aWVzOiBpbnZhbGlkIHBvaW50ZXJcbiIpOwogICAgICAgIGZmbHVzaChzdGRlcnIpOwogICAgICAgIHJldHVybiBDVURBX0VSUk9SX0lOVkFMSURfVkFMVUU7CiAgICB9CiAgICBpZiAoZGV2ICE9IDApIHsKICAgICAgICBmcHJpbnRmKHN0ZGVyciwgIltsaWJ2Z3B1LWN1ZGFdIGN1RGV2aWNlR2V0UHJvcGVydGllczogaW52YWxpZCBkZXZpY2UgJWRcbiIsIGRldik7CiAgICAgICAgZmZsdXNoKHN0ZGVycik7CiAgICAgICAgcmV0dXJuIENVREFfRVJST1JfSU5WQUxJRF9ERVZJQ0U7CiAgICB9CiAgICAKICAgIC8qIEZpbGwgaW4gcHJvcGVydGllcyBmcm9tIGdfZ3B1X2luZm8gKi8KICAgIG1lbXNldChwcm9wLCAwLCBzaXplb2YoQ1VkZXZwcm9wKSk7CiAgICBwcm9wLT5tYWpvciA9IGdfZ3B1X2luZm8uY29tcHV0ZV9jYXBfbWFqb3I7CiAgICBwcm9wLT5taW5vciA9IGdfZ3B1X2luZm8uY29tcHV0ZV9jYXBfbWlub3I7CiAgICBzdHJuY3B5KHByb3AtPm5hbWUsIGdfZ3B1X2luZm8ubmFtZSwgc2l6ZW9mKHByb3AtPm5hbWUpIC0gMSk7CiAgICBwcm9wLT5uYW1lW3NpemVvZihwcm9wLT5uYW1lKSAtIDFdID0gJ1wwJzsKICAgIHByb3AtPnRvdGFsR2xvYmFsTWVtID0gKHNpemVfdClnX2dwdV9pbmZvLnRvdGFsX21lbTsKICAgIHByb3AtPm11bHRpcHJvY2Vzc29yQ291bnQgPSBnX2dwdV9pbmZvLm11bHRpX3Byb2Nlc3Nvcl9jb3VudDsKICAgIHByb3AtPm1heFRocmVhZHNQZXJCbG9jayA9IGdfZ3B1X2luZm8ubWF4X3RocmVhZHNfcGVyX2Jsb2NrOwogICAgcHJvcC0+bWF4VGhyZWFkc1Blck11bHRpcHJvY2Vzc29yID0gZ19ncHVfaW5mby5tYXhfdGhyZWFkc19wZXJfbXA7CiAgICBwcm9wLT5zaGFyZWRNZW1QZXJCbG9jayA9IGdfZ3B1X2luZm8ubWF4X3NoYXJlZF9tZW1fcGVyX2Jsb2NrOwogICAgcHJvcC0+cmVnc1BlckJsb2NrID0gZ19ncHVfaW5mby5yZWdzX3Blcl9ibG9jazsKICAgIHByb3AtPndhcnBTaXplID0gZ19ncHVfaW5mby53YXJwX3NpemU7CiAgICBwcm9wLT5jbG9ja1JhdGUgPSBnX2dwdV9pbmZvLmNsb2NrX3JhdGVfa2h6OwogICAgcHJvcC0+bWVtb3J5Q2xvY2tSYXRlID0gZ19ncHVfaW5mby5tZW1vcnlfY2xvY2tfcmF0ZV9raHo7CiAgICBwcm9wLT5tZW1vcnlCdXNXaWR0aCA9IGdfZ3B1X2luZm8ubWVtb3J5X2J1c193aWR0aDsKICAgIHByb3AtPnRvdGFsQ29uc3RNZW0gPSBHUFVfREVGQVVMVF9UT1RBTF9DT05TVEFOVF9NRU07CiAgICBwcm9wLT50ZXh0dXJlQWxpZ25tZW50ID0gR1BVX0RFRkFVTFRfVEVYVFVSRV9BTElHTk1FTlQ7CiAgICBwcm9wLT5kZXZpY2VPdmVybGFwID0gMTsgIC8qIERldmljZSBjYW4gb3ZlcmxhcCBjb3BpZXMgYW5kIGtlcm5lbHMgKi8KICAgIHByb3AtPm11bHRpUHJvY2Vzc29yQ291bnQgPSBnX2dwdV9pbmZvLm11bHRpX3Byb2Nlc3Nvcl9jb3VudDsKICAgIAogICAgZnByaW50ZihzdGRlcnIsICJbbGlidmdwdS1jdWRhXSBjdURldmljZUdldFByb3BlcnRpZXMgU1VDQ0VTUzogJXMsIENDICVkLiVkLCAlenUgTUJcbiIsCiAgICAgICAgICAgIHByb3AtPm5hbWUsIHByb3AtPm1ham9yLCBwcm9wLT5taW5vciwgcHJvcC0+dG90YWxHbG9iYWxNZW0gLyAoMTAyNCAqIDEwMjQpKTsKICAgIGZmbHVzaChzdGRlcnIpOwogICAgcmV0dXJuIENVREFfU1VDQ0VTUzsKfQoKLyogPT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PQogKiBDVURBIERyaXZlciBBUEkg4oCUIFByaW1hcnkgQ29udGV4dAogKgogKiBDVURBIGFwcGxpY2F0aW9ucyAoZXNwLiB2aWEgY3VkYXJ0KSB1c2UgdGhlIHByaW1hcnkgY29udGV4dCBBUEkuCiAqIFdlIG1hcCB0aGVzZSB0byByZW1vdGUgY29udGV4dCBvcGVyYXRpb25zLgogKiA9PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09ICovCgpDVXJlc3VsdCBjdURldmljZVByaW1hcnlDdHhSZXRhaW4oQ1Vjb250ZXh0ICpwY3R4LCBDVWRldmljZSBkZXYpCnsKICAgIGZwcmludGYoc3RkZXJyLCAiW2xpYnZncHUtY3VkYV0gQ0FMTEVEOiBjdURldmljZVByaW1hcnlDdHhSZXRhaW4ocGN0eD0lcCwgZGV2PSVkKVxuIiwKICAgICAgICAgICAgcGN0eCwgKGludClkZXYpOwogICAgZmZsdXNoKHN0ZGVycik7CiAgICBDVXJlc3VsdCByYyA9IGVuc3VyZV9pbml0KCk7CiAgICBpZiAocmMgIT0gQ1VEQV9TVUNDRVNTKSB7CiAgICAgICAgZnByaW50ZihzdGRlcnIsICJbbGlidmdwdS1jdWRhXSBjdURldmljZVByaW1hcnlDdHhSZXRhaW4gZW5zdXJlX2luaXQoKSBmYWlsZWQ6ICVkXG4iLCByYyk7CiAgICAgICAgZmZsdXNoKHN0ZGVycik7CiAgICAgICAgcmV0dXJuIHJjOwogICAgfQogICAgaWYgKCFwY3R4KSByZXR1cm4gQ1VEQV9FUlJPUl9JTlZBTElEX1ZBTFVFOwogICAgaWYgKGRldiAhPSAwKSByZXR1cm4gQ1VEQV9FUlJPUl9JTlZBTElEX0RFVklDRTsKCiAgICAvKiBUcnkgdG8gY29ubmVjdCBhbmQgZ2V0IHJlYWwgY29udGV4dCwgYnV0IGlmIHRyYW5zcG9ydCBpc24ndCByZWFkeSB5ZXQsCiAgICAgKiByZXR1cm4gYSBkdW1teSBjb250ZXh0IHRvIGFsbG93IGluaXRpYWxpemF0aW9uIHRvIHByb2NlZWQuICovCiAgICBDVURBQ2FsbFJlc3VsdCByZXN1bHQ7CiAgICB1aW50MzJfdCBhcmdzWzJdOwogICAgQ1VEQV9QQUNLX1U2NChhcmdzLCAwLCAodWludDY0X3QpZGV2KTsKICAgIAogICAgLyogVHJ5IFJQQyBjYWxsLCBidXQgZG9uJ3QgZmFpbCBpZiB0cmFuc3BvcnQgaXNuJ3QgY29ubmVjdGVkIHlldCAqLwogICAgQ1VyZXN1bHQgcnBjX3JjID0gZW5zdXJlX2Nvbm5lY3RlZCgpOwogICAgaWYgKHJwY19yYyA9PSBDVURBX1NVQ0NFU1MgJiYgZ190cmFuc3BvcnQpIHsKICAgICAgICByYyA9IHJwY19zaW1wbGUoQ1VEQV9DQUxMX0RFVklDRV9QUklNQVJZX0NUWF9SRVRBSU4sIGFyZ3MsIDIsICZyZXN1bHQpOwogICAgICAgIGlmIChyYyA9PSBDVURBX1NVQ0NFU1MpIHsKICAgICAgICAgICAgKnBjdHggPSAoQ1Vjb250ZXh0KSh1aW50cHRyX3QpcmVzdWx0LnJlc3VsdHNbMF07CiAgICAgICAgICAgIGdfY3VycmVudF9jdHggPSAqcGN0eDsKICAgICAgICAgICAgCiAgICAgICAgICAgIC8qIENsZWFyIGluaXQgcGhhc2UgZmxhZyBhZnRlciBzdWNjZXNzZnVsIGNvbnRleHQgY3JlYXRpb24gKi8KICAgICAgICAgICAgcHRocmVhZF9tdXRleF9sb2NrKCZnX211dGV4KTsKICAgICAgICAgICAgaWYgKGdfaW5faW5pdF9waGFzZSkgewogICAgICAgICAgICAgICAgZ19pbl9pbml0X3BoYXNlID0gMDsKICAgICAgICAgICAgICAgIGZwcmludGYoc3RkZXJyLCAiW2xpYnZncHUtY3VkYV0gSU5JVCBQSEFTRSBDT01QTEVURTogY2xlYXJlZCBnX2luX2luaXRfcGhhc2UgYWZ0ZXIgc3VjY2Vzc2Z1bCBjb250ZXh0IGNyZWF0aW9uXG4iKTsKICAgICAgICAgICAgICAgIGZmbHVzaChzdGRlcnIpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHB0aHJlYWRfbXV0ZXhfdW5sb2NrKCZnX211dGV4KTsKICAgICAgICAgICAgCiAgICAgICAgICAgIGZwcmludGYoc3RkZXJyLCAiW2xpYnZncHUtY3VkYV0gY3VEZXZpY2VQcmltYXJ5Q3R4UmV0YWluIFNVQ0NFU1MgKHZpYSBSUEMpOiBwY3R4PSVwXG4iLCAqcGN0eCk7CiAgICAgICAgICAgIGZmbHVzaChzdGRlcnIpOwogICAgICAgICAgICByZXR1cm4gQ1VEQV9TVUNDRVNTOwogICAgICAgIH0KICAgIH0KICAgIAogICAgLyogRmFsbGJhY2s6IHJldHVybiBhIGR1bW15IGNvbnRleHQgdG8gYWxsb3cgaW5pdGlhbGl6YXRpb24gdG8gcHJvY2VlZC4KICAgICAqIFRoZSByZWFsIGNvbnRleHQgd2lsbCBiZSBjcmVhdGVkIHdoZW4gdGhlIHRyYW5zcG9ydCBpcyByZWFkeS4gKi8KICAgIHN0YXRpYyBDVWNvbnRleHQgZHVtbXlfY3R4ID0gKENVY29udGV4dCkodWludHB0cl90KTB4REVBREJFRUY7CiAgICAqcGN0eCA9IGR1bW15X2N0eDsKICAgIGdfY3VycmVudF9jdHggPSBkdW1teV9jdHg7CiAgICBmcHJpbnRmKHN0ZGVyciwgIltsaWJ2Z3B1LWN1ZGFdIGN1RGV2aWNlUHJpbWFyeUN0eFJldGFpbiBTVUNDRVNTIChkdW1teSBjb250ZXh0LCB0cmFuc3BvcnQgZGVmZXJyZWQpOiBwY3R4PSVwXG4iLCAqcGN0eCk7CiAgICBmZmx1c2goc3RkZXJyKTsKICAgIHJldHVybiBDVURBX1NVQ0NFU1M7Cn0KCi8qIF92MiB2ZXJzaW9uIGlzIGlkZW50aWNhbCB0byBiYXNlIHZlcnNpb24gKi8KQ1VyZXN1bHQgY3VEZXZpY2VQcmltYXJ5Q3R4UmV0YWluX3YyKENVY29udGV4dCAqcGN0eCwgQ1VkZXZpY2UgZGV2KQp7CiAgICByZXR1cm4gY3VEZXZpY2VQcmltYXJ5Q3R4UmV0YWluKHBjdHgsIGRldik7Cn0KCkNVcmVzdWx0IGN1RGV2aWNlUHJpbWFyeUN0eFJlbGVhc2UoQ1VkZXZpY2UgZGV2KQp7CiAgICByZXR1cm4gY3VEZXZpY2VQcmltYXJ5Q3R4UmVsZWFzZV92MihkZXYpOwp9CgpDVXJlc3VsdCBjdURldmljZVByaW1hcnlDdHhSZWxlYXNlX3YyKENVZGV2aWNlIGRldikKewogICAgQ1VyZXN1bHQgcmMgPSBlbnN1cmVfaW5pdCgpOwogICAgaWYgKHJjICE9IENVREFfU1VDQ0VTUykgcmV0dXJuIHJjOwoKICAgIENVREFDYWxsUmVzdWx0IHJlc3VsdDsKICAgIHVpbnQzMl90IGFyZ3NbMl07CiAgICBDVURBX1BBQ0tfVTY0KGFyZ3MsIDAsICh1aW50NjRfdClkZXYpOwogICAgcmV0dXJuIHJwY19zaW1wbGUoQ1VEQV9DQUxMX0RFVklDRV9QUklNQVJZX0NUWF9SRUxFQVNFLCBhcmdzLCAyLCAmcmVzdWx0KTsKfQoKQ1VyZXN1bHQgY3VEZXZpY2VQcmltYXJ5Q3R4UmVzZXQoQ1VkZXZpY2UgZGV2KQp7CiAgICByZXR1cm4gY3VEZXZpY2VQcmltYXJ5Q3R4UmVzZXRfdjIoZGV2KTsKfQoKQ1VyZXN1bHQgY3VEZXZpY2VQcmltYXJ5Q3R4UmVzZXRfdjIoQ1VkZXZpY2UgZGV2KQp7CiAgICBDVXJlc3VsdCByYyA9IGVuc3VyZV9pbml0KCk7CiAgICBpZiAocmMgIT0gQ1VEQV9TVUNDRVNTKSByZXR1cm4gcmM7CgogICAgQ1VEQUNhbGxSZXN1bHQgcmVzdWx0OwogICAgdWludDMyX3QgYXJnc1syXTsKICAgIENVREFfUEFDS19VNjQoYXJncywgMCwgKHVpbnQ2NF90KWRldik7CiAgICByZXR1cm4gcnBjX3NpbXBsZShDVURBX0NBTExfREVWSUNFX1BSSU1BUllfQ1RYX1JFU0VULCBhcmdzLCAyLCAmcmVzdWx0KTsKfQoKQ1VyZXN1bHQgY3VEZXZpY2VQcmltYXJ5Q3R4U2V0RmxhZ3MoQ1VkZXZpY2UgZGV2LCB1bnNpZ25lZCBpbnQgZmxhZ3MpCnsKICAgIHJldHVybiBjdURldmljZVByaW1hcnlDdHhTZXRGbGFnc192MihkZXYsIGZsYWdzKTsKfQoKQ1VyZXN1bHQgY3VEZXZpY2VQcmltYXJ5Q3R4U2V0RmxhZ3NfdjIoQ1VkZXZpY2UgZGV2LCB1bnNpZ25lZCBpbnQgZmxhZ3MpCnsKICAgIENVcmVzdWx0IHJjID0gZW5zdXJlX2luaXQoKTsKICAgIGlmIChyYyAhPSBDVURBX1NVQ0NFU1MpIHJldHVybiByYzsKCiAgICBDVURBQ2FsbFJlc3VsdCByZXN1bHQ7CiAgICB1aW50MzJfdCBhcmdzWzRdOwogICAgQ1VEQV9QQUNLX1U2NChhcmdzLCAwLCAodWludDY0X3QpZGV2KTsKICAgIENVREFfUEFDS19VNjQoYXJncywgMiwgKHVpbnQ2NF90KWZsYWdzKTsKICAgIHJldHVybiBycGNfc2ltcGxlKENVREFfQ0FMTF9ERVZJQ0VfUFJJTUFSWV9DVFhfU0VUX0ZMQUdTLCBhcmdzLCA0LCAmcmVzdWx0KTsKfQoKQ1VyZXN1bHQgY3VEZXZpY2VQcmltYXJ5Q3R4R2V0U3RhdGUoQ1VkZXZpY2UgZGV2LCB1bnNpZ25lZCBpbnQgKmZsYWdzLCBpbnQgKmFjdGl2ZSkKewogICAgQ1VyZXN1bHQgcmMgPSBlbnN1cmVfaW5pdCgpOwogICAgaWYgKHJjICE9IENVREFfU1VDQ0VTUykgcmV0dXJuIHJjOwogICAgaWYgKCFmbGFncyB8fCAhYWN0aXZlKSByZXR1cm4gQ1VEQV9FUlJPUl9JTlZBTElEX1ZBTFVFOwoKICAgIENVREFDYWxsUmVzdWx0IHJlc3VsdDsKICAgIHVpbnQzMl90IGFyZ3NbMl07CiAgICBDVURBX1BBQ0tfVTY0KGFyZ3MsIDAsICh1aW50NjRfdClkZXYpOwogICAgcmMgPSBycGNfc2ltcGxlKENVREFfQ0FMTF9ERVZJQ0VfUFJJTUFSWV9DVFhfR0VUX1NUQVRFLCBhcmdzLCAyLCAmcmVzdWx0KTsKICAgIGlmIChyYyA9PSBDVURBX1NVQ0NFU1MpIHsKICAgICAgICAqZmxhZ3MgID0gKHVuc2lnbmVkIGludClyZXN1bHQucmVzdWx0c1swXTsKICAgICAgICAqYWN0aXZlID0gKGludClyZXN1bHQucmVzdWx0c1sxXTsKICAgIH0KICAgIHJldHVybiByYzsKfQoKLyogPT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PQogKiBDVURBIERyaXZlciBBUEkg4oCUIENvbnRleHQgbWFuYWdlbWVudAogKiA9PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09ICovCgpDVXJlc3VsdCBjdUN0eENyZWF0ZV92MihDVWNvbnRleHQgKnBjdHgsIHVuc2lnbmVkIGludCBmbGFncywgQ1VkZXZpY2UgZGV2KQp7CiAgICBmcHJpbnRmKHN0ZGVyciwgIltsaWJ2Z3B1LWN1ZGFdIENBTExFRDogY3VDdHhDcmVhdGVfdjIocGN0eD0lcCwgZmxhZ3M9MHgleCwgZGV2PSVkKVxuIiwKICAgICAgICAgICAgcGN0eCwgZmxhZ3MsIChpbnQpZGV2KTsKICAgIGZmbHVzaChzdGRlcnIpOwogICAgQ1VyZXN1bHQgcmMgPSBlbnN1cmVfaW5pdCgpOwogICAgaWYgKHJjICE9IENVREFfU1VDQ0VTUykgewogICAgICAgIGZwcmludGYoc3RkZXJyLCAiW2xpYnZncHUtY3VkYV0gY3VDdHhDcmVhdGVfdjIgZW5zdXJlX2luaXQoKSBmYWlsZWQ6ICVkXG4iLCByYyk7CiAgICAgICAgZmZsdXNoKHN0ZGVycik7CiAgICAgICAgcmV0dXJuIHJjOwogICAgfQogICAgaWYgKCFwY3R4KSB7CiAgICAgICAgZnByaW50ZihzdGRlcnIsICJbbGlidmdwdS1jdWRhXSBjdUN0eENyZWF0ZV92MjogaW52YWxpZCBwb2ludGVyXG4iKTsKICAgICAgICBmZmx1c2goc3RkZXJyKTsKICAgICAgICByZXR1cm4gQ1VEQV9FUlJPUl9JTlZBTElEX1ZBTFVFOwogICAgfQogICAgaWYgKGRldiAhPSAwKSB7CiAgICAgICAgZnByaW50ZihzdGRlcnIsICJbbGlidmdwdS1jdWRhXSBjdUN0eENyZWF0ZV92MjogaW52YWxpZCBkZXZpY2UgJWRcbiIsIGRldik7CiAgICAgICAgZmZsdXNoKHN0ZGVycik7CiAgICAgICAgcmV0dXJuIENVREFfRVJST1JfSU5WQUxJRF9ERVZJQ0U7CiAgICB9CgogICAgLyogVHJ5IHRvIGNvbm5lY3QgYW5kIGNyZWF0ZSBjb250ZXh0LCBidXQgaWYgdHJhbnNwb3J0IGlzbid0IHJlYWR5IHlldCwKICAgICAqIHJldHVybiBhIGR1bW15IGNvbnRleHQgdG8gYWxsb3cgaW5pdGlhbGl6YXRpb24gdG8gcHJvY2VlZC4gKi8KICAgIENVcmVzdWx0IHJwY19yYyA9IGVuc3VyZV9jb25uZWN0ZWQoKTsKICAgIGlmIChycGNfcmMgPT0gQ1VEQV9TVUNDRVNTICYmIGdfdHJhbnNwb3J0KSB7CiAgICAgICAgQ1VEQUNhbGxSZXN1bHQgcmVzdWx0OwogICAgICAgIHVpbnQzMl90IGFyZ3NbNF07CiAgICAgICAgYXJnc1swXSA9IGZsYWdzOwogICAgICAgIGFyZ3NbMV0gPSAwOwogICAgICAgIENVREFfUEFDS19VNjQoYXJncywgMiwgKHVpbnQ2NF90KWRldik7CgogICAgICAgIHJjID0gcnBjX3NpbXBsZShDVURBX0NBTExfQ1RYX0NSRUFURSwgYXJncywgNCwgJnJlc3VsdCk7CiAgICAgICAgaWYgKHJjID09IENVREFfU1VDQ0VTUykgewogICAgICAgICAgICAqcGN0eCA9IChDVWNvbnRleHQpKHVpbnRwdHJfdClyZXN1bHQucmVzdWx0c1swXTsKICAgICAgICAgICAgZ19jdXJyZW50X2N0eCA9ICpwY3R4OwogICAgICAgICAgICAKICAgICAgICAgICAgLyogQ2xlYXIgaW5pdCBwaGFzZSBmbGFnIGFmdGVyIHN1Y2Nlc3NmdWwgY29udGV4dCBjcmVhdGlvbiAqLwogICAgICAgICAgICBwdGhyZWFkX211dGV4X2xvY2soJmdfbXV0ZXgpOwogICAgICAgICAgICBpZiAoZ19pbl9pbml0X3BoYXNlKSB7CiAgICAgICAgICAgICAgICBnX2luX2luaXRfcGhhc2UgPSAwOwogICAgICAgICAgICAgICAgZnByaW50ZihzdGRlcnIsICJbbGlidmdwdS1jdWRhXSBJTklUIFBIQVNFIENPTVBMRVRFOiBjbGVhcmVkIGdfaW5faW5pdF9waGFzZSBhZnRlciBzdWNjZXNzZnVsIGNvbnRleHQgY3JlYXRpb25cbiIpOwogICAgICAgICAgICAgICAgZmZsdXNoKHN0ZGVycik7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgcHRocmVhZF9tdXRleF91bmxvY2soJmdfbXV0ZXgpOwogICAgICAgICAgICAKICAgICAgICAgICAgZnByaW50ZihzdGRlcnIsICJbbGlidmdwdS1jdWRhXSBjdUN0eENyZWF0ZV92MiBTVUNDRVNTICh2aWEgUlBDKTogcGN0eD0lcFxuIiwgKnBjdHgpOwogICAgICAgICAgICBmZmx1c2goc3RkZXJyKTsKICAgICAgICAgICAgcmV0dXJuIENVREFfU1VDQ0VTUzsKICAgICAgICB9CiAgICB9CiAgICAKICAgIC8qIEZhbGxiYWNrOiByZXR1cm4gYSBkdW1teSBjb250ZXh0IHRvIGFsbG93IGluaXRpYWxpemF0aW9uIHRvIHByb2NlZWQgKi8KICAgIHN0YXRpYyBDVWNvbnRleHQgZHVtbXlfY3R4ID0gKENVY29udGV4dCkodWludHB0cl90KTB4REVBREJFRUY7CiAgICAqcGN0eCA9IGR1bW15X2N0eDsKICAgIGdfY3VycmVudF9jdHggPSBkdW1teV9jdHg7CiAgICBmcHJpbnRmKHN0ZGVyciwgIltsaWJ2Z3B1LWN1ZGFdIGN1Q3R4Q3JlYXRlX3YyIFNVQ0NFU1MgKGR1bW15IGNvbnRleHQsIHRyYW5zcG9ydCBkZWZlcnJlZCk6IHBjdHg9JXBcbiIsICpwY3R4KTsKICAgIGZmbHVzaChzdGRlcnIpOwogICAgcmV0dXJuIENVREFfU1VDQ0VTUzsKfQoKQ1VyZXN1bHQgY3VDdHhDcmVhdGUoQ1Vjb250ZXh0ICpwY3R4LCB1bnNpZ25lZCBpbnQgZmxhZ3MsIENVZGV2aWNlIGRldikKewogICAgcmV0dXJuIGN1Q3R4Q3JlYXRlX3YyKHBjdHgsIGZsYWdzLCBkZXYpOwp9CgovKiBfdjMgdmVyc2lvbiBpcyBpZGVudGljYWwgdG8gX3YyICovCkNVcmVzdWx0IGN1Q3R4Q3JlYXRlX3YzKENVY29udGV4dCAqcGN0eCwgdW5zaWduZWQgaW50IGZsYWdzLCBDVWRldmljZSBkZXYsIHZvaWQgKnBhcmFtcykKewogICAgKHZvaWQpcGFyYW1zOyAgLyogdjMgYWRkcyBwYXJhbXMgYnV0IHdlIGlnbm9yZSBpdCAqLwogICAgcmV0dXJuIGN1Q3R4Q3JlYXRlX3YyKHBjdHgsIGZsYWdzLCBkZXYpOwp9CgpDVXJlc3VsdCBjdUN0eERlc3Ryb3lfdjIoQ1Vjb250ZXh0IGN0eCkKewogICAgQ1VyZXN1bHQgcmMgPSBlbnN1cmVfaW5pdCgpOwogICAgaWYgKHJjICE9IENVREFfU1VDQ0VTUykgcmV0dXJuIHJjOwoKICAgIENVREFDYWxsUmVzdWx0IHJlc3VsdDsKICAgIHVpbnQzMl90IGFyZ3NbMl07CiAgICBDVURBX1BBQ0tfVTY0KGFyZ3MsIDAsICh1aW50NjRfdCkodWludHB0cl90KWN0eCk7CgogICAgcmMgPSBycGNfc2ltcGxlKENVREFfQ0FMTF9DVFhfREVTVFJPWSwgYXJncywgMiwgJnJlc3VsdCk7CiAgICBpZiAocmMgPT0gQ1VEQV9TVUNDRVNTICYmIGdfY3VycmVudF9jdHggPT0gY3R4KSB7CiAgICAgICAgZ19jdXJyZW50X2N0eCA9IE5VTEw7CiAgICB9CiAgICByZXR1cm4gcmM7Cn0KCkNVcmVzdWx0IGN1Q3R4RGVzdHJveShDVWNvbnRleHQgY3R4KQp7CiAgICByZXR1cm4gY3VDdHhEZXN0cm95X3YyKGN0eCk7Cn0KCkNVcmVzdWx0IGN1Q3R4U2V0Q3VycmVudChDVWNvbnRleHQgY3R4KQp7CiAgICBmcHJpbnRmKHN0ZGVyciwgIltsaWJ2Z3B1LWN1ZGFdIENBTExFRDogY3VDdHhTZXRDdXJyZW50KGN0eD0lcClcbiIsIGN0eCk7CiAgICBmZmx1c2goc3RkZXJyKTsKICAgIENVcmVzdWx0IHJjID0gZW5zdXJlX2luaXQoKTsKICAgIGlmIChyYyAhPSBDVURBX1NVQ0NFU1MpIHsKICAgICAgICBmcHJpbnRmKHN0ZGVyciwgIltsaWJ2Z3B1LWN1ZGFdIGN1Q3R4U2V0Q3VycmVudCBlbnN1cmVfaW5pdCgpIGZhaWxlZDogJWRcbiIsIHJjKTsKICAgICAgICBmZmx1c2goc3RkZXJyKTsKICAgICAgICByZXR1cm4gcmM7CiAgICB9CgogICAgLyogVHJ5IFJQQyBjYWxsIGlmIHRyYW5zcG9ydCBpcyBjb25uZWN0ZWQsIGJ1dCBkb24ndCBmYWlsIGlmIGl0J3Mgbm90ICovCiAgICBDVXJlc3VsdCBycGNfcmMgPSBlbnN1cmVfY29ubmVjdGVkKCk7CiAgICBpZiAocnBjX3JjID09IENVREFfU1VDQ0VTUyAmJiBnX3RyYW5zcG9ydCkgewogICAgICAgIENVREFDYWxsUmVzdWx0IHJlc3VsdDsKICAgICAgICB1aW50MzJfdCBhcmdzWzJdOwogICAgICAgIENVREFfUEFDS19VNjQoYXJncywgMCwgKHVpbnQ2NF90KSh1aW50cHRyX3QpY3R4KTsKICAgICAgICByYyA9IHJwY19zaW1wbGUoQ1VEQV9DQUxMX0NUWF9TRVRfQ1VSUkVOVCwgYXJncywgMiwgJnJlc3VsdCk7CiAgICAgICAgaWYgKHJjID09IENVREFfU1VDQ0VTUykgewogICAgICAgICAgICBnX2N1cnJlbnRfY3R4ID0gY3R4OwogICAgICAgICAgICBmcHJpbnRmKHN0ZGVyciwgIltsaWJ2Z3B1LWN1ZGFdIGN1Q3R4U2V0Q3VycmVudCBTVUNDRVNTICh2aWEgUlBDKTogY3R4PSVwXG4iLCBjdHgpOwogICAgICAgICAgICBmZmx1c2goc3RkZXJyKTsKICAgICAgICAgICAgcmV0dXJuIENVREFfU1VDQ0VTUzsKICAgICAgICB9CiAgICB9CiAgICAKICAgIC8qIEZhbGxiYWNrOiBqdXN0IHNldCB0aGUgY29udGV4dCBsb2NhbGx5IHdpdGhvdXQgUlBDICovCiAgICBnX2N1cnJlbnRfY3R4ID0gY3R4OwogICAgZnByaW50ZihzdGRlcnIsICJbbGlidmdwdS1jdWRhXSBjdUN0eFNldEN1cnJlbnQgU1VDQ0VTUyAobG9jYWwsIHRyYW5zcG9ydCBkZWZlcnJlZCk6IGN0eD0lcFxuIiwgY3R4KTsKICAgIGZmbHVzaChzdGRlcnIpOwogICAgcmV0dXJuIENVREFfU1VDQ0VTUzsKfQoKQ1VyZXN1bHQgY3VDdHhHZXRDdXJyZW50KENVY29udGV4dCAqcGN0eCkKewogICAgaWYgKCFwY3R4KSByZXR1cm4gQ1VEQV9FUlJPUl9JTlZBTElEX1ZBTFVFOwogICAgKnBjdHggPSBnX2N1cnJlbnRfY3R4OwogICAgcmV0dXJuIENVREFfU1VDQ0VTUzsKfQoKLyogX3YyIHZlcnNpb24gaXMgaWRlbnRpY2FsICovCkNVcmVzdWx0IGN1Q3R4R2V0Q3VycmVudF92MihDVWNvbnRleHQgKnBjdHgpCnsKICAgIHJldHVybiBjdUN0eEdldEN1cnJlbnQocGN0eCk7Cn0KCkNVcmVzdWx0IGN1Q3R4UHVzaEN1cnJlbnRfdjIoQ1Vjb250ZXh0IGN0eCkKewogICAgcmV0dXJuIGN1Q3R4U2V0Q3VycmVudChjdHgpOwp9CgpDVXJlc3VsdCBjdUN0eFB1c2hDdXJyZW50KENVY29udGV4dCBjdHgpCnsKICAgIHJldHVybiBjdUN0eFB1c2hDdXJyZW50X3YyKGN0eCk7Cn0KCkNVcmVzdWx0IGN1Q3R4UG9wQ3VycmVudF92MihDVWNvbnRleHQgKnBjdHgpCnsKICAgIGlmIChwY3R4KSAqcGN0eCA9IGdfY3VycmVudF9jdHg7CiAgICByZXR1cm4gQ1VEQV9TVUNDRVNTOwp9CgpDVXJlc3VsdCBjdUN0eFBvcEN1cnJlbnQoQ1Vjb250ZXh0ICpwY3R4KQp7CiAgICByZXR1cm4gY3VDdHhQb3BDdXJyZW50X3YyKHBjdHgpOwp9CgpDVXJlc3VsdCBjdUN0eFN5bmNocm9uaXplKHZvaWQpCnsKICAgIENVcmVzdWx0IHJjID0gZW5zdXJlX2luaXQoKTsKICAgIGlmIChyYyAhPSBDVURBX1NVQ0NFU1MpIHJldHVybiByYzsKCiAgICBDVURBQ2FsbFJlc3VsdCByZXN1bHQ7CiAgICByZXR1cm4gcnBjX3NpbXBsZShDVURBX0NBTExfQ1RYX1NZTkNIUk9OSVpFLCBOVUxMLCAwLCAmcmVzdWx0KTsKfQoKQ1VyZXN1bHQgY3VDdHhHZXREZXZpY2UoQ1VkZXZpY2UgKmRldmljZSkKewogICAgZnByaW50ZihzdGRlcnIsICJbbGlidmdwdS1jdWRhXSBDQUxMRUQ6IGN1Q3R4R2V0RGV2aWNlKGRldmljZT0lcClcbiIsIGRldmljZSk7CiAgICBmZmx1c2goc3RkZXJyKTsKICAgIENVcmVzdWx0IHJjID0gZW5zdXJlX2luaXQoKTsKICAgIGlmIChyYyAhPSBDVURBX1NVQ0NFU1MpIHJldHVybiByYzsKICAgIGlmICghZGV2aWNlKSByZXR1cm4gQ1VEQV9FUlJPUl9JTlZBTElEX1ZBTFVFOwogICAgKmRldmljZSA9IDA7ICAvKiBBbHdheXMgZGV2aWNlIDAgKi8KICAgIGZwcmludGYoc3RkZXJyLCAiW2xpYnZncHUtY3VkYV0gY3VDdHhHZXREZXZpY2UgU1VDQ0VTUzogZGV2aWNlPTBcbiIpOwogICAgZmZsdXNoKHN0ZGVycik7CiAgICByZXR1cm4gQ1VEQV9TVUNDRVNTOwp9CgpDVXJlc3VsdCBjdUN0eEdldERldmljZV92MihDVWRldmljZSAqZGV2aWNlKQp7CiAgICByZXR1cm4gY3VDdHhHZXREZXZpY2UoZGV2aWNlKTsKfQoKLyogY3VDdHhHZXRBcGlWZXJzaW9uIGlzIGRlZmluZWQgbGF0ZXIgaW4gdGhlIGZpbGUgd2l0aCBiZXR0ZXIgbG9nZ2luZyAqLwoKLyogPT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PQogKiBDVURBIERyaXZlciBBUEkg4oCUIE1lbW9yeSBtYW5hZ2VtZW50IChmb3J3YXJkZWQgdG8gaG9zdCkKICogPT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PSAqLwoKQ1VyZXN1bHQgY3VNZW1BbGxvY192MihDVWRldmljZXB0ciAqZHB0ciwgc2l6ZV90IGJ5dGVzaXplKQp7CiAgICBDVXJlc3VsdCByYyA9IGVuc3VyZV9pbml0KCk7CiAgICBpZiAocmMgIT0gQ1VEQV9TVUNDRVNTKSByZXR1cm4gcmM7CiAgICBpZiAoIWRwdHIpIHJldHVybiBDVURBX0VSUk9SX0lOVkFMSURfVkFMVUU7CgogICAgQ1VEQUNhbGxSZXN1bHQgcmVzdWx0OwogICAgdWludDMyX3QgYXJnc1s0XTsKICAgIENVREFfUEFDS19VNjQoYXJncywgMCwgKHVpbnQ2NF90KWJ5dGVzaXplKTsKICAgIGFyZ3NbMl0gPSAwOyBhcmdzWzNdID0gMDsKCiAgICByYyA9IHJwY19zaW1wbGUoQ1VEQV9DQUxMX01FTV9BTExPQywgYXJncywgNCwgJnJlc3VsdCk7CiAgICBpZiAocmMgPT0gQ1VEQV9TVUNDRVNTKSB7CiAgICAgICAgKmRwdHIgPSAoQ1VkZXZpY2VwdHIpcmVzdWx0LnJlc3VsdHNbMF07CiAgICB9CiAgICByZXR1cm4gcmM7Cn0KCkNVcmVzdWx0IGN1TWVtQWxsb2MoQ1VkZXZpY2VwdHIgKmRwdHIsIHNpemVfdCBieXRlc2l6ZSkKewogICAgcmV0dXJuIGN1TWVtQWxsb2NfdjIoZHB0ciwgYnl0ZXNpemUpOwp9CgpDVXJlc3VsdCBjdU1lbUZyZWVfdjIoQ1VkZXZpY2VwdHIgZHB0cikKewogICAgQ1VyZXN1bHQgcmMgPSBlbnN1cmVfaW5pdCgpOwogICAgaWYgKHJjICE9IENVREFfU1VDQ0VTUykgcmV0dXJuIHJjOwoKICAgIENVREFDYWxsUmVzdWx0IHJlc3VsdDsKICAgIHVpbnQzMl90IGFyZ3NbMl07CiAgICBDVURBX1BBQ0tfVTY0KGFyZ3MsIDAsICh1aW50NjRfdClkcHRyKTsKCiAgICByZXR1cm4gcnBjX3NpbXBsZShDVURBX0NBTExfTUVNX0ZSRUUsIGFyZ3MsIDIsICZyZXN1bHQpOwp9CgpDVXJlc3VsdCBjdU1lbUZyZWUoQ1VkZXZpY2VwdHIgZHB0cikKewogICAgcmV0dXJuIGN1TWVtRnJlZV92MihkcHRyKTsKfQoKQ1VyZXN1bHQgY3VNZW1BbGxvY01hbmFnZWQoQ1VkZXZpY2VwdHIgKmRwdHIsIHNpemVfdCBieXRlc2l6ZSwgdW5zaWduZWQgaW50IGZsYWdzKQp7CiAgICBmcHJpbnRmKHN0ZGVyciwgIltsaWJ2Z3B1LWN1ZGFdIENBTExFRDogY3VNZW1BbGxvY01hbmFnZWQoZHB0cj0lcCwgYnl0ZXNpemU9JXp1LCBmbGFncz0weCV4KVxuIiwKICAgICAgICAgICAgZHB0ciwgYnl0ZXNpemUsIGZsYWdzKTsKICAgIAogICAgLyogRm9yIG5vdywgZGVsZWdhdGUgdG8gY3VNZW1BbGxvY192MiAtIG1hbmFnZWQgbWVtb3J5IGhhbmRsZWQgdGhlIHNhbWUgd2F5ICovCiAgICByZXR1cm4gY3VNZW1BbGxvY192MihkcHRyLCBieXRlc2l6ZSk7Cn0KCkNVcmVzdWx0IGN1TWVtQWxsb2NQaXRjaF92MihDVWRldmljZXB0ciAqZHB0ciwgc2l6ZV90ICpwaXRjaCwKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHNpemVfdCB3aWR0aEluQnl0ZXMsIHNpemVfdCBoZWlnaHQsIHVuc2lnbmVkIGludCBlbGVtZW50U2l6ZUJ5dGVzKQp7CiAgICBmcHJpbnRmKHN0ZGVyciwgIltsaWJ2Z3B1LWN1ZGFdIENBTExFRDogY3VNZW1BbGxvY1BpdGNoX3YyKGRwdHI9JXAsIHdpZHRoPSV6dSwgaGVpZ2h0PSV6dSwgZWxlbWVudFNpemU9JXUpXG4iLAogICAgICAgICAgICBkcHRyLCB3aWR0aEluQnl0ZXMsIGhlaWdodCwgZWxlbWVudFNpemVCeXRlcyk7CiAgICAKICAgIENVcmVzdWx0IHJjID0gZW5zdXJlX2luaXQoKTsKICAgIGlmIChyYyAhPSBDVURBX1NVQ0NFU1MpIHJldHVybiByYzsKICAgIGlmICghZHB0ciB8fCAhcGl0Y2gpIHJldHVybiBDVURBX0VSUk9SX0lOVkFMSURfVkFMVUU7CiAgICAKICAgIC8qIEFsbG9jYXRlIHVzaW5nIGN1TWVtQWxsb2NfdjIsIHRoZW4gc2V0IHBpdGNoIHRvIHdpZHRoIChubyBwYWRkaW5nIGZvciBub3cpICovCiAgICBzaXplX3QgdG90YWxTaXplID0gd2lkdGhJbkJ5dGVzICogaGVpZ2h0OwogICAgcmMgPSBjdU1lbUFsbG9jX3YyKGRwdHIsIHRvdGFsU2l6ZSk7CiAgICBpZiAocmMgPT0gQ1VEQV9TVUNDRVNTKSB7CiAgICAgICAgKnBpdGNoID0gd2lkdGhJbkJ5dGVzOwogICAgfQogICAgcmV0dXJuIHJjOwp9CgpDVXJlc3VsdCBjdU1lbUdldEFkZHJlc3NSYW5nZV92MihDVWRldmljZXB0ciAqYmFzZSwgc2l6ZV90ICpzaXplLCBDVWRldmljZXB0ciBkcHRyKQp7CiAgICBmcHJpbnRmKHN0ZGVyciwgIltsaWJ2Z3B1LWN1ZGFdIENBTExFRDogY3VNZW1HZXRBZGRyZXNzUmFuZ2VfdjIoYmFzZT0lcCwgc2l6ZT0lcCwgZHB0cj0weCVsbHgpXG4iLAogICAgICAgICAgICBiYXNlLCBzaXplLCAodW5zaWduZWQgbG9uZyBsb25nKWRwdHIpOwogICAgCiAgICBDVXJlc3VsdCByYyA9IGVuc3VyZV9pbml0KCk7CiAgICBpZiAocmMgIT0gQ1VEQV9TVUNDRVNTKSByZXR1cm4gcmM7CiAgICBpZiAoIWJhc2UgfHwgIXNpemUpIHJldHVybiBDVURBX0VSUk9SX0lOVkFMSURfVkFMVUU7CiAgICAKICAgIC8qIEZvciBub3csIHJldHVybiB0aGUgcG9pbnRlciBhcyBiYXNlIHdpdGggdW5rbm93biBzaXplICovCiAgICAqYmFzZSA9IGRwdHI7CiAgICAqc2l6ZSA9IDA7ICAvKiBTaXplIHVua25vd24gLSB3b3VsZCBuZWVkIHRvIHRyYWNrIGFsbG9jYXRpb25zICovCiAgICBmcHJpbnRmKHN0ZGVyciwgIltsaWJ2Z3B1LWN1ZGFdIGN1TWVtR2V0QWRkcmVzc1JhbmdlX3YyIHJldHVybmluZyBTVUNDRVNTIChiYXNlPTB4JWxseCwgc2l6ZT0wKVxuIiwKICAgICAgICAgICAgKHVuc2lnbmVkIGxvbmcgbG9uZykqYmFzZSk7CiAgICByZXR1cm4gQ1VEQV9TVUNDRVNTOwp9CgpDVXJlc3VsdCBjdU1lbUZyZWVIb3N0KHZvaWQgKnApCnsKICAgIGZwcmludGYoc3RkZXJyLCAiW2xpYnZncHUtY3VkYV0gQ0FMTEVEOiBjdU1lbUZyZWVIb3N0KHA9JXApXG4iLCBwKTsKICAgIAogICAgQ1VyZXN1bHQgcmMgPSBlbnN1cmVfaW5pdCgpOwogICAgaWYgKHJjICE9IENVREFfU1VDQ0VTUykgcmV0dXJuIHJjOwogICAgCiAgICAvKiBIb3N0IG1lbW9yeSBpcyBmcmVlZCB3aXRoIHN0YW5kYXJkIGZyZWUoKSAtIGFsd2F5cyBzdWNjZWVkICovCiAgICBpZiAocCkgewogICAgICAgIGZyZWUocCk7CiAgICB9CiAgICBmcHJpbnRmKHN0ZGVyciwgIltsaWJ2Z3B1LWN1ZGFdIGN1TWVtRnJlZUhvc3QgcmV0dXJuaW5nIFNVQ0NFU1NcbiIpOwogICAgcmV0dXJuIENVREFfU1VDQ0VTUzsKfQoKQ1VyZXN1bHQgY3VNZW1jcHlIdG9EX3YyKENVZGV2aWNlcHRyIGRzdERldmljZSwgY29uc3Qgdm9pZCAqc3JjSG9zdCwKICAgICAgICAgICAgICAgICAgICAgICAgICBzaXplX3QgYnl0ZUNvdW50KQp7CiAgICBDVXJlc3VsdCByYyA9IGVuc3VyZV9jb25uZWN0ZWQoKTsKICAgIGlmIChyYyAhPSBDVURBX1NVQ0NFU1MpIHJldHVybiByYzsKICAgIGlmICghc3JjSG9zdCAmJiBieXRlQ291bnQgPiAwKSByZXR1cm4gQ1VEQV9FUlJPUl9JTlZBTElEX1ZBTFVFOwoKICAgIENVREFDYWxsUmVzdWx0IHJlc3VsdDsKICAgIHVpbnQzMl90IGFyZ3NbNF07CiAgICBDVURBX1BBQ0tfVTY0KGFyZ3MsIDAsICh1aW50NjRfdClkc3REZXZpY2UpOwogICAgQ1VEQV9QQUNLX1U2NChhcmdzLCAyLCAodWludDY0X3QpYnl0ZUNvdW50KTsKCiAgICByZXR1cm4gKENVcmVzdWx0KWN1ZGFfdHJhbnNwb3J0X2NhbGwoZ190cmFuc3BvcnQsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIENVREFfQ0FMTF9NRU1DUFlfSFRPRCwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgYXJncywgNCwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgc3JjSG9zdCwgKHVpbnQzMl90KWJ5dGVDb3VudCwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgJnJlc3VsdCwgTlVMTCwgMCwgTlVMTCk7Cn0KCkNVcmVzdWx0IGN1TWVtY3B5SHRvRChDVWRldmljZXB0ciBkc3REZXZpY2UsIGNvbnN0IHZvaWQgKnNyY0hvc3QsCiAgICAgICAgICAgICAgICAgICAgICAgc2l6ZV90IGJ5dGVDb3VudCkKewogICAgcmV0dXJuIGN1TWVtY3B5SHRvRF92Mihkc3REZXZpY2UsIHNyY0hvc3QsIGJ5dGVDb3VudCk7Cn0KCkNVcmVzdWx0IGN1TWVtY3B5RHRvSF92Mih2b2lkICpkc3RIb3N0LCBDVWRldmljZXB0ciBzcmNEZXZpY2UsCiAgICAgICAgICAgICAgICAgICAgICAgICAgc2l6ZV90IGJ5dGVDb3VudCkKewogICAgQ1VyZXN1bHQgcmMgPSBlbnN1cmVfY29ubmVjdGVkKCk7CiAgICBpZiAocmMgIT0gQ1VEQV9TVUNDRVNTKSByZXR1cm4gcmM7CiAgICBpZiAoIWRzdEhvc3QgJiYgYnl0ZUNvdW50ID4gMCkgcmV0dXJuIENVREFfRVJST1JfSU5WQUxJRF9WQUxVRTsKCiAgICBDVURBQ2FsbFJlc3VsdCByZXN1bHQ7CiAgICB1aW50MzJfdCBhcmdzWzRdOwogICAgdWludDMyX3QgcmVjdl9sZW4gPSAwOwogICAgQ1VEQV9QQUNLX1U2NChhcmdzLCAwLCAodWludDY0X3Qpc3JjRGV2aWNlKTsKICAgIENVREFfUEFDS19VNjQoYXJncywgMiwgKHVpbnQ2NF90KWJ5dGVDb3VudCk7CgogICAgcmV0dXJuIChDVXJlc3VsdCljdWRhX3RyYW5zcG9ydF9jYWxsKGdfdHJhbnNwb3J0LAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBDVURBX0NBTExfTUVNQ1BZX0RUT0gsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGFyZ3MsIDQsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIE5VTEwsIDAsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICZyZXN1bHQsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGRzdEhvc3QsICh1aW50MzJfdClieXRlQ291bnQsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICZyZWN2X2xlbik7Cn0KCkNVcmVzdWx0IGN1TWVtY3B5RHRvSCh2b2lkICpkc3RIb3N0LCBDVWRldmljZXB0ciBzcmNEZXZpY2UsCiAgICAgICAgICAgICAgICAgICAgICAgc2l6ZV90IGJ5dGVDb3VudCkKewogICAgcmV0dXJuIGN1TWVtY3B5RHRvSF92Mihkc3RIb3N0LCBzcmNEZXZpY2UsIGJ5dGVDb3VudCk7Cn0KCkNVcmVzdWx0IGN1TWVtY3B5RHRvRF92MihDVWRldmljZXB0ciBkc3REZXZpY2UsIENVZGV2aWNlcHRyIHNyY0RldmljZSwKICAgICAgICAgICAgICAgICAgICAgICAgICBzaXplX3QgYnl0ZUNvdW50KQp7CiAgICBDVXJlc3VsdCByYyA9IGVuc3VyZV9pbml0KCk7CiAgICBpZiAocmMgIT0gQ1VEQV9TVUNDRVNTKSByZXR1cm4gcmM7CgogICAgQ1VEQUNhbGxSZXN1bHQgcmVzdWx0OwogICAgdWludDMyX3QgYXJnc1s2XTsKICAgIENVREFfUEFDS19VNjQoYXJncywgMCwgKHVpbnQ2NF90KWRzdERldmljZSk7CiAgICBDVURBX1BBQ0tfVTY0KGFyZ3MsIDIsICh1aW50NjRfdClzcmNEZXZpY2UpOwogICAgQ1VEQV9QQUNLX1U2NChhcmdzLCA0LCAodWludDY0X3QpYnl0ZUNvdW50KTsKCiAgICByZXR1cm4gcnBjX3NpbXBsZShDVURBX0NBTExfTUVNQ1BZX0RUT0QsIGFyZ3MsIDYsICZyZXN1bHQpOwp9CgpDVXJlc3VsdCBjdU1lbWNweUR0b0QoQ1VkZXZpY2VwdHIgZHN0RGV2aWNlLCBDVWRldmljZXB0ciBzcmNEZXZpY2UsCiAgICAgICAgICAgICAgICAgICAgICAgc2l6ZV90IGJ5dGVDb3VudCkKewogICAgcmV0dXJuIGN1TWVtY3B5RHRvRF92Mihkc3REZXZpY2UsIHNyY0RldmljZSwgYnl0ZUNvdW50KTsKfQoKQ1VyZXN1bHQgY3VNZW1zZXREOF92MihDVWRldmljZXB0ciBkc3REZXZpY2UsIHVuc2lnbmVkIGNoYXIgdWMsIHNpemVfdCBOKQp7CiAgICBDVXJlc3VsdCByYyA9IGVuc3VyZV9pbml0KCk7CiAgICBpZiAocmMgIT0gQ1VEQV9TVUNDRVNTKSByZXR1cm4gcmM7CgogICAgQ1VEQUNhbGxSZXN1bHQgcmVzdWx0OwogICAgdWludDMyX3QgYXJnc1s2XTsKICAgIENVREFfUEFDS19VNjQoYXJncywgMCwgKHVpbnQ2NF90KWRzdERldmljZSk7CiAgICBhcmdzWzJdID0gKHVpbnQzMl90KXVjOwogICAgYXJnc1szXSA9IDA7CiAgICBDVURBX1BBQ0tfVTY0KGFyZ3MsIDQsICh1aW50NjRfdClOKTsKCiAgICByZXR1cm4gcnBjX3NpbXBsZShDVURBX0NBTExfTUVNU0VUX0Q4LCBhcmdzLCA2LCAmcmVzdWx0KTsKfQoKQ1VyZXN1bHQgY3VNZW1zZXREOChDVWRldmljZXB0ciBkc3REZXZpY2UsIHVuc2lnbmVkIGNoYXIgdWMsIHNpemVfdCBOKQp7CiAgICByZXR1cm4gY3VNZW1zZXREOF92Mihkc3REZXZpY2UsIHVjLCBOKTsKfQoKQ1VyZXN1bHQgY3VNZW1zZXREMzJfdjIoQ1VkZXZpY2VwdHIgZHN0RGV2aWNlLCB1bnNpZ25lZCBpbnQgdWksIHNpemVfdCBOKQp7CiAgICBDVXJlc3VsdCByYyA9IGVuc3VyZV9pbml0KCk7CiAgICBpZiAocmMgIT0gQ1VEQV9TVUNDRVNTKSByZXR1cm4gcmM7CgogICAgQ1VEQUNhbGxSZXN1bHQgcmVzdWx0OwogICAgdWludDMyX3QgYXJnc1s2XTsKICAgIENVREFfUEFDS19VNjQoYXJncywgMCwgKHVpbnQ2NF90KWRzdERldmljZSk7CiAgICBhcmdzWzJdID0gdWk7CiAgICBhcmdzWzNdID0gMDsKICAgIENVREFfUEFDS19VNjQoYXJncywgNCwgKHVpbnQ2NF90KU4pOwoKICAgIHJldHVybiBycGNfc2ltcGxlKENVREFfQ0FMTF9NRU1TRVRfRDMyLCBhcmdzLCA2LCAmcmVzdWx0KTsKfQoKQ1VyZXN1bHQgY3VNZW1zZXREMzIoQ1VkZXZpY2VwdHIgZHN0RGV2aWNlLCB1bnNpZ25lZCBpbnQgdWksIHNpemVfdCBOKQp7CiAgICByZXR1cm4gY3VNZW1zZXREMzJfdjIoZHN0RGV2aWNlLCB1aSwgTik7Cn0KCkNVcmVzdWx0IGN1TWVtR2V0SW5mb192MihzaXplX3QgKmZyZWUsIHNpemVfdCAqdG90YWwpCnsKICAgIENVcmVzdWx0IHJjID0gZW5zdXJlX2luaXQoKTsKICAgIGlmIChyYyAhPSBDVURBX1NVQ0NFU1MpIHJldHVybiByYzsKICAgIGlmICghZnJlZSB8fCAhdG90YWwpIHJldHVybiBDVURBX0VSUk9SX0lOVkFMSURfVkFMVUU7CgogICAgQ1VEQUNhbGxSZXN1bHQgcmVzdWx0OwogICAgcmMgPSBycGNfc2ltcGxlKENVREFfQ0FMTF9NRU1fR0VUX0lORk8sIE5VTEwsIDAsICZyZXN1bHQpOwogICAgaWYgKHJjID09IENVREFfU1VDQ0VTUykgewogICAgICAgICpmcmVlICA9IChzaXplX3QpcmVzdWx0LnJlc3VsdHNbMF07CiAgICAgICAgKnRvdGFsID0gKHNpemVfdClyZXN1bHQucmVzdWx0c1sxXTsKICAgIH0gZWxzZSB7CiAgICAgICAgLyogRmFsbGJhY2sgKi8KICAgICAgICAqZnJlZSAgPSAoc2l6ZV90KWdfZ3B1X2luZm8uZnJlZV9tZW07CiAgICAgICAgKnRvdGFsID0gKHNpemVfdClnX2dwdV9pbmZvLnRvdGFsX21lbTsKICAgIH0KICAgIHJldHVybiBDVURBX1NVQ0NFU1M7Cn0KCkNVcmVzdWx0IGN1TWVtR2V0SW5mbyhzaXplX3QgKmZyZWUsIHNpemVfdCAqdG90YWwpCnsKICAgIHJldHVybiBjdU1lbUdldEluZm9fdjIoZnJlZSwgdG90YWwpOwp9CgovKiBBc3luYyBtZW1vcnkgY29weSB2YXJpYW50cyAqLwpDVXJlc3VsdCBjdU1lbWNweUh0b0RBc3luY192MihDVWRldmljZXB0ciBkc3REZXZpY2UsIGNvbnN0IHZvaWQgKnNyY0hvc3QsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBzaXplX3QgYnl0ZUNvdW50LCBDVXN0cmVhbSBoU3RyZWFtKQp7CiAgICAvKiBGb3Igc2ltcGxpY2l0eSwgYXN5bmMgPSBzeW5jIGZvciBub3cgKi8KICAgICh2
b2lkKWhTdHJlYW07CiAgICByZXR1cm4gY3VNZW1jcHlIdG9EX3YyKGRzdERldmljZSwgc3JjSG9zdCwgYnl0ZUNvdW50KTsKfQoKQ1VyZXN1bHQgY3VNZW1jcHlIdG9EQXN5bmMoQ1VkZXZpY2VwdHIgZHN0RGV2aWNlLCBjb25zdCB2b2lkICpzcmNIb3N0LAogICAgICAgICAgICAgICAgICAgICAgICAgICAgc2l6ZV90IGJ5dGVDb3VudCwgQ1VzdHJlYW0gaFN0cmVhbSkKewogICAgcmV0dXJuIGN1TWVtY3B5SHRvREFzeW5jX3YyKGRzdERldmljZSwgc3JjSG9zdCwgYnl0ZUNvdW50LCBoU3RyZWFtKTsKfQoKQ1VyZXN1bHQgY3VNZW1jcHlEdG9IQXN5bmNfdjIodm9pZCAqZHN0SG9zdCwgQ1VkZXZpY2VwdHIgc3JjRGV2aWNlLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgc2l6ZV90IGJ5dGVDb3VudCwgQ1VzdHJlYW0gaFN0cmVhbSkKewogICAgKHZvaWQpaFN0cmVhbTsKICAgIHJldHVybiBjdU1lbWNweUR0b0hfdjIoZHN0SG9zdCwgc3JjRGV2aWNlLCBieXRlQ291bnQpOwp9CgpDVXJlc3VsdCBjdU1lbWNweUR0b0hBc3luYyh2b2lkICpkc3RIb3N0LCBDVWRldmljZXB0ciBzcmNEZXZpY2UsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBzaXplX3QgYnl0ZUNvdW50LCBDVXN0cmVhbSBoU3RyZWFtKQp7CiAgICByZXR1cm4gY3VNZW1jcHlEdG9IQXN5bmNfdjIoZHN0SG9zdCwgc3JjRGV2aWNlLCBieXRlQ291bnQsIGhTdHJlYW0pOwp9CgovKiA9PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09CiAqIENVREEgRHJpdmVyIEFQSSDigJQgTW9kdWxlIC8gZnVuY3Rpb24gbWFuYWdlbWVudAogKiA9PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09ICovCgpDVXJlc3VsdCBjdU1vZHVsZUxvYWREYXRhKENVbW9kdWxlICptb2R1bGUsIGNvbnN0IHZvaWQgKmltYWdlKQp7CiAgICBDVXJlc3VsdCByYyA9IGVuc3VyZV9jb25uZWN0ZWQoKTsKICAgIGlmIChyYyAhPSBDVURBX1NVQ0NFU1MpIHJldHVybiByYzsKICAgIGlmICghbW9kdWxlIHx8ICFpbWFnZSkgcmV0dXJuIENVREFfRVJST1JfSU5WQUxJRF9WQUxVRTsKCiAgICAvKiBEZXRlcm1pbmUgaW1hZ2Ugc2l6ZSAoUFRYIGlzIG51bGwtdGVybWluYXRlZCwgQ1VCSU4gaGFzIEVMRiBoZWFkZXIpICovCiAgICBzaXplX3QgaW1hZ2Vfc2l6ZTsKICAgIGlmICgoKGNvbnN0IGNoYXIgKilpbWFnZSlbMF0gPT0gMHg3ZikgewogICAgICAgIC8qIEVMRiBiaW5hcnkg4oCUIHJlYWQgc2l6ZSBmcm9tIEVMRiBoZWFkZXIgKHNpbXBsaWZpZWQpICovCiAgICAgICAgLyogRm9yIG5vdywgYXNzdW1lIG1heCAxNiBNQiAqLwogICAgICAgIGltYWdlX3NpemUgPSAxNiAqIDEwMjQgKiAxMDI0OyAgLyogV2lsbCBiZSByZWZpbmVkICovCiAgICB9IGVsc2UgewogICAgICAgIC8qIFBUWCB0ZXh0IOKAlCBudWxsLXRlcm1pbmF0ZWQgKi8KICAgICAgICBpbWFnZV9zaXplID0gc3RybGVuKChjb25zdCBjaGFyICopaW1hZ2UpICsgMTsKICAgIH0KCiAgICBDVURBQ2FsbFJlc3VsdCByZXN1bHQ7CiAgICB1aW50MzJfdCByZWN2X2xlbiA9IDA7CgogICAgcmMgPSAoQ1VyZXN1bHQpY3VkYV90cmFuc3BvcnRfY2FsbChnX3RyYW5zcG9ydCwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIENVREFfQ0FMTF9NT0RVTEVfTE9BRF9EQVRBLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgTlVMTCwgMCwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGltYWdlLCAodWludDMyX3QpaW1hZ2Vfc2l6ZSwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICZyZXN1bHQsIE5VTEwsIDAsICZyZWN2X2xlbik7CiAgICBpZiAocmMgPT0gQ1VEQV9TVUNDRVNTKSB7CiAgICAgICAgKm1vZHVsZSA9IChDVW1vZHVsZSkodWludHB0cl90KXJlc3VsdC5yZXN1bHRzWzBdOwogICAgfQogICAgcmV0dXJuIHJjOwp9CgpDVXJlc3VsdCBjdU1vZHVsZUxvYWREYXRhRXgoQ1Vtb2R1bGUgKm1vZHVsZSwgY29uc3Qgdm9pZCAqaW1hZ2UsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdW5zaWduZWQgaW50IG51bU9wdGlvbnMsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdm9pZCAqb3B0aW9ucywgdm9pZCAqKm9wdGlvblZhbHVlcykKewogICAgLyogSWdub3JlIEpJVCBvcHRpb25zIGZvciBub3cgKi8KICAgICh2b2lkKW51bU9wdGlvbnM7ICh2b2lkKW9wdGlvbnM7ICh2b2lkKW9wdGlvblZhbHVlczsKICAgIHJldHVybiBjdU1vZHVsZUxvYWREYXRhKG1vZHVsZSwgaW1hZ2UpOwp9CgpDVXJlc3VsdCBjdU1vZHVsZUxvYWRGYXRCaW5hcnkoQ1Vtb2R1bGUgKm1vZHVsZSwgY29uc3Qgdm9pZCAqZmF0Q3ViaW4pCnsKICAgIHJldHVybiBjdU1vZHVsZUxvYWREYXRhKG1vZHVsZSwgZmF0Q3ViaW4pOwp9CgpDVXJlc3VsdCBjdU1vZHVsZVVubG9hZChDVW1vZHVsZSBobW9kKQp7CiAgICBDVXJlc3VsdCByYyA9IGVuc3VyZV9pbml0KCk7CiAgICBpZiAocmMgIT0gQ1VEQV9TVUNDRVNTKSByZXR1cm4gcmM7CgogICAgQ1VEQUNhbGxSZXN1bHQgcmVzdWx0OwogICAgdWludDMyX3QgYXJnc1syXTsKICAgIENVREFfUEFDS19VNjQoYXJncywgMCwgKHVpbnQ2NF90KSh1aW50cHRyX3QpaG1vZCk7CgogICAgcmV0dXJuIHJwY19zaW1wbGUoQ1VEQV9DQUxMX01PRFVMRV9VTkxPQUQsIGFyZ3MsIDIsICZyZXN1bHQpOwp9CgpDVXJlc3VsdCBjdU1vZHVsZUdldEZ1bmN0aW9uKENVZnVuY3Rpb24gKmhmdW5jLCBDVW1vZHVsZSBobW9kLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICBjb25zdCBjaGFyICpuYW1lKQp7CiAgICBDVXJlc3VsdCByYyA9IGVuc3VyZV9jb25uZWN0ZWQoKTsKICAgIGlmIChyYyAhPSBDVURBX1NVQ0NFU1MpIHJldHVybiByYzsKICAgIGlmICghaGZ1bmMgfHwgIW5hbWUpIHJldHVybiBDVURBX0VSUk9SX0lOVkFMSURfVkFMVUU7CgogICAgQ1VEQUNhbGxSZXN1bHQgcmVzdWx0OwogICAgdWludDMyX3QgYXJnc1syXTsKICAgIENVREFfUEFDS19VNjQoYXJncywgMCwgKHVpbnQ2NF90KSh1aW50cHRyX3QpaG1vZCk7CgogICAgLyogU2VuZCBmdW5jdGlvbiBuYW1lIGFzIGRhdGEgcGF5bG9hZCAqLwogICAgc2l6ZV90IG5hbWVfbGVuID0gc3RybGVuKG5hbWUpICsgMTsKICAgIHVpbnQzMl90IHJlY3ZfbGVuID0gMDsKCiAgICByYyA9IChDVXJlc3VsdCljdWRhX3RyYW5zcG9ydF9jYWxsKGdfdHJhbnNwb3J0LAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgQ1VEQV9DQUxMX01PRFVMRV9HRVRfRlVOQ1RJT04sCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBhcmdzLCAyLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgbmFtZSwgKHVpbnQzMl90KW5hbWVfbGVuLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgJnJlc3VsdCwgTlVMTCwgMCwgJnJlY3ZfbGVuKTsKICAgIGlmIChyYyA9PSBDVURBX1NVQ0NFU1MpIHsKICAgICAgICAqaGZ1bmMgPSAoQ1VmdW5jdGlvbikodWludHB0cl90KXJlc3VsdC5yZXN1bHRzWzBdOwogICAgfQogICAgcmV0dXJuIHJjOwp9CgpDVXJlc3VsdCBjdU1vZHVsZUdldEdsb2JhbF92MihDVWRldmljZXB0ciAqZHB0ciwgc2l6ZV90ICpieXRlcywKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIENVbW9kdWxlIGhtb2QsIGNvbnN0IGNoYXIgKm5hbWUpCnsKICAgIENVcmVzdWx0IHJjID0gZW5zdXJlX2Nvbm5lY3RlZCgpOwogICAgaWYgKHJjICE9IENVREFfU1VDQ0VTUykgcmV0dXJuIHJjOwogICAgaWYgKCFkcHRyIHx8ICFuYW1lKSByZXR1cm4gQ1VEQV9FUlJPUl9JTlZBTElEX1ZBTFVFOwoKICAgIENVREFDYWxsUmVzdWx0IHJlc3VsdDsKICAgIHVpbnQzMl90IGFyZ3NbMl07CiAgICBDVURBX1BBQ0tfVTY0KGFyZ3MsIDAsICh1aW50NjRfdCkodWludHB0cl90KWhtb2QpOwoKICAgIHNpemVfdCBuYW1lX2xlbiA9IHN0cmxlbihuYW1lKSArIDE7CiAgICB1aW50MzJfdCByZWN2X2xlbiA9IDA7CgogICAgcmMgPSAoQ1VyZXN1bHQpY3VkYV90cmFuc3BvcnRfY2FsbChnX3RyYW5zcG9ydCwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIENVREFfQ0FMTF9NT0RVTEVfR0VUX0dMT0JBTCwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGFyZ3MsIDIsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBuYW1lLCAodWludDMyX3QpbmFtZV9sZW4sCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAmcmVzdWx0LCBOVUxMLCAwLCAmcmVjdl9sZW4pOwogICAgaWYgKHJjID09IENVREFfU1VDQ0VTUykgewogICAgICAgICpkcHRyID0gKENVZGV2aWNlcHRyKXJlc3VsdC5yZXN1bHRzWzBdOwogICAgICAgIGlmIChieXRlcykgKmJ5dGVzID0gKHNpemVfdClyZXN1bHQucmVzdWx0c1sxXTsKICAgIH0KICAgIHJldHVybiByYzsKfQoKQ1VyZXN1bHQgY3VNb2R1bGVHZXRHbG9iYWwoQ1VkZXZpY2VwdHIgKmRwdHIsIHNpemVfdCAqYnl0ZXMsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBDVW1vZHVsZSBobW9kLCBjb25zdCBjaGFyICpuYW1lKQp7CiAgICByZXR1cm4gY3VNb2R1bGVHZXRHbG9iYWxfdjIoZHB0ciwgYnl0ZXMsIGhtb2QsIG5hbWUpOwp9CgovKiA9PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09CiAqIENVREEgRHJpdmVyIEFQSSDigJQgS2VybmVsIGxhdW5jaAogKiA9PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09ICovCgpDVXJlc3VsdCBjdUxhdW5jaEtlcm5lbChDVWZ1bmN0aW9uIGYsCiAgICAgICAgICAgICAgICAgICAgICAgICB1bnNpZ25lZCBpbnQgZ3JpZERpbVgsIHVuc2lnbmVkIGludCBncmlkRGltWSwKICAgICAgICAgICAgICAgICAgICAgICAgIHVuc2lnbmVkIGludCBncmlkRGltWiwKICAgICAgICAgICAgICAgICAgICAgICAgIHVuc2lnbmVkIGludCBibG9ja0RpbVgsIHVuc2lnbmVkIGludCBibG9ja0RpbVksCiAgICAgICAgICAgICAgICAgICAgICAgICB1bnNpZ25lZCBpbnQgYmxvY2tEaW1aLAogICAgICAgICAgICAgICAgICAgICAgICAgdW5zaWduZWQgaW50IHNoYXJlZE1lbUJ5dGVzLAogICAgICAgICAgICAgICAgICAgICAgICAgQ1VzdHJlYW0gaFN0cmVhbSwKICAgICAgICAgICAgICAgICAgICAgICAgIHZvaWQgKiprZXJuZWxQYXJhbXMsCiAgICAgICAgICAgICAgICAgICAgICAgICB2b2lkICoqZXh0cmEpCnsKICAgIENVcmVzdWx0IHJjID0gZW5zdXJlX2Nvbm5lY3RlZCgpOwogICAgaWYgKHJjICE9IENVREFfU1VDQ0VTUykgcmV0dXJuIHJjOwoKICAgICh2b2lkKWV4dHJhOyAgLyogZXh0cmEgbm90IHN1cHBvcnRlZCB5ZXQgKi8KCiAgICAvKgogICAgICogU2VyaWFsaXplIGxhdW5jaCBwYXJhbWV0ZXJzLgogICAgICogV2UgdXNlIHRoZSBDVURBTGF1bmNoUGFyYW1zIHN0cnVjdHVyZSBmb2xsb3dlZCBieSBwYXJhbWV0ZXIgZGF0YS4KICAgICAqCiAgICAgKiBTaW5jZSB3ZSBjYW4ndCBrbm93IHRoZSBpbmRpdmlkdWFsIHBhcmFtIHNpemVzIGZyb20gdm9pZCoqIGFsb25lLAogICAgICogd2UgcmVseSBvbiB0aGUgaG9zdCBoYXZpbmcgbWV0YWRhdGEgZnJvbSBjdU1vZHVsZUdldEZ1bmN0aW9uLgogICAgICogRm9yIG5vdywgd2Ugc2VuZCBrZXJuZWxQYXJhbXMgYXMgYW4gYXJyYXkgb2YgOC1ieXRlIHBvaW50ZXJzLgogICAgICovCiAgICBDVURBTGF1bmNoUGFyYW1zIGxwOwogICAgbWVtc2V0KCZscCwgMCwgc2l6ZW9mKGxwKSk7CiAgICBscC5mdW5jdGlvbl9oYW5kbGUgPSAodWludDY0X3QpKHVpbnRwdHJfdClmOwogICAgbHAuZ3JpZF9kaW1feCAgID0gZ3JpZERpbVg7CiAgICBscC5ncmlkX2RpbV95ICAgPSBncmlkRGltWTsKICAgIGxwLmdyaWRfZGltX3ogICA9IGdyaWREaW1aOwogICAgbHAuYmxvY2tfZGltX3ggID0gYmxvY2tEaW1YOwogICAgbHAuYmxvY2tfZGltX3kgID0gYmxvY2tEaW1ZOwogICAgbHAuYmxvY2tfZGltX3ogID0gYmxvY2tEaW1aOwogICAgbHAuc2hhcmVkX21lbV9ieXRlcyA9IHNoYXJlZE1lbUJ5dGVzOwogICAgbHAuc3RyZWFtX2hhbmRsZSA9ICh1aW50NjRfdCkodWludHB0cl90KWhTdHJlYW07CiAgICBscC5udW1fcGFyYW1zID0gMDsKICAgIGxwLnRvdGFsX3BhcmFtX2J5dGVzID0gMDsKCiAgICAvKiBDb3VudCBrZXJuZWwgcGFyYW1ldGVycyAoTlVMTC10ZXJtaW5hdGVkIGFycmF5KSAqLwogICAgaWYgKGtlcm5lbFBhcmFtcykgewogICAgICAgIHdoaWxlIChrZXJuZWxQYXJhbXNbbHAubnVtX3BhcmFtc10gIT0gTlVMTCAmJiBscC5udW1fcGFyYW1zIDwgMjU2KSB7CiAgICAgICAgICAgIGxwLm51bV9wYXJhbXMrKzsKICAgICAgICB9CiAgICB9CgogICAgLyoKICAgICAqIEJ1aWxkIHBheWxvYWQ6IENVREFMYXVuY2hQYXJhbXMgKyBwb2ludGVyIHZhbHVlcwogICAgICogRWFjaCBrZXJuZWwgcGFyYW0gaXMgdHJlYXRlZCBhcyBhbiA4LWJ5dGUgdmFsdWUgKGRldmljZSBwb2ludGVyIHNpemUpLgogICAgICovCiAgICBscC50b3RhbF9wYXJhbV9ieXRlcyA9IGxwLm51bV9wYXJhbXMgKiA4OwoKICAgIHNpemVfdCBwYXlsb2FkX3NpemUgPSBzaXplb2YoQ1VEQUxhdW5jaFBhcmFtcykKICAgICAgICAgICAgICAgICAgICAgICAgICsgbHAubnVtX3BhcmFtcyAqIHNpemVvZih1aW50MzJfdCkgIC8qIHBhcmFtX3NpemVzICovCiAgICAgICAgICAgICAgICAgICAgICAgICArIGxwLnRvdGFsX3BhcmFtX2J5dGVzOyAgICAgICAgICAgICAvKiBwYXJhbV9kYXRhICAqLwoKICAgIHVpbnQ4X3QgKnBheWxvYWQgPSAodWludDhfdCAqKW1hbGxvYyhwYXlsb2FkX3NpemUpOwogICAgaWYgKCFwYXlsb2FkKSByZXR1cm4gQ1VEQV9FUlJPUl9PVVRfT0ZfTUVNT1JZOwoKICAgIC8qIENvcHkgbGF1bmNoIHBhcmFtcyAqLwogICAgbWVtY3B5KHBheWxvYWQsICZscCwgc2l6ZW9mKENVREFMYXVuY2hQYXJhbXMpKTsKCiAgICAvKiBXcml0ZSBwYXJhbV9zaXplcyAoZWFjaCBpcyA4IGJ5dGVzKSAqLwogICAgdWludDMyX3QgKnNpemVzID0gKHVpbnQzMl90ICopKHBheWxvYWQgKyBzaXplb2YoQ1VEQUxhdW5jaFBhcmFtcykpOwogICAgZm9yICh1aW50MzJfdCBpID0gMDsgaSA8IGxwLm51bV9wYXJhbXM7IGkrKykgewogICAgICAgIHNpemVzW2ldID0gODsgIC8qIGVhY2ggcGFyYW0gaXMgOCBieXRlcyAqLwogICAgfQoKICAgIC8qIFdyaXRlIHBhcmFtIGRhdGEgKHJhdyA4LWJ5dGUgY29waWVzIG9mIGVhY2ggcGFyYW0pICovCiAgICB1aW50OF90ICpwZGF0YSA9ICh1aW50OF90ICopKHNpemVzICsgbHAubnVtX3BhcmFtcyk7CiAgICBmb3IgKHVpbnQzMl90IGkgPSAwOyBpIDwgbHAubnVtX3BhcmFtczsgaSsrKSB7CiAgICAgICAgbWVtY3B5KHBkYXRhICsgaSAqIDgsIGtlcm5lbFBhcmFtc1tpXSwgOCk7CiAgICB9CgogICAgQ1VEQUNhbGxSZXN1bHQgcmVzdWx0OwogICAgcmMgPSAoQ1VyZXN1bHQpY3VkYV90cmFuc3BvcnRfY2FsbChnX3RyYW5zcG9ydCwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIENVREFfQ0FMTF9MQVVOQ0hfS0VSTkVMLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgTlVMTCwgMCwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHBheWxvYWQsICh1aW50MzJfdClwYXlsb2FkX3NpemUsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAmcmVzdWx0LCBOVUxMLCAwLCBOVUxMKTsKCiAgICBmcmVlKHBheWxvYWQpOwogICAgcmV0dXJuIHJjOwp9CgovKiA9PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09CiAqIENVREEgRHJpdmVyIEFQSSDigJQgU3RyZWFtIG1hbmFnZW1lbnQKICogPT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PSAqLwoKQ1VyZXN1bHQgY3VTdHJlYW1DcmVhdGUoQ1VzdHJlYW0gKnBoU3RyZWFtLCB1bnNpZ25lZCBpbnQgZmxhZ3MpCnsKICAgIENVcmVzdWx0IHJjID0gZW5zdXJlX2luaXQoKTsKICAgIGlmIChyYyAhPSBDVURBX1NVQ0NFU1MpIHJldHVybiByYzsKICAgIGlmICghcGhTdHJlYW0pIHJldHVybiBDVURBX0VSUk9SX0lOVkFMSURfVkFMVUU7CgogICAgQ1VEQUNhbGxSZXN1bHQgcmVzdWx0OwogICAgdWludDMyX3QgYXJnc1syXSA9IHsgZmxhZ3MsIDAgfTsKCiAgICByYyA9IHJwY19zaW1wbGUoQ1VEQV9DQUxMX1NUUkVBTV9DUkVBVEVfV0lUSF9GTEFHUywgYXJncywgMiwgJnJlc3VsdCk7CiAgICBpZiAocmMgPT0gQ1VEQV9TVUNDRVNTKSB7CiAgICAgICAgKnBoU3RyZWFtID0gKENVc3RyZWFtKSh1aW50cHRyX3QpcmVzdWx0LnJlc3VsdHNbMF07CiAgICB9CiAgICByZXR1cm4gcmM7Cn0KCkNVcmVzdWx0IGN1U3RyZWFtQ3JlYXRlV2l0aEZsYWdzKENVc3RyZWFtICpwaFN0cmVhbSwgdW5zaWduZWQgaW50IGZsYWdzKQp7CiAgICByZXR1cm4gY3VTdHJlYW1DcmVhdGUocGhTdHJlYW0sIGZsYWdzKTsKfQoKQ1VyZXN1bHQgY3VTdHJlYW1DcmVhdGVXaXRoUHJpb3JpdHkoQ1VzdHJlYW0gKnBoU3RyZWFtLCB1bnNpZ25lZCBpbnQgZmxhZ3MsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBpbnQgcHJpb3JpdHkpCnsKICAgIENVcmVzdWx0IHJjID0gZW5zdXJlX2luaXQoKTsKICAgIGlmIChyYyAhPSBDVURBX1NVQ0NFU1MpIHJldHVybiByYzsKICAgIGlmICghcGhTdHJlYW0pIHJldHVybiBDVURBX0VSUk9SX0lOVkFMSURfVkFMVUU7CgogICAgQ1VEQUNhbGxSZXN1bHQgcmVzdWx0OwogICAgdWludDMyX3QgYXJnc1s0XSA9IHsgZmxhZ3MsIDAsICh1aW50MzJfdClwcmlvcml0eSwgMCB9OwoKICAgIHJjID0gcnBjX3NpbXBsZShDVURBX0NBTExfU1RSRUFNX0NSRUFURV9XSVRIX1BSSU9SSVRZLCBhcmdzLCA0LCAmcmVzdWx0KTsKICAgIGlmIChyYyA9PSBDVURBX1NVQ0NFU1MpIHsKICAgICAgICAqcGhTdHJlYW0gPSAoQ1VzdHJlYW0pKHVpbnRwdHJfdClyZXN1bHQucmVzdWx0c1swXTsKICAgIH0KICAgIHJldHVybiByYzsKfQoKQ1VyZXN1bHQgY3VTdHJlYW1EZXN0cm95X3YyKENVc3RyZWFtIGhTdHJlYW0pCnsKICAgIENVcmVzdWx0IHJjID0gZW5zdXJlX2luaXQoKTsKICAgIGlmIChyYyAhPSBDVURBX1NVQ0NFU1MpIHJldHVybiByYzsKCiAgICBDVURBQ2FsbFJlc3VsdCByZXN1bHQ7CiAgICB1aW50MzJfdCBhcmdzWzJdOwogICAgQ1VEQV9QQUNLX1U2NChhcmdzLCAwLCAodWludDY0X3QpKHVpbnRwdHJfdCloU3RyZWFtKTsKCiAgICByZXR1cm4gcnBjX3NpbXBsZShDVURBX0NBTExfU1RSRUFNX0RFU1RST1ksIGFyZ3MsIDIsICZyZXN1bHQpOwp9CgpDVXJlc3VsdCBjdVN0cmVhbURlc3Ryb3koQ1VzdHJlYW0gaFN0cmVhbSkKewogICAgcmV0dXJuIGN1U3RyZWFtRGVzdHJveV92MihoU3RyZWFtKTsKfQoKQ1VyZXN1bHQgY3VTdHJlYW1TeW5jaHJvbml6ZShDVXN0cmVhbSBoU3RyZWFtKQp7CiAgICBDVXJlc3VsdCByYyA9IGVuc3VyZV9pbml0KCk7CiAgICBpZiAocmMgIT0gQ1VEQV9TVUNDRVNTKSByZXR1cm4gcmM7CgogICAgQ1VEQUNhbGxSZXN1bHQgcmVzdWx0OwogICAgdWludDMyX3QgYXJnc1syXTsKICAgIENVREFfUEFDS19VNjQoYXJncywgMCwgKHVpbnQ2NF90KSh1aW50cHRyX3QpaFN0cmVhbSk7CgogICAgcmV0dXJuIHJwY19zaW1wbGUoQ1VEQV9DQUxMX1NUUkVBTV9TWU5DSFJPTklaRSwgYXJncywgMiwgJnJlc3VsdCk7Cn0KCkNVcmVzdWx0IGN1U3RyZWFtUXVlcnkoQ1VzdHJlYW0gaFN0cmVhbSkKewogICAgQ1VyZXN1bHQgcmMgPSBlbnN1cmVfaW5pdCgpOwogICAgaWYgKHJjICE9IENVREFfU1VDQ0VTUykgcmV0dXJuIHJjOwoKICAgIENVREFDYWxsUmVzdWx0IHJlc3VsdDsKICAgIHVpbnQzMl90IGFyZ3NbMl07CiAgICBDVURBX1BBQ0tfVTY0KGFyZ3MsIDAsICh1aW50NjRfdCkodWludHB0cl90KWhTdHJlYW0pOwoKICAgIHJldHVybiBycGNfc2ltcGxlKENVREFfQ0FMTF9TVFJFQU1fUVVFUlksIGFyZ3MsIDIsICZyZXN1bHQpOwp9CgpDVXJlc3VsdCBjdVN0cmVhbVdhaXRFdmVudChDVXN0cmVhbSBoU3RyZWFtLCBDVWV2ZW50IGhFdmVudCwKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHVuc2lnbmVkIGludCBmbGFncykKewogICAgQ1VyZXN1bHQgcmMgPSBlbnN1cmVfaW5pdCgpOwogICAgaWYgKHJjICE9IENVREFfU1VDQ0VTUykgcmV0dXJuIHJjOwoKICAgIENVREFDYWxsUmVzdWx0IHJlc3VsdDsKICAgIHVpbnQzMl90IGFyZ3NbNl07CiAgICBDVURBX1BBQ0tfVTY0KGFyZ3MsIDAsICh1aW50NjRfdCkodWludHB0cl90KWhTdHJlYW0pOwogICAgQ1VEQV9QQUNLX1U2NChhcmdzLCAyLCAodWludDY0X3QpKHVpbnRwdHJfdCloRXZlbnQpOwogICAgYXJnc1s0XSA9IGZsYWdzOwogICAgYXJnc1s1XSA9IDA7CgogICAgcmV0dXJuIHJwY19zaW1wbGUoQ1VEQV9DQUxMX1NUUkVBTV9XQUlUX0VWRU5ULCBhcmdzLCA2LCAmcmVzdWx0KTsKfQoKLyogPT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PQogKiBDVURBIERyaXZlciBBUEkg4oCUIEV2ZW50IG1hbmFnZW1lbnQKICogPT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PSAqLwoKQ1VyZXN1bHQgY3VFdmVudENyZWF0ZShDVWV2ZW50ICpwaEV2ZW50LCB1bnNpZ25lZCBpbnQgZmxhZ3MpCnsKICAgIENVcmVzdWx0IHJjID0gZW5zdXJlX2luaXQoKTsKICAgIGlmIChyYyAhPSBDVURBX1NVQ0NFU1MpIHJldHVybiByYzsKICAgIGlmICghcGhFdmVudCkgcmV0dXJuIENVREFfRVJST1JfSU5WQUxJRF9WQUxVRTsKCiAgICBDVURBQ2FsbFJlc3VsdCByZXN1bHQ7CiAgICB1aW50MzJfdCBhcmdzWzJdID0geyBmbGFncywgMCB9OwoKICAgIHJjID0gcnBjX3NpbXBsZShDVURBX0NBTExfRVZFTlRfQ1JFQVRFX1dJVEhfRkxBR1MsIGFyZ3MsIDIsICZyZXN1bHQpOwogICAgaWYgKHJjID09IENVREFfU1VDQ0VTUykgewogICAgICAgICpwaEV2ZW50ID0gKENVZXZlbnQpKHVpbnRwdHJfdClyZXN1bHQucmVzdWx0c1swXTsKICAgIH0KICAgIHJldHVybiByYzsKfQoKQ1VyZXN1bHQgY3VFdmVudERlc3Ryb3lfdjIoQ1VldmVudCBoRXZlbnQpCnsKICAgIENVcmVzdWx0IHJjID0gZW5zdXJlX2luaXQoKTsKICAgIGlmIChyYyAhPSBDVURBX1NVQ0NFU1MpIHJldHVybiByYzsKCiAgICBDVURBQ2FsbFJlc3VsdCByZXN1bHQ7CiAgICB1aW50MzJfdCBhcmdzWzJdOwogICAgQ1VEQV9QQUNLX1U2NChhcmdzLCAwLCAodWludDY0X3QpKHVpbnRwdHJfdCloRXZlbnQpOwoKICAgIHJldHVybiBycGNfc2ltcGxlKENVREFfQ0FMTF9FVkVOVF9ERVNUUk9ZLCBhcmdzLCAyLCAmcmVzdWx0KTsKfQoKQ1VyZXN1bHQgY3VFdmVudERlc3Ryb3koQ1VldmVudCBoRXZlbnQpCnsKICAgIHJldHVybiBjdUV2ZW50RGVzdHJveV92MihoRXZlbnQpOwp9CgpDVXJlc3VsdCBjdUV2ZW50UmVjb3JkKENVZXZlbnQgaEV2ZW50LCBDVXN0cmVhbSBoU3RyZWFtKQp7CiAgICBDVXJlc3VsdCByYyA9IGVuc3VyZV9pbml0KCk7CiAgICBpZiAocmMgIT0gQ1VEQV9TVUNDRVNTKSByZXR1cm4gcmM7CgogICAgQ1VEQUNhbGxSZXN1bHQgcmVzdWx0OwogICAgdWludDMyX3QgYXJnc1s0XTsKICAgIENVREFfUEFDS19VNjQoYXJncywgMCwgKHVpbnQ2NF90KSh1aW50cHRyX3QpaEV2ZW50KTsKICAgIENVREFfUEFDS19VNjQoYXJncywgMiwgKHVpbnQ2NF90KSh1aW50cHRyX3QpaFN0cmVhbSk7CgogICAgcmV0dXJuIHJwY19zaW1wbGUoQ1VEQV9DQUxMX0VWRU5UX1JFQ09SRCwgYXJncywgNCwgJnJlc3VsdCk7Cn0KCkNVcmVzdWx0IGN1RXZlbnRTeW5jaHJvbml6ZShDVWV2ZW50IGhFdmVudCkKewogICAgQ1VyZXN1bHQgcmMgPSBlbnN1cmVfaW5pdCgpOwogICAgaWYgKHJjICE9IENVREFfU1VDQ0VTUykgcmV0dXJuIHJjOwoKICAgIENVREFDYWxsUmVzdWx0IHJlc3VsdDsKICAgIHVpbnQzMl90IGFyZ3NbMl07CiAgICBDVURBX1BBQ0tfVTY0KGFyZ3MsIDAsICh1aW50NjRfdCkodWludHB0cl90KWhFdmVudCk7CgogICAgcmV0dXJuIHJwY19zaW1wbGUoQ1VEQV9DQUxMX0VWRU5UX1NZTkNIUk9OSVpFLCBhcmdzLCAyLCAmcmVzdWx0KTsKfQoKQ1VyZXN1bHQgY3VFdmVudFF1ZXJ5KENVZXZlbnQgaEV2ZW50KQp7CiAgICBDVXJlc3VsdCByYyA9IGVuc3VyZV9pbml0KCk7CiAgICBpZiAocmMgIT0gQ1VEQV9TVUNDRVNTKSByZXR1cm4gcmM7CgogICAgQ1VEQUNhbGxSZXN1bHQgcmVzdWx0OwogICAgdWludDMyX3QgYXJnc1syXTsKICAgIENVREFfUEFDS19VNjQoYXJncywgMCwgKHVpbnQ2NF90KSh1aW50cHRyX3QpaEV2ZW50KTsKCiAgICByZXR1cm4gcnBjX3NpbXBsZShDVURBX0NBTExfRVZFTlRfUVVFUlksIGFyZ3MsIDIsICZyZXN1bHQpOwp9CgpDVXJlc3VsdCBjdUV2ZW50RWxhcHNlZFRpbWUoZmxvYXQgKnBNaWxsaXNlY29uZHMsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgQ1VldmVudCBoU3RhcnQsIENVZXZlbnQgaEVuZCkKewogICAgQ1VyZXN1bHQgcmMgPSBlbnN1cmVfaW5pdCgpOwogICAgaWYgKHJjICE9IENVREFfU1VDQ0VTUykgcmV0dXJuIHJjOwogICAgaWYgKCFwTWlsbGlzZWNvbmRzKSByZXR1cm4gQ1VEQV9FUlJPUl9JTlZBTElEX1ZBTFVFOwoKICAgIENVREFDYWxsUmVzdWx0IHJlc3VsdDsKICAgIHVpbnQzMl90IGFyZ3NbNF07CiAgICBDVURBX1BBQ0tfVTY0KGFyZ3MsIDAsICh1aW50NjRfdCkodWludHB0cl90KWhTdGFydCk7CiAgICBDVURBX1BBQ0tfVTY0KGFyZ3MsIDIsICh1aW50NjRfdCkodWludHB0cl90KWhFbmQpOwoKICAgIHJjID0gcnBjX3NpbXBsZShDVURBX0NBTExfRVZFTlRfRUxBUFNFRF9USU1FLCBhcmdzLCA0LCAmcmVzdWx0KTsKICAgIGlmIChyYyA9PSBDVURBX1NVQ0NFU1MpIHsKICAgICAgICAvKiBSZXN1bHQgcGFja2VkIGFzIHVpbnQzMiBiaXRzIG9mIGZsb2F0ICovCiAgICAgICAgdWludDMyX3QgZmJpdHMgPSAodWludDMyX3QpcmVzdWx0LnJlc3VsdHNbMF07CiAgICAgICAgbWVtY3B5KHBNaWxsaXNlY29uZHMsICZmYml0cywgc2l6ZW9mKGZsb2F0KSk7CiAgICB9CiAgICByZXR1cm4gcmM7Cn0KCi8qID09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT0KICogQ1VEQSBEcml2ZXIgQVBJIOKAlCBPY2N1cGFuY3kgKGxvY2FsIGNvbXB1dGF0aW9uKQogKiA9PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09ICovCgpDVXJlc3VsdCBjdU9jY3VwYW5jeU1heEFjdGl2ZUJsb2Nrc1Blck11bHRpcHJvY2Vzc29yKGludCAqbnVtQmxvY2tzLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBDVWZ1bmN0aW9uIGZ1bmMsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGludCBibG9ja1NpemUsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHNpemVfdCBkeW5TaGFyZWRNZW0pCnsKICAgIENVcmVzdWx0IHJjID0gZW5zdXJlX2luaXQoKTsKICAgIGlmIChyYyAhPSBDVURBX1NVQ0NFU1MpIHJldHVybiByYzsKICAgIGlmICghbnVtQmxvY2tzKSByZXR1cm4gQ1VEQV9FUlJPUl9JTlZBTElEX1ZBTFVFOwoKICAgIC8qIFNpbXBsZSBoZXVyaXN0aWM6IG1heF90aHJlYWRzX3Blcl9zbSAvIGJsb2NrU2l6ZSAqLwogICAgaW50IG1heF90ID0gZ19ncHVfaW5mby5tYXhfdGhyZWFkc19wZXJfbXA7CiAgICBpZiAobWF4X3QgPD0gMCkgbWF4X3QgPSBHUFVfREVGQVVMVF9NQVhfVEhSRUFEU19QRVJfU007CiAgICBpZiAoYmxvY2tTaXplIDw9IDApIGJsb2NrU2l6ZSA9IDE7CgogICAgKm51bUJsb2NrcyA9IG1heF90IC8gYmxvY2tTaXplOwogICAgaWYgKCpudW1CbG9ja3MgPCAxKSAqbnVtQmxvY2tzID0gMTsKCiAgICAodm9pZClmdW5jOyAodm9pZClkeW5TaGFyZWRNZW07CiAgICByZXR1cm4gQ1VEQV9TVUNDRVNTOwp9CgpDVXJlc3VsdCBjdU9jY3VwYW5jeU1heFBvdGVudGlhbEJsb2NrU2l6ZShpbnQgKm1pbkdyaWRTaXplLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgaW50ICpibG9ja1NpemUsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBDVWZ1bmN0aW9uIGZ1bmMsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB2b2lkICpibG9ja1NpemVUb0R5blNNZW1TaXplLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgc2l6ZV90IGR5blNNZW1TaXplLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgaW50IGJsb2NrU2l6ZUxpbWl0KQp7CiAgICBDVXJlc3VsdCByYyA9IGVuc3VyZV9pbml0KCk7CiAgICBpZiAocmMgIT0gQ1VEQV9TVUNDRVNTKSByZXR1cm4gcmM7CiAgICBpZiAoIW1pbkdyaWRTaXplIHx8ICFibG9ja1NpemUpIHJldHVybiBDVURBX0VSUk9SX0lOVkFMSURfVkFMVUU7CgogICAgKmJsb2NrU2l6ZSA9IDI1NjsgIC8qIENvbW1vbiBkZWZhdWx0ICovCiAgICAqbWluR3JpZFNpemUgPSBnX2dwdV9pbmZvLm11bHRpX3Byb2Nlc3Nvcl9jb3VudCAqIDQ7CiAgICBpZiAoKm1pbkdyaWRTaXplIDw9IDApICptaW5HcmlkU2l6ZSA9IEdQVV9ERUZBVUxUX1NNX0NPVU5UICogNDsKCiAgICAodm9pZClmdW5jOyAodm9pZClibG9ja1NpemVUb0R5blNNZW1TaXplOwogICAgKHZvaWQpZHluU01lbVNpemU7ICh2b2lkKWJsb2NrU2l6ZUxpbWl0OwogICAgcmV0dXJuIENVREFfU1VDQ0VTUzsKfQoKLyogPT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PQogKiBDVURBIERyaXZlciBBUEkg4oCUIEZ1bmN0aW9uIGF0dHJpYnV0ZXMKICogPT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PSAqLwoKQ1VyZXN1bHQgY3VGdW5jR2V0QXR0cmlidXRlKGludCAqcGksIGludCBhdHRyaWIsIENVZnVuY3Rpb24gaGZ1bmMpCnsKICAgIENVcmVzdWx0IHJjID0gZW5zdXJlX2luaXQoKTsKICAgIGlmIChyYyAhPSBDVURBX1NVQ0NFU1MpIHJldHVybiByYzsKICAgIGlmICghcGkpIHJldHVybiBDVURBX0VSUk9SX0lOVkFMSURfVkFMVUU7CgogICAgQ1VEQUNhbGxSZXN1bHQgcmVzdWx0OwogICAgdWludDMyX3QgYXJnc1s0XTsKICAgIGFyZ3NbMF0gPSAodWludDMyX3QpYXR0cmliOwogICAgYXJnc1sxXSA9IDA7CiAgICBDVURBX1BBQ0tfVTY0KGFyZ3MsIDIsICh1aW50NjRfdCkodWludHB0cl90KWhmdW5jKTsKCiAgICByYyA9IHJwY19zaW1wbGUoQ1VEQV9DQUxMX0ZVTkNfR0VUX0FUVFJJQlVURSwgYXJncywgNCwgJnJlc3VsdCk7CiAgICBpZiAocmMgPT0gQ1VEQV9TVUNDRVNTKSB7CiAgICAgICAgKnBpID0gKGludClyZXN1bHQucmVzdWx0c1swXTsKICAgIH0KICAgIHJldHVybiByYzsKfQoKQ1VyZXN1bHQgY3VGdW5jU2V0Q2FjaGVDb25maWcoQ1VmdW5jdGlvbiBoZnVuYywgaW50IGNvbmZpZykKewogICAgQ1VyZXN1bHQgcmMgPSBlbnN1cmVfaW5pdCgpOwogICAgaWYgKHJjICE9IENVREFfU1VDQ0VTUykgcmV0dXJuIHJjOwoKICAgIENVREFDYWxsUmVzdWx0IHJlc3VsdDsKICAgIHVpbnQzMl90IGFyZ3NbNF07CiAgICBDVURBX1BBQ0tfVTY0KGFyZ3MsIDAsICh1aW50NjRfdCkodWludHB0cl90KWhmdW5jKTsKICAgIGFyZ3NbMl0gPSAodWludDMyX3QpY29uZmlnOwogICAgYXJnc1szXSA9IDA7CgogICAgcmV0dXJuIHJwY19zaW1wbGUoQ1VEQV9DQUxMX0ZVTkNfU0VUX0NBQ0hFX0NPTkZJRywgYXJncywgNCwgJnJlc3VsdCk7Cn0KCi8qID09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT0KICogQ1VEQSBEcml2ZXIgQVBJIOKAlCBFcnJvciBoYW5kbGluZwogKiA9PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09ICovCgpDVXJlc3VsdCBjdUdldEVycm9yU3RyaW5nKENVcmVzdWx0IGVycm9yLCBjb25zdCBjaGFyICoqcFN0cikKewogICAgaWYgKCFwU3RyKSByZXR1cm4gQ1VEQV9FUlJPUl9JTlZBTElEX1ZBTFVFOwogICAgc3RhdGljIGNvbnN0IGNoYXIgKmVycl9zdHIgPSAiQ1VEQSBlcnJvciI7CiAgICBzdGF0aWMgY29uc3QgY2hhciAqb2tfc3RyICA9ICJubyBlcnJvciI7CiAgICAqcFN0ciA9IChlcnJvciA9PSBDVURBX1NVQ0NFU1MpID8gb2tfc3RyIDogZXJyX3N0cjsKICAgIHJldHVybiBDVURBX1NVQ0NFU1M7Cn0KCkNVcmVzdWx0IGN1R2V0RXJyb3JOYW1lKENVcmVzdWx0IGVycm9yLCBjb25zdCBjaGFyICoqcFN0cikKewogICAgaWYgKCFwU3RyKSByZXR1cm4gQ1VEQV9FUlJPUl9JTlZBTElEX1ZBTFVFOwogICAgc3RhdGljIGNvbnN0IGNoYXIgKmVycl9uYW1lICAgID0gIkNVREFfRVJST1IiOwogICAgc3RhdGljIGNvbnN0IGNoYXIgKm9rX25hbWUgICAgID0gIkNVREFfU1VDQ0VTUyI7CiAgICAqcFN0ciA9IChlcnJvciA9PSBDVURBX1NVQ0NFU1MpID8gb2tfbmFtZSA6IGVycl9uYW1lOwogICAgcmV0dXJuIENVREFfU1VDQ0VTUzsKfQoKLyogPT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PQogKiBDVURBIERyaXZlciBBUEkg4oCUIERldmljZSBQMlAgKHN0dWIg4oCUIHNpbmdsZSBkZXZpY2UpCiAqID09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT0gKi8KCkNVcmVzdWx0IGN1RGV2aWNlQ2FuQWNjZXNzUGVlcihpbnQgKmNhbkFjY2Vzc1BlZXIsIENVZGV2aWNlIGRldiwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBDVWRldmljZSBwZWVyRGV2KQp7CiAgICBpZiAoIWNhbkFjY2Vzc1BlZXIpIHJldHVybiBDVURBX0VSUk9SX0lOVkFMSURfVkFMVUU7CiAgICAqY2FuQWNjZXNzUGVlciA9IDA7CiAgICAodm9pZClkZXY7ICh2b2lkKXBlZXJEZXY7CiAgICByZXR1cm4gQ1VEQV9TVUNDRVNTOwp9CgpDVXJlc3VsdCBjdURldmljZUdldFAyUEF0dHJpYnV0ZShpbnQgKnZhbHVlLCBpbnQgYXR0cmliLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgQ1VkZXZpY2Ugc3JjRGV2aWNlLCBDVWRldmljZSBkc3REZXZpY2UpCnsKICAgIGlmICghdmFsdWUpIHJldHVybiBDVURBX0VSUk9SX0lOVkFMSURfVkFMVUU7CiAgICAqdmFsdWUgPSAwOwogICAgKHZvaWQpYXR0cmliOyAodm9pZClzcmNEZXZpY2U7ICh2b2lkKWRzdERldmljZTsKICAgIHJldHVybiBDVURBX1NVQ0NFU1M7Cn0KCi8qID09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT0KICogQ2F0Y2gtYWxsIGZvciBhbnkgQ1VEQSBmdW5jdGlvbnMgd2UgaGF2ZW4ndCBpbXBsZW1lbnRlZAogKiAKICogVGhpcyBlbnN1cmVzIHRoYXQgaWYgZ2dtbF9jdWRhX2luaXQgY2FsbHMgYSBmdW5jdGlvbiB3ZSBoYXZlbid0CiAqIGltcGxlbWVudGVkLCBpdCBnZXRzIGEgc3R1YiB0aGF0IHJldHVybnMgU1VDQ0VTUyByYXRoZXIgdGhhbgogKiBjYXVzaW5nIGEgc3ltYm9sIGxvb2t1cCBmYWlsdXJlIG9yIHJldHVybmluZyBOT1RfU1VQUE9SVEVELgogKiA9PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09ICovCgovKiBIZWxwZXIgbWFjcm8gdG8gY3JlYXRlIHN0dWIgZnVuY3Rpb25zICovCiNkZWZpbmUgQ1VEQV9TVFVCX0ZVTkMobmFtZSwgcmV0X3R5cGUsIC4uLikgXAogICAgcmV0X3R5cGUgbmFtZShfX1ZBX0FSR1NfXykgeyBcCiAgICAgICAgZnByaW50ZihzdGRlcnIsICJbbGlidmdwdS1jdWRhXSBTVFVCIENBTExFRDogJXMgKG5vdCBmdWxseSBpbXBsZW1lbnRlZCwgcmV0dXJuaW5nIFNVQ0NFU1MpXG4iLCAjbmFtZSk7IFwKICAgICAgICBmZmx1c2goc3RkZXJyKTsgXAogICAgICAgICh2b2lkKTA7IC8qIFN1cHByZXNzIHVudXNlZCBwYXJhbWV0ZXIgd2FybmluZ3MgKi8gXAogICAgICAgIHJldHVybiAocmV0X3R5cGUpQ1VEQV9TVUNDRVNTOyBcCiAgICB9CgovKiBDb21tb24gc3R1YiBmdW5jdGlvbnMgdGhhdCBtaWdodCBiZSBjYWxsZWQgZHVyaW5nIGluaXRpYWxpemF0aW9uICovCkNVcmVzdWx0IGN1Q3R4R2V0QXBpVmVyc2lvbihDVWNvbnRleHQgY3R4LCB1bnNpZ25lZCBpbnQgKnZlcnNpb24pCnsKICAgIGZwcmludGYoc3RkZXJyLCAiW2xpYnZncHUtY3VkYV0gQ0FMTEVEOiBjdUN0eEdldEFwaVZlcnNpb24oY3R4PSVwLCB2ZXJzaW9uPSVwKVxuIiwgY3R4LCB2ZXJzaW9uKTsKICAgIGZmbHVzaChzdGRlcnIpOwogICAgaWYgKHZlcnNpb24pICp2ZXJzaW9uID0gMTIwODA7IC8qIENVREEgMTIuOCAqLwogICAgcmV0dXJuIENVREFfU1VDQ0VTUzsKfQoKLyogY3VDdHhHZXREZXZpY2UgaXMgYWxyZWFkeSBkZWZpbmVkIGFib3ZlIChsaW5lIH4xODE4KSwgcmVtb3ZpbmcgZHVwbGljYXRlICovCgpDVXJlc3VsdCBjdUN0eEdldEZsYWdzKHVuc2lnbmVkIGludCAqZmxhZ3MpCnsKICAgIGZwcmludGYoc3RkZXJyLCAiW2xpYnZncHUtY3VkYV0gQ0FMTEVEOiBjdUN0eEdldEZsYWdzKGZsYWdzPSVwKVxuIiwgZmxhZ3MpOwogICAgZmZsdXNoKHN0ZGVycik7CiAgICBpZiAoZmxhZ3MpICpmbGFncyA9IDA7CiAgICByZXR1cm4gQ1VEQV9TVUNDRVNTOwp9CgpDVXJlc3VsdCBjdUN0eFNldExpbWl0KGludCBsaW1pdCwgc2l6ZV90IHZhbHVlKQp7CiAgICBmcHJpbnRmKHN0ZGVyciwgIltsaWJ2Z3B1LWN1ZGFdIENBTExFRDogY3VDdHhTZXRMaW1pdChsaW1pdD0lZCwgdmFsdWU9JXp1KVxuIiwgbGltaXQsIHZhbHVlKTsKICAgIGZmbHVzaChzdGRlcnIpOwogICAgcmV0dXJuIENVREFfU1VDQ0VTUzsKfQoKQ1VyZXN1bHQgY3VDdHhHZXRMaW1pdChzaXplX3QgKnB2YWx1ZSwgaW50IGxpbWl0KQp7CiAgICBmcHJpbnRmKHN0ZGVyciwgIltsaWJ2Z3B1LWN1ZGFdIENBTExFRDogY3VDdHhHZXRMaW1pdChwdmFsdWU9JXAsIGxpbWl0PSVkKVxuIiwgcHZhbHVlLCBsaW1pdCk7CiAgICBmZmx1c2goc3RkZXJyKTsKICAgIGlmIChwdmFsdWUpICpwdmFsdWUgPSAwOwogICAgcmV0dXJuIENVREFfU1VDQ0VTUzsKfQoKLyogPT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PQogKiBWZXJzaW9uIHN5bWJvbCBhbGlhc2VzCiAqCiAqIE1hbnkgQ1VEQSBhcHBsaWNhdGlvbnMgbGluayBhZ2FpbnN0IHZlcnNpb25lZCBzeW1ib2xzCiAqIChlLmcuIGN1TWVtQWxsb2NfdjIpLiAgV2UgcHJvdmlkZSBib3RoIHZlcnNpb25zLgogKiA9PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09ICovCgovKiBUaGVzZSBhcmUgYWxyZWFkeSBwcm92aWRlZCBhcyBzZXBhcmF0ZSBmdW5jdGlvbnMgYWJvdmUgKi8K
ENDOFFILE'

# Decode and write
echo "Decoding and writing file..."
ssh -o StrictHostKeyChecking=no test-7@10.25.33.17 'base64 -d /tmp/libvgpu_cuda.c.b64 > ~/phase3/guest-shim/libvgpu_cuda.c && rm /tmp/libvgpu_cuda.c.b64'

# Verify
echo "Verifying file..."
ssh -o StrictHostKeyChecking=no test-7@10.25.33.17 'wc -l ~/phase3/guest-shim/libvgpu_cuda.c && ls -lh ~/phase3/guest-shim/libvgpu_cuda.c'

echo ""
echo " File copied successfully!"
